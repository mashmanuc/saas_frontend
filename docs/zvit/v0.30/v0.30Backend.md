# v0.30 Backend ‚Äî Solo Workspace: Contracts + Limits + Snapshot Report

**–í–µ—Ä—Å—ñ—è:** 0.30  
**–†–æ–ª—å:** Backend Developer  
**–î–∞—Ç–∞:** 17.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìã SUMMARY

–£ v0.30 –±–µ–∫–µ–Ω–¥ —Å—Ñ–æ–∫—É—Å–æ–≤–∞–Ω–∏–π –Ω–∞ —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤ Solo autosave: —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–∞—Ü—ñ—è payload-–ª—ñ–º—ñ—Ç—ñ–≤, middleware –¥–ª—è —Ä–∞–Ω–Ω—å–æ–≥–æ –≤—ñ–¥—Å—ñ–∫–∞–Ω–Ω—è –≤–µ–ª–∏–∫–∏—Ö —Ç—ñ–ª (–≤–∫–ª—é—á–Ω–æ –∑ gzip post-decompress), —á—ñ—Ç–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç optimistic locking (`If-Match` ‚Üí 412, fallback `X-Rev` ‚Üí 409), —É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω—ñ JSON-–ø–æ–º–∏–ª–∫–∏ –¥–ª—è 413/415/429 —Ç–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—è beacon —É telemetry-only —Ä–µ–∂–∏–º. –î–æ–¥–∞–Ω–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–∏–π pytest suite. Stretch: —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ Snapshot API (POST create + GET latest) –±–µ–∑ garbage collection.

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–Ü –ó–ê–í–î–ê–ù–ù–Ø (MUST)

### BE30-1: –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–∞—Ü—ñ—è –ª—ñ–º—ñ—Ç—ñ–≤
- –Ñ–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏: `apps/solo/limits.py`.
- –õ—ñ–º—ñ—Ç–∏:
  - Diff: 512 KiB
  - Stream: 2 MiB
  - Beacon: 64 KiB
  - Export: 10 MiB (–∑–±–µ—Ä–µ–∂–µ–Ω–æ –∑ v0.29)

### BE30-2: BodySizeLimitMiddleware (—Ç—ñ–ª—å–∫–∏ Solo)
- –ó–æ–Ω–∞ –¥—ñ—ó: —Ç—ñ–ª—å–∫–∏ Solo `diff/save-stream/beacon`.
- Fast-fail –ø–æ `Content-Length`.
- `Content-Encoding: gzip` ‚Äî –ø—ñ–¥—Ç—Ä–∏–º–∞–Ω–æ, –ª—ñ–º—ñ—Ç —Ä–∞—Ö—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—ñ—ó.
- `Content-Encoding: br` ‚Äî 415 `unsupported_media_type`.
- –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π 413 JSON:
  - `{"error":"payload_too_large","limit":<bytes>,"encoding":"raw|gzip","endpoint":"<path>","request_id":"<uuid>"}`

### BE30-3: –ö–æ–Ω—Ç—Ä–∞–∫—Ç ETag/Rev –¥–ª—è diff/save-stream
- `If-Match` **–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–π** –¥–ª—è:
  - `PATCH /diff/`
  - `POST /save-stream/`
- –ù–µ–º–∞ `If-Match` –∞–±–æ parsing error ‚Üí 412 `precondition_failed`.
- Mismatch `If-Match` ‚Üí 412 `precondition_failed`.
- Fallback `X-Rev` (—Ç–∏–º—á–∞—Å–æ–≤–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å) mismatch ‚Üí 409 `rev_mismatch` + `server_rev`.

### BE30-4: Beacon telemetry-only
- `POST /beacon/`:
  - –Ω–µ –∑–º—ñ–Ω—é—î `state`
  - –Ω–µ –∑–º—ñ–Ω—é—î `rev`
  - –Ω–µ —Ç—Ä–∏–≥–µ—Ä–∏—Ç—å snapshot/state upload
  - –ø–æ–≤–µ—Ä—Ç–∞—î `204 No Content` –Ω–∞ —É—Å–ø—ñ—Ö

### BE30-5: –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ñ pytest —Ç–µ—Å—Ç–∏
–î–æ–¥–∞–Ω–æ/–æ–Ω–æ–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–∏, —è–∫—ñ —Ñ—ñ–∫—Å—É—é—Ç—å –ø–æ–≤–µ–¥—ñ–Ω–∫—É:
- 413 raw / gzip post-decompress
- 415 –¥–ª—è `br`
- 412 –¥–ª—è `If-Match`
- 409 –¥–ª—è `X-Rev`
- 422 invalid_ops
- 429 rate_limited body + headers

---

## ‚úÖ STRETCH: Snapshot API (–±–µ–∑ GC)

### BE30-S1: Snapshot endpoints
- `POST /api/v1/solo/sessions/{id}/snapshot/`
  - —Å—Ç–≤–æ—Ä—é—î –≤–µ—Ä—Å—ñ–æ–Ω–æ–≤–∞–Ω–∏–π snapshot —É storage path: `solo/{user_id}/{session_id}/{rev}.json`
  - idempotency —á–µ—Ä–µ–∑ `Idempotency-Key` (TTL 60s)
  - –ø–æ–≤–µ—Ä—Ç–∞—î `201 {"rev": <rev>, "url": "<signed_url>"}`
- `GET /api/v1/solo/sessions/{id}/snapshot/latest/`
  - –ø–æ–≤–µ—Ä—Ç–∞—î `200 {"rev": <rev>, "url": "<signed_url>"}` —è–∫—â–æ snapshot —ñ—Å–Ω—É—î
  - –ø–æ–≤–µ—Ä—Ç–∞—î `404 {"error":"not_found"}` —è–∫—â–æ snapshot —â–µ –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞–≤—Å—è

---

## üìÅ –ù–û–í–Ü/–û–ù–û–í–õ–ï–ù–Ü –§–ê–ô–õ–ò

### –ù–æ–≤—ñ
- `apps/solo/limits.py`
- `apps/solo/tests/test_snapshot_api.py`

### –û–Ω–æ–≤–ª–µ–Ω—ñ
- `apps/solo/middleware.py` (BodySizeLimitMiddleware)
- `config/settings.py` (–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è middleware)
- `apps/solo/api/views.py` (–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏ diff/stream/beacon + Snapshot views)
- `apps/solo/api/mixins.py` (—É–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—è 429 body)
- `apps/solo/tests/test_diff_save.py`
- `apps/solo/tests/test_stream_save.py`
- `apps/solo/urls.py` (snapshot routes)

---

## üîó ENDPOINTS (v0.30)

| Method | Endpoint | Auth | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|----------|------|-------------|
| PATCH | `/api/v1/solo/sessions/{id}/diff/` | ‚úÖ | Incremental diff-save –∑ optimistic locking |
| POST | `/api/v1/solo/sessions/{id}/save-stream/` | ‚úÖ | Worker-friendly full state upload |
| POST | `/api/v1/solo/sessions/{id}/beacon/` | ‚úÖ | telemetry-only keepalive (sendBeacon) |
| POST | `/api/v1/solo/sessions/{id}/snapshot/` | ‚úÖ | create snapshot (versioned storage) |
| GET | `/api/v1/solo/sessions/{id}/snapshot/latest/` | ‚úÖ | latest snapshot signed URL |

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

```bash
# –ó–∞–ø—É—Å–∫ pytest —á–µ—Ä–µ–∑ venv
.venv\Scripts\python -m pytest -q

# –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ñ —Ç–µ—Å—Ç–∏ Solo
pytest apps/solo/tests/test_diff_save.py -q
pytest apps/solo/tests/test_stream_save.py -q
pytest apps/solo/tests/test_snapshot_api.py -q
```

---

## ‚úÖ DoD Checklist

- [x] –Ñ–¥–∏–Ω—ñ –ª—ñ–º—ñ—Ç–∏ —É `apps/solo/limits.py`
- [x] Middleware –∑ fast-fail + gzip post-decompress + 415 –¥–ª—è br
- [x] –ö–æ–Ω—Ç—Ä–∞–∫—Ç If-Match (412) + fallback X-Rev (409)
- [x] Beacon telemetry-only
- [x] –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω—ñ error bodies –¥–ª—è 413/415/429
- [x] Pytest suite —Ñ—ñ–∫—Å—É—î –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏
- [x] Snapshot API (POST+GET latest) –±–µ–∑ GC

---

*M4SH Platform v0.30 ‚Äî Backend –≥–æ—Ç–æ–≤–∏–π –¥–æ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ FE –ø–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º.*
