# v0.30 Frontend ‚Äî Solo Workspace: Implementation Report

**–í–µ—Ä—Å—ñ—è:** 0.30  
**–†–æ–ª—å:** Frontend Developer  
**–î–∞—Ç–∞:** 17.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Must-have –≤–∏–∫–æ–Ω–∞–Ω–æ (stretch ‚Äî –æ–ø—Ü—ñ–π–Ω–æ)

---

## üìã SUMMARY

–£ v0.30 —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å—Ñ–æ–∫—É—Å–æ–≤–∞–Ω–∏–π –Ω–∞:

- —Å—Ç–∞–±—ñ–ª—å–Ω–æ–º—É autosave (mutex/in-flight gate + retry 412/409 + UX-–ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è 413/422/429 + —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—è);
- –∫–µ—Ä–æ–≤–∞–Ω–æ–º—É AutoSave (Œ≤) toggle –∑ localStorage —ñ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º exit-beacon (telemetry-only);
- –ø–æ–≤–Ω–æ–º—É image upload pipeline –±–µ–∑ base64: paste/drag&drop ‚Üí ObjectURL preview ‚Üí client downscale ‚Üí presign ‚Üí PUT ‚Üí –∑–∞–º—ñ–Ω–∞ `asset.src` –Ω–∞ CDN URL;
- –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—ñ UX —ñ–Ω–≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ (Ctrl+Z –¥–ª—è drag/resize assets, —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è upload src swap –≤ undo history).

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–Ü –ó–ê–í–î–ê–ù–ù–Ø (MUST)

### FE30-1: Save-Coordinator (mutex + routing + retry)
- **–°–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è save-–∑–∞–ø–∏—Ç—ñ–≤** —á–µ—Ä–µ–∑ mutex/in-flight gate.
- **Routing**: diff-save vs stream-save (–≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ä–æ–∑–º—ñ—Ä—É payload, —ñ–∑ –∑–∞—Ö–∏—Å—Ç–æ–º –≤—ñ–¥ ‚Äú–∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–æ–≥–æ‚Äù diff).
- **Optimistic locking**:
  - 412 (`precondition_failed`) —Ç–∞ 409 (`rev_mismatch`) ‚Üí soft resync + **–æ–¥–∏–Ω retry** –∑ jitter.
  - –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ ‚Äú–ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ retry‚Äù (guard –ø–æ –µ—Ç–∞–≥/—Ä–µ–≤—ñ–∑—ñ—ó).
- **UX-–ø–æ–ª—ñ—Ç–∏–∫–∏ –ø–æ–º–∏–ª–æ–∫**:
  - 413 ‚Üí toast error ‚Äúpayload too large‚Äù.
  - 422 ‚Üí toast error ‚Äúinvalid ops / validation‚Äù.
  - 429 ‚Üí toast warning + backoff.
- **Telemetry**: –ø–æ–¥—ñ—ó –∑ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ `endpoint/status/backoff_ms/limit/request_id` (–¥–µ –¥–æ—Å—Ç—É–ø–Ω–æ).

### FE30-2: AutoSave toggle (Œ≤)
- –î–æ–¥–∞–Ω–æ **–ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** `autosaveEnabled`.
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ü—ñ—è –≤ `localStorage`.
- Idle/autosave **–Ω–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è**, —è–∫—â–æ toggle –≤–∏–º–∫–Ω–µ–Ω–∏–π (–∑–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ —Å—Ç–∞–≤–∏—Ç—å—Å—è pending —ñ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è debounce-–ª–æ–≥—ñ–∫–∞).
- **Exit beacon** –∑–∞–≤–∂–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è (telemetry-only), –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ toggle.

### FE30-3: Images upload pipeline (NO base64)
- –í—Å—Ç–∞–≤–∫–∞/–¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å **–±–µ–∑ base64 —É state**:
  - **Paste** ‚Üí `URL.createObjectURL(file)` —è–∫ preview.
  - **Drag & Drop** ‚Üí —Ç–µ —Å–∞–º–µ (preview + upload pipeline).
- **Client-side downscale**:
  - `maxSide = 1920`, —è–∫—ñ—Å—Ç—å `q ‚âà 0.82` (jpeg/webp); png –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è.
- **Presign –∫–æ–Ω—Ç—Ä–∞–∫—Ç**:
  - `POST /api/v1/solo/uploads/presign/` –∑ `{ session_id, content_type, size_bytes, ext }`.
- **Upload**:
  - `PUT` –Ω–∞ `upload_url` –∑ `Content-Type` —Ç–∞ presigned `headers`.
  - –ü—ñ—Å–ª—è 2xx ‚Üí `asset.src = cdn_url`.
- **–õ—ñ–º—ñ—Ç–∏**:
  - soft warn: >5MiB.
  - hard reject: >8MiB.
- **–ü–æ–º–∏–ª–∫–∏**:
  - 403 `quota_exceeded` ‚Üí toast error.
  - 413 `payload_too_large` ‚Üí toast error.
  - 415 `unsupported_media_type` ‚Üí toast error.
  - 429 ‚Üí backoff (Retry-After / X-Backoff-Ms) + **–æ–¥–∏–Ω retry**.
  - PUT fail ‚Üí toast error.

### FE30-4: Undo/Redo –¥–ª—è drag/resize asset
- `Ctrl+Z` –≤—ñ–¥–º—ñ–Ω—è—î `asset_update` (drag/transform).
- Upload src swap (blob ‚Üí CDN) **–Ω–µ** –ø–∏—à–µ—Ç—å—Å—è –≤ undo history (`skipHistory: true`), —â–æ–± `Ctrl+Z` –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞–≤ ‚Äú–º–µ—Ä—Ç–≤–∏–π blob:‚Äù.

---

## üìÅ –ù–û–í–Ü/–û–ù–û–í–õ–ï–ù–Ü –§–ê–ô–õ–ò (Frontend)

### –û–Ω–æ–≤–ª–µ–Ω—ñ
- `frontend/src/modules/classroom/board/state/saveCoordinator.ts`
  - mutex/in-flight gate, retry 412/409, UX mapping, telemetry.
- `frontend/src/modules/classroom/board/state/boardStore.ts`
  - AutoSave toggle;
  - `uploadImageAsset()` (downscale + presign + PUT + error handling);
  - `updateAsset(..., { skipHistory })`;
  - undo/redo –¥–ª—è `updateAsset`.
- `frontend/src/modules/solo/api/soloApi.ts`
  - `presignUpload()` + —Ç–∏–ø–∏.
- `frontend/src/modules/classroom/components/board/BoardCanvas.vue`
  - paste image preview –±–µ–∑ base64;
  - drag&drop images;
  - —Ç–∏–ø–æ–≤–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å `PerfHUD` stageRef.
- `frontend/src/modules/classroom/components/board/BoardDock.vue`
  - –ø—Ä–æ–∫–∏–¥–∞–Ω–Ω—è `asset-add` –∑ optional `File`.
- `frontend/src/modules/solo/views/SoloWorkspace.vue`
  - –ø—Ä–∏–π–æ–º `asset_add` + —Å—Ç–∞—Ä—Ç upload pipeline;
  - UI toggle AutoSave (Œ≤).
- `frontend/src/modules/classroom/views/SoloRoom.vue` (legacy)
  - paste handler –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∏–π –Ω–∞ ObjectURL + upload pipeline (–±–µ–∑ base64).

---

## üîó ENDPOINTS (v0.30) ‚Äî —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î FE

### Save
- `PATCH /api/v1/solo/sessions/{id}/diff/`
- `POST /api/v1/solo/sessions/{id}/save-stream/`
- `POST /api/v1/solo/sessions/{id}/beacon/` (telemetry-only)

### Upload
- `POST /api/v1/solo/uploads/presign/`
- `PUT <upload_url>` (presigned)

---

## ‚úÖ DoD Checklist (Frontend)

- [x] Save-Coordinator: —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è save + routing + retry 412/409
- [x] UX-–ø–æ–ª—ñ—Ç–∏–∫–∏: 413/422/429
- [x] Telemetry hooks –¥–ª—è save (backoff/limit/status –¥–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
- [x] AutoSave toggle Œ≤ + localStorage
- [x] Exit beacon telemetry-only (–Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ toggle)
- [x] Image pipeline –±–µ–∑ base64: paste + drag&drop + downscale + presign+PUT + CDN URL
- [x] 403/413/415/429 –æ–±—Ä–æ–±–∫–∞ –¥–ª—è upload, 429 –∑ backoff+retry
- [x] Ctrl+Z –¥–ª—è move/resize assets

---

## ‚è≥ PENDING / STRETCH (–æ–ø—Ü—ñ–π–Ω–æ)

- [ ] –û–∫—Ä–µ–º—ñ telemetry –ø–æ–¥—ñ—ó –¥–ª—è upload (presign/put error + backoff).
- [ ] Render-stability flags (Safari/UA-gated hard guards).

---

## üß™ –†—É—á–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

- **Paste image**: –≤—Å—Ç–∞–≤–∏—Ç–∏ –∑ –±—É—Ñ–µ—Ä–∞ ‚Üí –æ–¥—Ä–∞–∑—É preview (blob) ‚Üí —á–µ—Ä–µ–∑ –º–∏—Ç—å CDN URL.
- **Drag & drop image**: –ø–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ —Ñ–∞–π–ª –Ω–∞ canvas ‚Üí preview ‚Üí CDN URL.
- **Ctrl+Z** –ø—ñ—Å–ª—è drag/resize –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ–ø–µ—Ä–µ–¥–Ω—é –ø–æ–∑–∏—Ü—ñ—é/—Ä–æ–∑–º—ñ—Ä.
- **429** (—ñ–º—ñ—Ç–∞—Ü—ñ—è rate limit) ‚Üí backoff + retry 1 —Ä–∞–∑.

---

*M4SH Platform v0.30 ‚Äî Frontend –≥–æ—Ç–æ–≤–∏–π –¥–æ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ –±–µ–∫–µ–Ω–¥ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏ v0.30.*
