# v0.19.0 Backend Report

**Дата:** 2025-12-12  
**Статус:** ✅ Завершено

---

## Огляд

Версія v0.19.0 включає два основних блоки:
1. **Security Hardening (S1-S8)** — посилення безпеки для boards app
2. **Marketplace Core (M1-M7)** — базова інфраструктура для маркетплейсу репетиторів

---

## Security Hardening

### S1 — WebSocket Rate Limiting ✅

**Файл:** `apps/boards/consumers/board_consumer.py`

Реалізовано:
- Клас `RateLimiter` з token bucket алгоритмом
- Конфігурація: 100 ops/sec, burst 50, cursor rate 20
- Інтеграція в `receive_json` з graceful error response
- Окремий ліміт для cursor updates

### S2 — Component Data Validation ✅

**Файл:** `apps/boards/services/validation_service.py`

Реалізовано:
- `ComponentValidationService` з JSON Schema валідацією
- Схеми для: text, image, shape, drawing, sticky, embed, file
- XSS санітизація тексту (bleach)
- URL санітизація (SSRF prevention)
- Singleton pattern

### S3 — Image Upload Security ✅

**Файл:** `apps/boards/services/image_service.py`

Реалізовано:
- `ImageSecurityService` для безпечного завантаження зображень
- Magic bytes MIME detection
- Розмір: max 10MB, dimensions: max 4096x4096
- Filename sanitization
- SSRF prevention для URL
- Safe path generation

### S4 — Session Token Validation ✅

**Файл:** `apps/boards/consumers/board_consumer.py`

Реалізовано:
- Періодична валідація токену (кожні 60 секунд)
- Graceful disconnect при невалідному токені
- Asyncio task для фонової перевірки

### S5 — Path Traversal Prevention ✅

**Файл:** `apps/boards/services/export_service.py`

Реалізовано:
- `safe_filename()` — санітизація імен файлів
- `safe_export_path()` — безпечна генерація шляхів
- Directory confinement (MEDIA_ROOT/exports)
- `export_to_file()` з перевіркою шляхів

### S6 — History Cleanup Fix ✅

**Файл:** `apps/boards/services/history_service.py`

Реалізовано:
- Atomic cleanup з `transaction.atomic`
- Row locking з `select_for_update`
- Збереження мінімум 100 записів
- Збереження записів новіших за 30 днів

### S7 — Layer Reorder Atomicity ✅

**Файл:** `apps/boards/services/layer_service.py`

Реалізовано:
- Atomic reorder з `transaction.atomic`
- Row locking з `select_for_update`
- Валідація layer IDs
- Temporary negative order для уникнення unique constraint conflicts

### S8 — API Throttling ✅

**Файли:**
- `apps/boards/api/throttling.py` (новий)
- `apps/boards/api/views.py` (оновлено)

Реалізовано:
- `BoardUserThrottle` — загальний throttle для користувачів
- `BoardAnonThrottle` — для анонімних
- `BoardExportThrottle` — суворіший для експорту
- `BoardBatchThrottle` — для batch операцій
- `BoardImportThrottle` — для імпорту
- `BoardTemplateThrottle` — для шаблонів
- Динамічний вибір throttle в `get_throttles()`

---

## Marketplace Core

### M1 — TutorProfile Model ✅

**Файл:** `apps/marketplace/models/tutor_profile.py`

Модель включає:
- OneToOne зв'язок з User
- Унікальний slug для публічного URL
- Status: draft, pending, approved, rejected, suspended
- Базова інформація: headline, bio, photo, video_intro_url
- Професійна інформація: education, experience_years, certifications
- Навчальна інформація: subjects, languages
- Локація: country, timezone
- Ціноутворення: hourly_rate, currency, trial_lesson_price
- Денормалізована статистика: total_lessons, total_students, average_rating, total_reviews
- Видимість: is_public, is_featured
- Timestamps: created_at, updated_at, approved_at, last_active_at
- Індекси для оптимізації пошуку

### M2 — Verification Model ✅

**Файл:** `apps/marketplace/models/verification.py`

Реалізовано:
- `VerificationType`: identity, education, background, certification
- `VerificationStatus`: pending, in_review, approved, rejected
- `TutorVerification` модель з:
  - FK до TutorProfile
  - Documents (JSON)
  - Review info: reviewed_by, reviewed_at, review_notes, rejection_reason
  - Expiration: expires_at
  - Методи: is_valid(), approve(), reject(), start_review()

### M3 — Badge Model ✅

**Файл:** `apps/marketplace/models/badge.py`

Реалізовано:
- `BadgeType`: top_tutor, new_tutor, recommended, verified, super_tutor, rising_star, fast_responder
- `Badge` модель з:
  - badge_type, name, description, icon, color
  - criteria (JSON) для автоматичних бейджів
  - is_automatic, priority
- `TutorBadge` модель з:
  - FK до TutorProfile та Badge
  - awarded_by, reason, expires_at, is_active
  - Метод is_valid()
- `SYSTEM_BADGES` — дані для seeding

### M4 — Profile Service ✅

**Файл:** `apps/marketplace/services/profile_service.py`

Методи:
- `create_profile()` — створення профілю
- `update_profile()` — оновлення полів
- `submit_for_review()` — подача на модерацію
- `approve_profile()` — схвалення (admin)
- `reject_profile()` — відхилення (admin)
- `publish_profile()` / `unpublish_profile()` — публікація
- `get_public_profile()` — отримання публічного профілю
- `get_profile_by_user()` — отримання за user ID
- `update_stats()` — оновлення статистики
- `generate_unique_slug()` — генерація унікального slug
- `search_tutors()` — пошук з фільтрами
- `get_featured_tutors()` — featured репетитори
- `suspend_profile()` / `reactivate_profile()` — призупинення

### M5 — Verification Service ✅

**Файл:** `apps/marketplace/services/verification_service.py`

Методи:
- `submit_verification()` — подача верифікації
- `review_verification()` — рецензування (admin)
- `get_pending_verifications()` — pending для admin
- `get_in_review_verifications()` — in review
- `check_verification_status()` — статус верифікацій профілю
- `get_profile_verifications()` — всі верифікації профілю
- `expire_old_verifications()` — cron для expiration
- `has_valid_verification()` — перевірка валідності

### M6 — Badge Service ✅

**Файл:** `apps/marketplace/services/badge_service.py`

Методи:
- `award_badge()` — ручне нагородження
- `revoke_badge()` — відкликання
- `check_automatic_badges()` — перевірка та автоматичне нагородження
- `_check_badge_criteria()` — перевірка критеріїв
- `get_profile_badges()` — бейджі профілю
- `get_all_badges()` — всі бейджі
- `seed_system_badges()` — seeding системних бейджів
- `recalculate_all_badges()` — cron для перерахунку
- `expire_old_badges()` — cron для expiration

### M7 — Marketplace API ✅

**Файли:**
- `apps/marketplace/api/serializers.py`
- `apps/marketplace/api/permissions.py`
- `apps/marketplace/api/views.py`
- `apps/marketplace/urls.py`

**Публічні ендпоінти:**
- `GET /api/v1/marketplace/tutors/` — пошук репетиторів
- `GET /api/v1/marketplace/tutors/featured/` — featured
- `GET /api/v1/marketplace/tutors/{slug}/` — деталі профілю
- `GET /api/v1/marketplace/badges/` — список бейджів

**Authenticated ендпоінти:**
- `GET/POST/PATCH /api/v1/marketplace/profile/` — власний профіль
- `POST /api/v1/marketplace/profile/submit/` — подача на модерацію
- `POST /api/v1/marketplace/profile/publish/` — публікація
- `POST /api/v1/marketplace/profile/unpublish/` — приховування
- `GET/POST /api/v1/marketplace/profile/verifications/` — верифікації
- `GET /api/v1/marketplace/profile/badges/` — бейджі

**Admin ендпоінти:**
- `GET /api/v1/admin/marketplace/profiles/` — список профілів
- `POST /api/v1/admin/marketplace/profiles/{id}/approve/` — схвалення
- `POST /api/v1/admin/marketplace/profiles/{id}/reject/` — відхилення
- `GET /api/v1/admin/marketplace/verifications/` — pending верифікації
- `POST /api/v1/admin/marketplace/verifications/{id}/review/` — рецензування
- `POST /api/v1/admin/marketplace/badges/award/` — нагородження бейджем

---

## Додаткові файли

### Admin
- `apps/marketplace/admin.py` — Django admin для всіх моделей

### Management Commands
- `apps/marketplace/management/commands/seed_badges.py` — seeding бейджів

### Tests
- `apps/marketplace/tests/test_profiles.py` — тести профілів
- `apps/marketplace/tests/test_badges.py` — тести бейджів

---

## Наступні кроки

1. Створити міграції: `python manage.py makemigrations marketplace`
2. Застосувати міграції: `python manage.py migrate`
3. Seed бейджі: `python manage.py seed_badges`
4. Додати throttle rates до settings.py:
   ```python
   REST_FRAMEWORK = {
       'DEFAULT_THROTTLE_RATES': {
           'board_user': '60/minute',
           'board_anon': '20/minute',
           'board_export': '10/minute',
           'board_batch': '30/minute',
           'board_import': '10/minute',
           'board_template': '30/minute',
       }
   }
   ```
5. Запустити тести: `pytest apps/marketplace/tests/ -v`

---

## Статистика

| Метрика | Значення |
|---------|----------|
| Нових файлів | 15 |
| Змінених файлів | 7 |
| Нових моделей | 4 |
| Нових сервісів | 3 |
| Нових API endpoints | 16 |
| Тестів | 12 |
