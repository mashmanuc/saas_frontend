# v0.32 Backend ‚Äî Lessons (Calendar/Room) + My Students + Invite Links

**–í–µ—Ä—Å—ñ—è:** 0.32  
**–†–æ–ª—å:** Backend Developer  
**–î–∞—Ç–∞:** 18.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìã SUMMARY

v0.32 –±–µ–∫–µ–Ω–¥ —Å—Ñ–æ–∫—É—Å–æ–≤–∞–Ω–∏–π –Ω–∞ Lessons-–¥–æ–º–µ–Ω—ñ —Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ Classroom: –¥–æ–¥–∞–Ω–æ –ª—ñ–Ω–∫ `ClassroomSession ‚Üî Lesson`, –æ–Ω–æ–≤–ª–µ–Ω–æ ACL –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—ñ–≤ —á–µ—Ä–µ–∑ membership —É classroom, —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏–π range-–µ–Ω–¥–ø–æ—ñ–Ω—Ç (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `role`, —Ä–æ–ª—å –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –∑ `request.user.role`), –µ–Ω–¥–ø–æ—ñ–Ω—Ç –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è room (`session_uuid`) –∑ backfill, –∞ —Ç–∞–∫–æ–∂ stateless invite links –∑ TTL –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ lesson room. –î–æ–¥–∞–Ω–æ endpoint –¥–ª—è —Ç—å—é—Ç–æ—Ä–∞ ‚ÄúMy Students‚Äù (search + pagination). –î–ª—è –Ω–æ–≤–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–æ error body `{error, detail}`.

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–Ü –ó–ê–í–î–ê–ù–ù–Ø (MUST)

### BE32-1: ClassroomSession ‚Üî Lesson (OneToOne)
- –î–æ–¥–∞–Ω–æ –ø–æ–ª–µ `ClassroomSession.lesson` (nullable `OneToOneField` –Ω–∞ `lessons.Lesson`).
- –ú—ñ–≥—Ä–∞—Ü—ñ—è: `apps/classroom/migrations/0004_classroomsession_lesson_fk.py`.

### BE32-2: Lessons ‚Äî create (membership ACL) + session_uuid
- `POST /api/lessons/`:
  - –¥–æ—Å—Ç—É–ø: –ª–∏—à–µ —Ç—å—é—Ç–æ—Ä
  - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: student –º–∞—î –±—É—Ç–∏ `ACTIVE` membership —É classroom —Ü—å–æ–≥–æ —Ç—å—é—Ç–æ—Ä–∞
  - —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è `ClassroomSession` –∑ `lesson=<created lesson>`
  - –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ membership: `403 {"error":"not_a_member","detail":"..."}`
  - —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π `session_uuid`

### BE32-3: Lessons ‚Äî calendar range (role inferred)
- `GET /api/lessons?from&to`:
  - –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `role` –Ω–µ–º–∞—î
  - —Ä–æ–ª—å –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –∑ `request.user.role`
  - –ø–æ–≤–µ—Ä—Ç–∞—î `{ "results": [...] }`

### BE32-4: Lessons ‚Äî room resolve
- `GET /api/lessons/{lesson_id}/room/`:
  - ACL: —Ç—ñ–ª—å–∫–∏ tutor/student —Ü—ñ—î—ó lesson
  - –ø–æ–≤–µ—Ä—Ç–∞—î `{ lesson_id, session_uuid }`
  - —è–∫—â–æ `ClassroomSession` —â–µ –Ω–µ —ñ—Å–Ω—É—î, –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è backfill (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Å—ñ—ó)

### BE32-5: Invite links (stateless TTL)
- `POST /api/lessons/{lesson_id}/invite/`:
  - –ø–æ–≤–µ—Ä—Ç–∞—î `{ invite_url, expires_at, token }`
  - token URL-safe (base64url), TTL –≤–±—É–¥–æ–≤–∞–Ω–∏–π —É payload (`exp`)
- `GET /api/lesson-invites/resolve/?token=...`:
  - –ø–æ–≤–µ—Ä—Ç–∞—î `{ lesson_id, session_uuid }`
  - `410 {"error":"invite_expired","detail":"Invite expired"}` —è–∫—â–æ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–æ

### BE32-6: My Students (Tutor)
- `GET /api/classroom/my-students/?q&limit&offset`:
  - –¥–æ—Å—Ç—É–ø: –ª–∏—à–µ —Ç—å—é—Ç–æ—Ä
  - –¥–∂–µ—Ä–µ–ª–æ: `ClassroomMembership` (role=student, status=active) —É classroom —Ç—å—é—Ç–æ—Ä–∞
  - –ø—ñ–¥—Ç—Ä–∏–º—É—î search –ø–æ `first_name/last_name/email`
  - –ø–æ–≤–µ—Ä—Ç–∞—î `{ count, results }`

---

## üìÅ –ù–û–í–Ü/–û–ù–û–í–õ–ï–ù–Ü –§–ê–ô–õ–ò

### Lessons
- `apps/lessons/api/views.py`
- `apps/lessons/api/urls.py`
- `apps/lessons/api/serializers.py`
- `apps/lessons/tests/test_lessons_api.py` (–æ–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ–¥ membership ACL + `session_uuid`)
- `apps/lessons/tests/test_lessons_v032_api.py` (–Ω–æ–≤—ñ —Ç–µ—Å—Ç–∏ v0.32)

### Classrooms
- `apps/classrooms/api/views.py` (MyStudentsView)
- `apps/classrooms/api/urls.py`
- `apps/classrooms/tests/test_my_students_api.py`

### Classroom (sessions)
- `apps/classroom/models/session.py`
- `apps/classroom/migrations/0004_classroomsession_lesson_fk.py`

### Config
- `config/settings.py` (–¥–æ–¥–∞–Ω–æ `testserver` —É `ALLOWED_HOSTS` –¥–ª—è —Ç–µ—Å—Ç—ñ–≤)

---

## üîó ENDPOINTS (v0.32)

| Area | Method | Endpoint | Auth | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|------|--------|----------|------|-------------|
| Lessons | POST | `/api/lessons/` | ‚úÖ Tutor | create lesson + create session (`session_uuid`) |
| Lessons | GET | `/api/lessons?from&to` | ‚úÖ | calendar range (role inferred) |
| Lessons | GET | `/api/lessons/{lesson_id}/room/` | ‚úÖ | get lesson room (`session_uuid`) + backfill |
| Lessons | POST | `/api/lessons/{lesson_id}/invite/` | ‚úÖ Tutor | generate invite link (TTL) |
| Lessons | GET | `/api/lesson-invites/resolve/?token=...` | ‚úÖ | resolve invite -> room (`session_uuid`) |
| Classrooms | GET | `/api/classroom/my-students/?q&limit&offset` | ‚úÖ Tutor | list/search students |

---

## üß© ERROR CONTRACT (v0.32)

–ù–æ–≤—ñ –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å –ø–æ–º–∏–ª–∫–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ:

```json
{ "error": "<code>", "detail": "<human-readable>" }
```

–ö–ª—é—á–æ–≤—ñ –∫–æ–¥–∏:
- `not_a_member` (403)
- `invite_invalid` (400)
- `invite_expired` (410)
- `lesson_not_found` (404)
- `forbidden` (403)

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

```bash
pytest apps/lessons/tests/test_lessons_api.py -q
pytest apps/lessons/tests/test_lessons_v032_api.py -q
pytest apps/classrooms/tests/test_my_students_api.py -q
```
