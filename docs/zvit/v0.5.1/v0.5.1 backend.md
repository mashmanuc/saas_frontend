# v0.5.1 Backend — підсумковий звіт

Документ для наставників: що вже готово у бекенді станом на реліз **v0.5.1** (усі задачі з плану `backend_05.md`), які компоненти покриті тестами та як підготовано демо-середовище.

## 0. Стан репозиторію
- **Гілка**: `main`
- **Останній тег**: `v0.5.1`
- **Python/Django**: Python 3.11.9, Django 5.2.9, DRF + drf-spectacular.
- **Запуск**: `python manage.py runserver` (перед цим `pip install -r requirements.txt`, `python manage.py migrate`).
- **JWT + cookie refresh**: refresh токен зберігається у httponly-cookie; у DEBUG режимі cookie не `secure`, щоб працювало на http://localhost.

## 1. Архітектура та головні модулі
### Users (`apps.users`)
- **Основні класи**:
  - `User` (custom AUTH_USER_MODEL) — ролі: `student`, `tutor`, `admin`, `superadmin`, поле `is_self_learning`, timestamp-поля, менеджер `UserManager`.
  - `TutorProfile`, `StudentProfile` (OneToOne до `User`) — біо, предмети, досвід, timezone, оцінка тощо.
  - `UserSettings` — мова, тема UI, налаштування нотифікацій (буде розширюватися у v0.6).
  - Додаткові моделі (`UserInvitation`, `TutorStudentRelation`, тощо) — для заявок, історії ролей, токенів.
- **API**:
  - `/api/auth/*` — login/logout/refresh/register/invite flows (JWT + refresh cookie).
  - `/api/me/profile/` (B5.1) — головний entrypoint профілю.
  - `/api/tutor/*` — управління студентами й classroom-ами для тьютора (ще з v0.4).
- **Плани v0.6+**:
  - Додати API для аватарів (`/api/me/avatar/`), розширити `UserSettings`, покрити додатковою валідацією PATCH.

### Classrooms (`apps.classrooms`)
- **Класи**:
  - `Classroom`, `ClassroomMembership`, `Lesson`, `Assignment`, `ClassroomSettings`, `ClassroomActivityLog` (успадковані з v0.4; B5-фаза додала чат і дошки поверх них).
- **API**:
  - `/api/tutor/classrooms/` (список/деталі), `assignments`, `lessons` (read-only).
- **Плани**:
  - Підготувати засоби для realtime-логів (activity log + webhooks), покращити статуси membership (в майбутніх релізах).

### Courses (`apps.courses`)
- Новий модуль у v0.5:
  - `Course`, `Topic`, `TestTemplate`. Створюють основу для контенту (далі буде question bank).

### Boards (`apps.boards`)
- `BoardSession` — JSON-дошка, прив’язана до classroom (або приватна), owner = користувач.
- План: у v0.6/v0.7 додати спільне редагування, websocket sync, історію версій.

### Chat (`apps.chat`)
- `ClassroomMessage` — мінімальний чат (типи повідомлень, хто відправив).
- Майбутні кроки: websocket-шар, push-нотіфікації, модерація.

### Adminpanel (`apps.adminpanel`)
- Read-only API для admin/superadmin:
  - `AdminUserListView`, `AdminClassroomListView`, `AdminStatsView`.
- Далі — розширити до CRUD (блокування, модерація).

### Core (`apps.core`)
- Management-команди, зокрема `seed_demo`.

## 2. Статус задач B5.x

| Підрозділ | Статус | Коротко |
|-----------|--------|---------|
| **B5.1** — профіль користувача | ✅ | Є `GET/PATCH /api/me/profile/`, серіалізатори, тести. |
| **B5.2** — курси/теми/тести | ✅ | App `apps.courses`, read-only API, Swagger. |
| **B5.3** — дошки (BoardSession) | ✅ | CRUD API + права доступу + тести. |
| **B5.4** — classroom chat | ✅ | Модель `ClassroomMessage`, GET/POST API, тести. |
| **B5.5** — admin read-only API | ✅ | `apps.adminpanel`, списки користувачів/класів/статистики. |
| **B5.6** — тести / seed / Swagger | ✅ | Покриті ключові ендпоінти, є `seed_demo`, оновлені доки. |

Нижче — деталізація по кожному блоку (включаючи попередні партії B5.1–B5.6).

---

## 2. B5.1 — API «Мій профіль»
**Мета**: віддати фронту один контракт для перегляду/редагування профілю.

### Моделі та серіалізатори
- Використовуємо існуючі `apps.users.User`, `TutorProfile`, `StudentProfile`, `UserSettings`.
- Серіалізатори (`apps/users/api/serializers.py`):
  - `UserProfileSerializer` — `first_name`, `last_name`, `email` (read-only), `timezone`, `role`, `is_self_learning`.
  - `TutorProfileSerializer`, `StudentProfileSerializer`, `UserSettingsSerializer`.
  - Композитний `MeProfileSerializer` об’єднує блоки в одну відповідь.

### API
- `GET /api/me/profile/` — повертає `{ user, tutor_profile|null, student_profile|null, settings|null }`.
- `PATCH /api/me/profile/` — часткове оновлення кожного блоку; `user.is_self_learning` видаляється з payload, щоб не можна було міняти напряму.
- Перміси: `IsAuthenticated`, працюємо лише з `request.user`.
- Swagger (`extend_schema`) описує і GET, і PATCH.

### Тести
- `apps/users/tests/test_me_profile_api.py`:
  - GET як студент/тьютор/суперадмін → 200.
  - PATCH оновлює `first_name`, `timezone`, але ігнорує `is_self_learning`.

---

## 3. B5.2 — Курси/Теми/Тести (read-only)
**Мета**: дати фронту каталог контенту (поки без питань/відповідей).

- App `apps.courses`:
  - `Course(id, title, description, subject, level)`.
  - `Topic(course, title, order)`.
  - `TestTemplate(topic, title, description, max_score, is_published)`.
- API (`rest_framework.generics.ListAPIView`):
  - `GET /api/courses/` — всі курси.
  - `GET /api/courses/<id>/topics/` — теми конкретного курсу.
  - `GET /api/tests/?course=<id>&topic=<id>` — тестові шаблони з фільтрами.
- Доступ: `AllowAny` (читання без авторизації).
- Swagger: параметри `course`, `topic`, опис тем.

---

## 4. B5.3 — BoardSession (дошки)
**Мета**: зберігати стан дошки з фронта (без realtime).

- App `apps.boards`:
  - Модель `BoardSession(classroom?, owner, title, state JSON, created_at, updated_at)`.
  - Пермісія `IsOwnerOrClassroomTutor` (owner або тьютор classroom).
- API:
  - `GET /api/boards/?classroom=<id>` — лише дошки поточного користувача.
  - `POST /api/boards/` — створення (owner підставляється автоматично).
  - `GET/PATCH/DELETE /api/boards/<id>/`.
- Тести `apps/boards/tests/test_boards_api.py`:
  - список повертає лише власні дошки;
  - фільтр `?classroom`;
  - створення з owner;
  - доступ заборонений стороннім.
- Swagger: окремо описано GET/POST (фільтр classroom) і detail PATCH.

---

## 5. B5.4 — Classroom Chat
**Мета**: мінімальний чат для classroom з пермісіями, який можна буде винести на сокети.

- App `apps.chat`:
  - Модель `ClassroomMessage(classroom, sender, text, message_type=text/system, created_at)`.
  - Пермісія `IsClassroomParticipant`: tutor або активний студент.
- API:
  - `GET /api/classrooms/<id>/messages/?limit&before&after` — останні повідомлення (limit 1–100, default 50).
  - `POST /api/classrooms/<id>/messages/` — створення повідомлення (`classroom` і `sender` підставляються).
- Тести `apps/chat/tests/test_classroom_messages_api.py`:
  - недоступно неучасникам (403);
  - GET/POST для тьютора й активного студента (200/201);
  - `limit` обмежує кількість.
- Swagger описує параметри paginaton та POST.

---

## 6. B5.5 — Admin read-only API
**Мета**: дати майбутній адмінці/модератору дані з бекенду.

- App `apps.adminpanel`.
- Пермісія `IsAdminOrSuperAdmin` (доступ тільки для ролей `admin`, `superadmin`).
- Ендпоінти:
  - `GET /api/admin/users/?role=` — список користувачів з фільтром за роллю.
  - `GET /api/admin/classrooms/` — всі classroom-и.
  - `GET /api/admin/stats/` — агрегати (`users_total`, `students_total`, `tutors_total`, `classrooms_total`).
- Всі ендпоінти read-only, тому наразі без окремих тестів (можна додати у v0.6 при розширенні).

---

## 7. B5.6 — Тести, демо-дані, документація
**Мета**: технічний борг після v0.4–v0.5.

### Тести
- `/api/me/profile/` — покрито (див. вище).
- `/api/tutor/classrooms/`, `/api/tutor/classrooms/<id>/` — `apps/classrooms/tests`.
- `/api/boards/` — `apps/boards/tests`.
- `/api/classrooms/<id>/messages/` — `apps/chat/tests`.

### seed_demo
- Команда: `python manage.py seed_demo` (`apps.core.management.commands.seed_demo`).
- Створює:
  - 3 тьютори (`tutor1..3@example.com`), 10 студентів (`student1..10@example.com`), пароль `demo1234`.
  - По одному classroom на тьютора, по 5 активних студентів у кожному.
  - По дошці `BoardSession` на classroom.
  - Вітальні повідомлення в чаті.

### Документація
- Swagger `/api/docs/` оновлено для всіх нових ендпоінтів (профіль, курси, дошки, чат, admin).
- `docs/dev/Django_shell.md` доповнено:
  - кроки про міграції (особливо для `courses`, `boards`, `chat`, `adminpanel`, `core`);
  - інструкції `createsuperuser`, `seed_demo`;
  - правильні імпорти для shell.

---

## 8. Що ще можна покращити (не критично для v0.5.1)
1. Тести для admin API (read-only) — поки не обов’язково, але можна додати разом зі змінами у ролях.
2. Frontend інтеграції: синхронізувати з новими API (курси, дошки, чат, admin).
3. Розглянути рефакторинг `UserSettings` (додати нові поля у v0.6 — ui_theme, interface_language), винести API для аватарів, websockets тощо.

---

## 9. Курс розвитку (щоб платформа не «звузилась»)
### Пріоритети v0.6 (див. backend_06.md)
1. **UX профілю**:
   - Додати `avatar` (ImageField, ендпоінт POST/DELETE).
   - Розширити `UserSettings` (UI theme, interface language).
   - Гарантувати валідацію PATCH для key-полів (first_name, subjects, settings JSON).
2. **Документація/infra**:
   - Оновити Swagger, інструкції з медіафайлів, приклади form-data.

### Дальший roadmap (v0.7+)
1. **Realtime**:
   - WebSocket для classroom chat і BoardSession.
   - push-нотіфікації (черги, Celery).
2. **Learning Content**:
   - Розширити `TestTemplate` до `Question`, підтримка NMT/кастомних рубрик.
   - API для progress tracking (статистика по тестах/темах).
3. **Admin/Moderation**:
   - CRUD у `apps.adminpanel`, workflow для скарг.
4. **Integrations**:
   - Email/SMS нотифікації, календар (iCal/Google).

Таким чином, бекенд v0.5.1 вже охоплює ключові домени (користувачі, classroom, контент, дошки, чат, адміністрація) і має тестове покриття + демо-дані. Наступні версії мають фокусуватися на розширенні UX (аватари, налаштування), realtime-можливостях та масштабуванні контенту, щоб рухатися до повноцінної освітньої платформи, а не single-use продукту.
