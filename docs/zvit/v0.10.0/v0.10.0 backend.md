# BACKEND — Розширений звіт v0.10.0

## 1. WebSocket Gateway
- **JWT-автентифікація та повторна валідація.** Реалізовано повний цикл підключення з токеном, періодичну перевірку дійсності та закриття сесії при невдачі (`RealtimeGatewayConsumer`).  
- **Управління підписками.** Підтримано канали `chat:user:{id}`, `board:lesson:{id}`, `status:users`, `notifications:user:{id}` з перевіркою прав доступу, лімітом підписок та error-handling.  
- **Механізм broadcast.** Усі події передаються через `channel_layer.group_send`, а клієнти отримують payload через `realtime.send`.
- **Тести.** 19 інтеграційних WebSocket тестів (`apps.realtime.tests.test_gateway`) покривають підключення, підписки, board-events, chat-events, presence та токен-рефреш.

## 2. Realtime Chat (REST + WS)
- **REST API.**  
  - `POST /api/chat/messages/` — створення повідомлень, валідатор тексту, перевірка участі в уроці.  
  - `GET /api/chat/history/` — курсорна пагінація історії за `lesson_id`.  
  - `PATCH/DELETE /api/chat/messages/{id}/` — редагування/видалення тільки автором.
- **WS події.** Після будь-якої зміни повідомлення генерується `chat.message.{new|edited|deleted}` та розсилається у `chat:user:{participant_id}`.  
- **Автотести.**  
  - API-кейси (`apps/chat/tests/test_lesson_chat_api.py`) перевіряють створення, історію, редагування, видалення та права доступу.  
  - WS інтеграція (`RealtimeGatewayTests`) підтверджує доставку `chat.message.*` через gateway.

## 3. Online Presence
- **Сервіс.** Redis-бекенд із TTL=90s, heartbeat=30s, івенти `user.online/offline` через `status:users`.  
- **API.** `GET /api/users/online-status/?ids=...` повертає карту онлайнності та список `online_ids`.  
- **Тести.**  
  - `apps/realtime/tests/test_presence.py` — кешування, ідempotent стани, публікація подій.  
  - `apps/users/tests/test_online_status_api.py` — аутентифікація, валідація та очікуваний payload.

## 4. Realtime Whiteboard
- **Події.** Gateway обробляє `board.patch`, `board.reset`, `board.cursor.move`, `board.snapshot.request/send`.  
- **Snapshot збереження.** `apps.boards.services.maybe_save_snapshot` оновлює PostgreSQL не частіше ніж раз на 30 секунд, а `board.snapshot.request` повертає останній стан.  
- **Тести.**  
  - Сервісні (`apps/boards/tests/test_snapshots.py`) перевіряють створення/пропуск/оновлення snapshot.  
  - Gateway-тести підтверджують broadcast подій, виклик `maybe_save_snapshot`, повернення snapshot та обробку курсорів.

## 5. Push Notifications (WS + Email fallback)
- **Логіка.** `apps.notifications.push.dispatch` шле події через WS, а при офлайні користувача надсилає email за Jinja-шаблонами.  
- **Події.** `lesson.scheduled`, `lesson.rescheduled`, `chat.message`, `board.activity`, `tutor.accept`, `student.invited`.  
- **Тести.** `apps/notifications/tests/test_push.py` покривають online/offline сценарії та пропуск email без шаблону.

## 6. Тестове покриття
- **WS suite.** 24+ інтеграційних тестів (`apps.realtime.tests.test_gateway`, push, online-status, chat API).  
- **Unit/Service.** Presence, board snapshots, push dispatcher.  
- **API.** Chat, online-status, classroom/board API (раніше).  
- **Результат.** Усі тести (`python manage.py test apps.realtime.tests.test_gateway apps.realtime.tests.test_publisher apps.notifications.tests.test_push apps.users.tests.test_online_status_api apps.chat.tests.test_lesson_chat_api apps.boards.tests.test_snapshots`) проходять без помилок.

## 7. Висновки та наступні дії
- Вимоги технічного завдання v0.10.0 (backend) виконані повністю: gateway, чат, presence, whiteboard, push та автотести.  
- Система готова до інтеграційного тестування з фронтендом і подальшого релізу.  
- Рекомендовано: стежити за продуктивністю Redis presence та часом збереження snapshot на production, а також оновити документацію API (Swagger) з новими ендпоінтами.