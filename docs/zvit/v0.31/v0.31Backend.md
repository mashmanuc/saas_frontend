# v0.31 Backend ‚Äî Classroom WS Presence + Solo Snapshots Quota/GC + Telemetry Ingest

**–í–µ—Ä—Å—ñ—è:** 0.31  
**–†–æ–ª—å:** Backend Developer  
**–î–∞—Ç–∞:** 17.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìã SUMMARY

v0.31 –±–µ–∫–µ–Ω–¥ —Å—Ñ–æ–∫—É—Å–æ–≤–∞–Ω–∏–π –Ω–∞ real-time —à–∞—Ä—ñ –¥–ª—è Classroom (WebSocket Presence & Cursors –∑ RBAC), –∞ —Ç–∞–∫–æ–∂ –Ω–∞ production-ready –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—ñ snapshot‚Äô—ñ–≤ –¥–ª—è Solo Workspace: –¥–æ–¥–∞–Ω–æ per-user quota enforcement, retention/GC –∑—ñ –∑–º–µ–Ω—à–µ–Ω–Ω—è–º `used_bytes`, —Ç–∞ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π endpoint –¥–ª—è telemetry ingest —É `apps/diagnostics`.

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–Ü –ó–ê–í–î–ê–ù–ù–Ø (MUST)

### BE31-1: ClassroomSession ‚Üî Classroom (FK + backfill)
- –î–æ–¥–∞–Ω–æ FK `ClassroomSession.classroom` ‚Üí `classrooms.Classroom`.
- –ú—ñ–≥—Ä–∞—Ü—ñ—è —Ä–æ–±–∏—Ç—å backfill (–ø—ñ–¥–≤‚Äô—è–∑—É—î —Å–µ—Å—ñ—ó –¥–æ Classroom —Ç–∞ —Ñ–æ—Ä–º—É—î membership —Ç–∞–º, –¥–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ) ‚Äî –±–∞–∑–∏—Å –¥–ª—è RBAC —É WS.

### BE31-2: WebSocket Presence & Cursors
- –î–æ–¥–∞–Ω–æ consumer `PresenceConsumer` –∑ JWT auth (—Ç—ñ–ª—å–∫–∏ headers), RBAC —á–µ—Ä–µ–∑ membership/tutor.
- WS route:
  - `GET ws://.../ws/classroom/{class_id}/session/{session_id}/`
- –û–±–º–µ–∂–µ–Ω–Ω—è:
  - max WS payload: 2 KiB
  - cursor updates: ‚â§ 20/—Å–µ–∫ –Ω–∞ —é–∑–µ—Ä–∞
- Close codes:
  - `4400` bad_request
  - `4401` unauthorized
  - `4403` forbidden
  - `4429` rate_limited
- –î–æ–¥–∞–Ω–æ —Ç–µ—Å—Ç–∏ –Ω–∞ auth/forbidden/rate/payload.

### BE31-3: Snapshot quota enforcement (Solo)
- –î–æ–¥–∞–Ω–æ –º–æ–¥–µ–ª—å `SoloUserStorage` –¥–ª—è –æ–±–ª—ñ–∫—É `used_bytes` —Ç–∞ `quota_bytes`.
- –£ `POST /api/v1/solo/sessions/{id}/snapshot/`:
  - –ø–µ—Ä–µ–¥ upload –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è quota
  - –ø–æ–º–∏–ª–∫–∞ `403 quota_exceeded` –ø–æ–≤–µ—Ä—Ç–∞—î `used/quota/remaining`
  - —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç `used_bytes` —Ä–æ–±–∏—Ç—å—Å—è –ø–æ delta (–±–µ–∑ double-counting)

### BE31-4: Retention/GC –¥–ª—è snapshots
- –î–æ–¥–∞–Ω–æ task `solo.cleanup_snapshots`:
  - –ª–∏—à–∞—î –æ—Å—Ç–∞–Ω–Ω—ñ N —Ä–µ–≤—ñ–∑—ñ–π –Ω–∞ —Å–µ—Å—ñ—é (`keep_last` –∞–±–æ `settings.SOLO_SNAPSHOT_RETENTION_KEEP_LAST`, default 20)
  - –≤–∏–¥–∞–ª—è—î —Å—Ç–∞—Ä—ñ –≤–µ—Ä—Å—ñ—ó —É storage
  - –¥–µ–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç—å `SoloUserStorage.used_bytes` –Ω–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω–∏–π —Ä–æ–∑–º—ñ—Ä
- –î–æ–¥–∞–Ω–æ —Ç–µ—Å—Ç GC –ø—ñ–¥ local backend.

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–Ü –ó–ê–í–î–ê–ù–ù–Ø (SHOULD)

### BE31-S1: Telemetry ingest endpoint
- –î–æ–¥–∞–Ω–æ `POST /api/v1/logs/telemetry/` (apps/diagnostics):
  - `AllowAny`
  - throttle: 300/min
  - payload limit: 32 KiB
  - –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ `Content-Encoding: gzip`
  - best-effort –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–ø–æ–≤–µ—Ä—Ç–∞—î 204)
- –î–æ–¥–∞–Ω–æ –º–æ–¥–µ–ª—å `TelemetryEvent` + –º—ñ–≥—Ä–∞—Ü—ñ—è.
- –î–æ–¥–∞–Ω–æ —Ç–µ—Å—Ç–∏.

---

## üìÅ –ù–û–í–Ü/–û–ù–û–í–õ–ï–ù–Ü –§–ê–ô–õ–ò

### Classroom
- `apps/classroom/models/session.py`
- `apps/classroom/migrations/0003_classroomsession_classroom_fk.py`
- `apps/classroom/consumers/presence_consumer.py`
- `apps/classroom/routing.py`
- `config/asgi.py`
- `apps/classroom/tests/test_presence_consumer.py`

### Solo
- `apps/solo/models.py` (SoloUserStorage)
- `apps/solo/migrations/0007_solo_user_storage.py`
- `apps/solo/api/views.py` (quota enforcement on snapshot create)
- `apps/solo/services/storage.py` (list/delete versions)
- `apps/solo/tasks.py` (cleanup_snapshots; celery optional)
- `apps/solo/tests/test_snapshot_api.py`
- `apps/solo/tests/test_snapshot_gc.py`

### Diagnostics
- `apps/diagnostics/models.py` (TelemetryEvent)
- `apps/diagnostics/migrations/0003_telemetryevent.py`
- `apps/diagnostics/api/views.py` (TelemetryIngestView)
- `apps/diagnostics/api/serializers.py` (TelemetryEventSerializer)
- `apps/diagnostics/urls.py` (route)
- `apps/diagnostics/tests/test_telemetry_ingest.py`

---

## üîó ENDPOINTS (v0.31)

| Area | Method | Endpoint | Auth | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|------|--------|----------|------|-------------|
| Classroom WS | WS | `/ws/classroom/{class_id}/session/{session_id}/` | ‚úÖ | presence + cursors |
| Solo | POST | `/api/v1/solo/sessions/{id}/snapshot/` | ‚úÖ | create snapshot (quota-aware) |
| Solo | GET | `/api/v1/solo/sessions/{id}/snapshot/latest/` | ‚úÖ | latest snapshot |
| Diagnostics | POST | `/api/v1/logs/telemetry/` | ‚ùå | generic telemetry ingest |

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

```bash
# WS Presence tests
pytest apps/classroom/tests/test_presence_consumer.py -q

# Snapshot quota tests
pytest apps/solo/tests/test_snapshot_api.py -q

# Snapshot GC tests
pytest apps/solo/tests/test_snapshot_gc.py -q

# Telemetry ingest tests
pytest apps/diagnostics/tests/test_telemetry_ingest.py -q
```

---

## ‚úÖ DoD Checklist

- [x] FK ClassroomSession ‚Üí Classroom + backfill
- [x] PresenceConsumer –∑ JWT headers auth + RBAC + rate limits + payload limit
- [x] Quota enforcement –Ω–∞ snapshots (403 quota_exceeded)
- [x] Snapshot retention/GC task –∑ –∫–æ—Ä–µ–∫—Ç–Ω–∏–º `used_bytes` accounting
- [x] Telemetry ingest endpoint –∑ –∂–æ—Ä—Å—Ç–∫–∏–º–∏ –ª—ñ–º—ñ—Ç–∞–º–∏

---

*M4SH Platform v0.31 ‚Äî Backend –≥–æ—Ç–æ–≤–∏–π –¥–æ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ FE —Ç–∞ production rollout –ø–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º.*
