# v0.24.4 Backend ‚Äî Diagnostics & Logging Infrastructure

## üìã SUMMARY

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω—É —Å–∏—Å—Ç–µ–º—É –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–ª—è –≤—Å—ñ—î—ó –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏. –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ `apps.diagnostics` –∑ –º–æ–¥–µ–ª—è–º–∏ –¥–ª—è –ª–æ–≥—ñ–≤, middleware –¥–ª—è —Ç—Ä–µ–∫—ñ–Ω–≥—É –∑–∞–ø–∏—Ç—ñ–≤, API –¥–ª—è –∑–±–æ—Ä—É –ø–æ–º–∏–ª–æ–∫ –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É —Ç–∞ Celery tasks –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è.

---

## ‚úÖ COMPLETED TASKS

### B1: Logging Config

| Task | Status | Description |
|------|--------|-------------|
| JsonFormatter | ‚úÖ | –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥—ñ–≤ |
| LOGGING dict | ‚úÖ | –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è –≤—Å—ñ—Ö –º–æ–¥—É–ª—ñ–≤ |
| File handlers | ‚úÖ | –†–æ—Ç–∞—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤ (10MB, 10 backups) |
| Module loggers | ‚úÖ | –û–∫—Ä–µ–º—ñ –ª–æ–≥–µ—Ä–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–æ–¥—É–ª—è |

### B2: Models

| Task | Status | Description |
|------|--------|-------------|
| AppLog | ‚úÖ | Backend application log |
| FrontendError | ‚úÖ | Frontend error report |
| Indexes | ‚úÖ | –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏ |

### B3-B4: Middleware

| Task | Status | Description |
|------|--------|-------------|
| CorrelationIdMiddleware | ‚úÖ | X-Request-ID tracking |
| RequestLoggingMiddleware | ‚úÖ | Request duration logging |
| LogContextFilter | ‚úÖ | Context injection |

### B5: DRF Exception Handler

| Task | Status | Description |
|------|--------|-------------|
| custom_exception_handler | ‚úÖ | Logging all exceptions |
| ValidationError ‚Üí WARNING | ‚úÖ | User input errors |
| Unexpected ‚Üí ERROR | ‚úÖ | With stacktrace |
| Request ID in response | ‚úÖ | For tracing |

### B6-B7: WebSocket & Classroom Logging

| Task | Status | Description |
|------|--------|-------------|
| LoggingConsumerMixin | ‚úÖ | WebSocket logging |
| ClassroomLoggingMixin | ‚úÖ | Classroom events |
| Async/sync versions | ‚úÖ | Both supported |

### B8: Frontend Log API

| Task | Status | Description |
|------|--------|-------------|
| POST /logs/frontend/ | ‚úÖ | Single error |
| Batch support | ‚úÖ | Multiple errors |
| Rate limiting | ‚úÖ | 100/minute |
| Validation | ‚úÖ | Payload validation |

### B9: LogService

| Task | Status | Description |
|------|--------|-------------|
| log_backend_event | ‚úÖ | Backend logging |
| log_frontend_error | ‚úÖ | Frontend logging |
| log_classroom_event | ‚úÖ | Classroom logging |
| log_error | ‚úÖ | Error with exception |

### B10: Celery Tasks

| Task | Status | Description |
|------|--------|-------------|
| cleanup_old_logs | ‚úÖ | Delete old logs |
| export_logs_to_file | ‚úÖ | JSON export |
| generate_error_report | ‚úÖ | Statistics |

### B11: Admin Integration

| Task | Status | Description |
|------|--------|-------------|
| AppLogAdmin | ‚úÖ | Read-only admin |
| FrontendErrorAdmin | ‚úÖ | Read-only admin |
| Filters & search | ‚úÖ | Working |

---

## üìÅ FILE STRUCTURE

```
apps/diagnostics/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ apps.py
‚îú‚îÄ‚îÄ admin.py                    # Admin integration
‚îú‚îÄ‚îÄ models.py                   # AppLog, FrontendError
‚îú‚îÄ‚îÄ services.py                 # LogService, FrontendErrorService
‚îú‚îÄ‚îÄ middleware.py               # CorrelationId, RequestLogging
‚îú‚îÄ‚îÄ logging_config.py           # Centralized logging config
‚îú‚îÄ‚îÄ exception_handler.py        # DRF exception handler
‚îú‚îÄ‚îÄ websocket_logging.py        # WebSocket logging mixins
‚îú‚îÄ‚îÄ tasks.py                    # Celery tasks
‚îú‚îÄ‚îÄ urls.py                     # URL configuration
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py          # FrontendErrorSerializer
‚îÇ   ‚îî‚îÄ‚îÄ views.py                # FrontendLogView
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ test_models.py
    ‚îú‚îÄ‚îÄ test_services.py
    ‚îú‚îÄ‚îÄ test_middleware.py
    ‚îî‚îÄ‚îÄ test_frontend_log_api.py
```

---

## üîå NEW API ENDPOINTS

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/logs/frontend/` | Log frontend error(s) |
| GET | `/api/v1/health/` | Health check |

### Frontend Error Request
```json
{
    "severity": "error",
    "message": "Cannot read property 'x' of undefined",
    "stack": "Error: ...\n  at Component.vue:123",
    "url": "/classroom/abc-123",
    "browser": "Chrome 120",
    "platform": "Windows",
    "app_version": "v0.24.4+abc123",
    "context": {
        "component": "LessonRoom",
        "route": "classroom/:sessionId"
    }
}
```

### Batch Request
```json
{
    "errors": [
        {"severity": "error", "message": "Error 1", "url": "/page1"},
        {"severity": "warning", "message": "Warning 1", "url": "/page2"}
    ]
}
```

---

## üîß SERVICES

### LogService
```python
LogService.log_backend_event(level, service, message, user_id, session_id, request_id, extra)
LogService.log_frontend_error(data, user)
LogService.log_classroom_event(event_type, session_id, user_id, message, extra)
LogService.log_error(service, message, exception, user_id, request_id, extra)
```

### FrontendErrorService
```python
FrontendErrorService.get_recent_errors(limit, severity, user_id, app_version)
FrontendErrorService.get_error_stats(days)
FrontendErrorService.get_errors_by_url(days, limit)
FrontendErrorService.get_errors_by_version(days)
```

### AppLogService
```python
AppLogService.get_recent_logs(limit, level, service, user_id, session_id)
AppLogService.get_error_logs(limit)
AppLogService.get_session_logs(session_id)
```

---

## üîó MIDDLEWARE

### CorrelationIdMiddleware
- Generates or uses existing `X-Request-ID`
- Adds to request object: `request.request_id`
- Adds to response headers
- Stores in thread-local for logging

### RequestLoggingMiddleware
- Logs request method, path, status, duration
- Skips health, static, media paths
- ERROR for 5xx, WARNING for 4xx, DEBUG for success

---

## üìä MODELS

### AppLog
```python
class AppLog(models.Model):
    timestamp = DateTimeField(auto_now_add=True)
    level = CharField(choices=Level.choices)  # DEBUG, INFO, WARNING, ERROR, CRITICAL
    service = CharField(choices=Service.choices)  # core, api, classroom, webrtc, etc.
    user = ForeignKey(User, null=True)
    session_id = CharField(max_length=100)
    request_id = CharField(max_length=100)
    message = TextField()
    extra = JSONField()
```

### FrontendError
```python
class FrontendError(models.Model):
    timestamp = DateTimeField(auto_now_add=True)
    user = ForeignKey(User, null=True)
    session_id = CharField(max_length=100)
    severity = CharField(choices=Severity.choices)  # info, warning, error
    message = TextField()
    stack = TextField()
    url = CharField(max_length=500)
    browser = CharField(max_length=200)
    platform = CharField(max_length=100)
    app_version = CharField(max_length=50)
    context = JSONField()
```

---

## üß™ TESTING

```
apps/diagnostics/tests/
‚îú‚îÄ‚îÄ test_models.py           # 8 tests
‚îú‚îÄ‚îÄ test_services.py         # 10 tests
‚îú‚îÄ‚îÄ test_middleware.py       # 5 tests
‚îî‚îÄ‚îÄ test_frontend_log_api.py # 6 tests
```

---

## üìà METRICS

| Metric | Value |
|--------|-------|
| New files | 15 |
| Lines of code | ~1200 |
| New models | 2 |
| New API endpoints | 2 |
| Celery tasks | 3 |
| Unit tests | 29 |

---

## üîó INTEGRATION

### settings.py
```python
INSTALLED_APPS = [
    # ...
    'apps.diagnostics',
]

MIDDLEWARE = [
    'apps.diagnostics.middleware.CorrelationIdMiddleware',
    'apps.diagnostics.middleware.RequestLoggingMiddleware',
    # ...
]

REST_FRAMEWORK = {
    'EXCEPTION_HANDLER': 'apps.diagnostics.exception_handler.custom_exception_handler',
}

# Import logging config
from apps.diagnostics.logging_config import LOGGING
```

### urls.py
```python
urlpatterns = [
    path('api/v1/', include('apps.diagnostics.urls')),
]
```

### Celery beat
```python
CELERY_BEAT_SCHEDULE = {
    'cleanup-old-logs': {
        'task': 'diagnostics.cleanup_old_logs',
        'schedule': crontab(hour=3, minute=0),
        'args': (30,),
    },
}
```

---

## ‚úÖ DEFINITION OF DONE

- [x] B1: Logging config
- [x] B2: Models AppLog + FrontendError
- [x] B3-B4: Middleware
- [x] B5: DRF Exception Handler
- [x] B6-B7: WebSocket & Classroom Logging
- [x] B8: Frontend Log API
- [x] B9: LogService
- [x] B10: Celery Tasks
- [x] B11: Admin Integration
- [x] B12: Tests
- [ ] Migrations (pending)
- [ ] Settings integration (pending)

---

## üöÄ NEXT STEPS

1. Add `apps.diagnostics` to `INSTALLED_APPS`
2. Add middleware to `MIDDLEWARE`
3. Set exception handler in `REST_FRAMEWORK`
4. Run migrations: `python manage.py makemigrations diagnostics && python manage.py migrate`
5. Add URL to main urls.py
6. Configure Celery beat schedule

---

*M4SH Platform v0.24.4 ‚Äî Backend Implementation Report*
