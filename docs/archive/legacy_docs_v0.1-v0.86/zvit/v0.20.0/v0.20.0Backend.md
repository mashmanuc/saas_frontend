# v0.20.0 Backend ‚Äî –ó–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

**–î–∞—Ç–∞:** 12.12.2025  
**–í–µ—Ä—Å—ñ—è:** v0.20.0  
**–ú–æ–¥—É–ª—å:** Marketplace Search & Filters

---

## üìã –í–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### TASK B1: SearchLog Model ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/models/search_log.py`

–°—Ç–≤–æ—Ä–µ–Ω–æ –º–æ–¥–µ–ª—å –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤:
- –ü–æ–ª—è: `user`, `session_key`, `query`, `filters` (JSON), `results_count`
- –¢—Ä–µ–∫—ñ–Ω–≥ –∫–ª—ñ–∫—ñ–≤: `clicked_profile_id`, `clicked_position`
- –ú–µ—Ç–∞–¥–∞–Ω—ñ: `source`, `response_time_ms`
- –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –∑–∞–ø–∏—Ç—ñ–≤

---

### TASK B2: Category Model ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/models/category.py`

–°—Ç–≤–æ—Ä–µ–Ω–æ –º–æ–¥–µ–ª—ñ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:

**SubjectCategory:**
- –ü–æ–ª—è: `name`, `slug`, `icon`, `color`, `description`
- Ordering —Ç–∞ visibility: `order`, `is_active`, `is_featured`
- –î–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π `tutor_count`

**Subject:**
- –ó–≤'—è–∑–æ–∫ –∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—î—é —á–µ—Ä–µ–∑ FK
- –ü–æ–ª—è: `name`, `slug`, `aliases` (JSON), `available_levels` (JSON)
- –î–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π `tutor_count`

**Seed Data:**
- 5 –∫–∞—Ç–µ–≥–æ—Ä—ñ–π: Languages, Sciences, Business, Arts & Music, Test Preparation
- 25 –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –∑ aliases

---

### TASK B3: Search Service ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/services/search_service.py`

–ü–æ–≤–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–∏–π –ø–æ—à—É–∫ –∑ PostgreSQL FTS:
- `SearchFilters` dataclass –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
- `SearchResult` dataclass –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
- –ú–µ—Ç–æ–¥–∏:
  - `search()` ‚Äî –æ—Å–Ω–æ–≤–Ω–∏–π –ø–æ—à—É–∫ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ —Ç–∞ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é
  - `get_suggestions()` ‚Äî –∞–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç
- PostgreSQL SearchVector + TrigramSimilarity
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è: relevance, rating, price, lessons

---

### TASK B4: Filter Service ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/services/filter_service.py`

–°–µ—Ä–≤—ñ—Å –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–ø—Ü—ñ–π —Ñ—ñ–ª—å—Ç—Ä—ñ–≤:
- `get_all_options()` ‚Äî –≤—Å—ñ –æ–ø—Ü—ñ—ó –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º
- `get_categories()` ‚Äî –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç—å—é—Ç–æ—Ä—ñ–≤
- `get_subjects()` ‚Äî –ø—Ä–µ–¥–º–µ—Ç–∏ –∑–≥—Ä—É–ø–æ–≤–∞–Ω—ñ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö
- `get_countries()` ‚Äî –∫—Ä–∞—ó–Ω–∏ –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç—å—é—Ç–æ—Ä—ñ–≤
- `get_languages()` ‚Äî –º–æ–≤–∏ –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç—å—é—Ç–æ—Ä—ñ–≤
- `get_price_range()` ‚Äî min/max/avg —Ü—ñ–Ω–∏
- `invalidate_cache()` ‚Äî —ñ–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–µ—à—É

---

### TASK B5: Recommendation Service ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/services/recommendation_service.py`

–°–µ—Ä–≤—ñ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π:
- `get_popular_tutors()` ‚Äî –ø–æ–ø—É–ª—è—Ä–Ω—ñ –∑–∞ —Ñ–æ—Ä–º—É–ª–æ—é popularity_score
- `get_new_tutors()` ‚Äî –Ω–æ–≤—ñ —Ç—å—é—Ç–æ—Ä–∏ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ N –¥–Ω—ñ–≤
- `get_featured_tutors()` ‚Äî –≤–∏–±—Ä–∞–Ω—ñ —Ç—å—é—Ç–æ—Ä–∏
- `get_recommended_for_user()` ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ—à—É–∫—É
- `get_similar_tutors()` ‚Äî —Å—Ö–æ–∂—ñ —Ç—å—é—Ç–æ—Ä–∏ –∑–∞ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
- `get_tutors_by_subject()` ‚Äî —Ç—å—é—Ç–æ—Ä–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
- `get_tutors_by_category()` ‚Äî —Ç—å—é—Ç–æ—Ä–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
- `update_popularity_scores()` ‚Äî –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∫–æ—Ä—ñ–≤ (–¥–ª—è cron)

---

### TASK B6: Analytics Service ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/services/analytics_service.py`

–°–µ—Ä–≤—ñ—Å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ø–æ—à—É–∫—É:
- `log_search()` ‚Äî –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
- `log_click()` ‚Äî –ª–æ–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ–∫—É –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `get_popular_queries()` ‚Äî –ø–æ–ø—É–ª—è—Ä–Ω—ñ –∑–∞–ø–∏—Ç–∏
- `get_popular_filters()` ‚Äî –ø–æ–ø—É–ª—è—Ä–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
- `get_click_through_rate()` ‚Äî CTR
- `get_avg_response_time()` ‚Äî —Å–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- `get_zero_result_queries()` ‚Äî –∑–∞–ø–∏—Ç–∏ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
- `get_search_stats()` ‚Äî –∑–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

### TASK B7: API Filters ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/api/filters.py`

Django REST Framework —Ñ—ñ–ª—å—Ç—Ä–∏:
- `TutorSearchFilter` ‚Äî FilterSet –¥–ª—è –ø–æ—à—É–∫—É —Ç—å—é—Ç–æ—Ä—ñ–≤
- –§—ñ–ª—å—Ç—Ä–∏: q, subject, category, country, language, min_price, max_price, min_rating, min_experience, has_video, is_verified
- `SubjectFilter` ‚Äî FilterSet –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤

---

### TASK B8: Search Indexer ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/search/indexer.py`

–Ü–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä –¥–ª—è –ø–æ—à—É–∫—É:
- `index_tutor()` ‚Äî —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—è –æ–¥–Ω–æ–≥–æ —Ç—å—é—Ç–æ—Ä–∞
- `reindex_all()` ‚Äî –ø–µ—Ä–µ—ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—è –≤—Å—ñ—Ö
- `update_subject_counts()` ‚Äî –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç—å—é—Ç–æ—Ä—ñ–≤ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞—Ö

---

### TASK B9: Query Builder ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/search/query_builder.py`

–ü–∞—Ä—Å–µ—Ä –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤:
- `SearchQuery` dataclass –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é:
  - –ü—Ä–æ—Å—Ç–∏—Ö —Ç–µ—Ä–º—ñ–Ω—ñ–≤: `math tutor`
  - –¢–æ—á–Ω–∏—Ö —Ñ—Ä–∞–∑: `"english teacher"`
  - –í–∏–∫–ª—é—á–µ–Ω—å: `-beginner`
- `QueryBuilder` ‚Äî –ø–æ–±—É–¥–æ–≤–∞ Django Q –æ–±'—î–∫—Ç—ñ–≤

---

### TASK B10: Search Backend (PostgreSQL) ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/search/backends/postgres.py`

PostgreSQL Full-Text Search backend:
- SearchVector + SearchQuery + SearchRank
- TrigramSimilarity –¥–ª—è fuzzy matching
- –ö–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π relevance score
- –ê–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç suggestions

---

### TASK B11: Reindex Command ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/management/commands/reindex_tutors.py`

Management command:
```bash
python manage.py reindex_tutors --batch-size=100 --update-counts
```

---

### TASK B12: Update Popularity Command ‚úÖ
**–§–∞–π–ª:** `apps/marketplace/management/commands/update_popularity.py`

Management command –¥–ª—è cron:
```bash
python manage.py update_popularity
```

---

### TASK B13: API Endpoints Update ‚úÖ

**–ù–æ–≤—ñ endpoints:**

| Method | URL | –û–ø–∏—Å |
|--------|-----|------|
| GET | `/api/v1/marketplace/search/` | Full-text search |
| GET | `/api/v1/marketplace/search/suggestions/` | Autocomplete |
| POST | `/api/v1/marketplace/search/log-click/` | Log click |
| GET | `/api/v1/marketplace/filters/` | Filter options |
| GET | `/api/v1/marketplace/categories/` | Subject categories |
| GET | `/api/v1/marketplace/categories/{slug}/` | Category detail |
| GET | `/api/v1/marketplace/categories/{slug}/tutors/` | Tutors by category |
| GET | `/api/v1/marketplace/tutors/popular/` | Popular tutors |
| GET | `/api/v1/marketplace/tutors/new/` | New tutors |
| GET | `/api/v1/marketplace/tutors/recommended/` | Personalized (auth) |
| GET | `/api/v1/marketplace/tutors/{slug}/similar/` | Similar tutors |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
apps/marketplace/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py (updated)
‚îÇ   ‚îú‚îÄ‚îÄ search_log.py (new)
‚îÇ   ‚îî‚îÄ‚îÄ category.py (new)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py (updated)
‚îÇ   ‚îú‚îÄ‚îÄ search_service.py (new)
‚îÇ   ‚îú‚îÄ‚îÄ filter_service.py (new)
‚îÇ   ‚îú‚îÄ‚îÄ recommendation_service.py (new)
‚îÇ   ‚îî‚îÄ‚îÄ analytics_service.py (new)
‚îú‚îÄ‚îÄ search/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py (new)
‚îÇ   ‚îú‚îÄ‚îÄ indexer.py (new)
‚îÇ   ‚îú‚îÄ‚îÄ query_builder.py (new)
‚îÇ   ‚îî‚îÄ‚îÄ backends/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py (new)
‚îÇ       ‚îî‚îÄ‚îÄ postgres.py (new)
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ views.py (updated)
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py (updated)
‚îÇ   ‚îî‚îÄ‚îÄ filters.py (new)
‚îú‚îÄ‚îÄ management/commands/
‚îÇ   ‚îú‚îÄ‚îÄ reindex_tutors.py (new)
‚îÇ   ‚îú‚îÄ‚îÄ update_popularity.py (new)
‚îÇ   ‚îî‚îÄ‚îÄ seed_categories.py (new)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_search_service.py (new)
‚îÇ   ‚îî‚îÄ‚îÄ test_recommendation_service.py (new)
‚îú‚îÄ‚îÄ admin.py (updated)
‚îî‚îÄ‚îÄ urls.py (updated)
```

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```
29 passed in 15.20s
```

**–¢–µ—Å—Ç–∏:**
- `test_search_service.py` ‚Äî 9 —Ç–µ—Å—Ç—ñ–≤
- `test_recommendation_service.py` ‚Äî 7 —Ç–µ—Å—Ç—ñ–≤
- `test_profiles.py` ‚Äî 7 —Ç–µ—Å—Ç—ñ–≤
- `test_badges.py` ‚Äî 6 —Ç–µ—Å—Ç—ñ–≤

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | Target | Actual |
|---------|--------|--------|
| New models | 3 | 3 ‚úÖ |
| New services | 4 | 4 ‚úÖ |
| New API endpoints | 9 | 11 ‚úÖ |
| Management commands | 2 | 3 ‚úÖ |
| Test coverage | >75% | ~80% ‚úÖ |

---

## üóÉÔ∏è –ú—ñ–≥—Ä–∞—Ü—ñ—ó

```
0002_subjectcategory_subject_searchlog.py
```

---

## üå± Seed Data

```bash
python manage.py seed_categories
# Seeded 5 categories and 25 subjects
```

---

## ‚úÖ Definition of Done

- [x] B1-B13 completed
- [x] PostgreSQL FTS working
- [x] All filters working
- [x] Recommendations working
- [x] Analytics logging
- [x] Unit tests > 75%
- [x] Migrations ready
- [x] –ú–∞–Ω—ñ—Ñ–µ—Å—Ç compliance ‚úÖ

---

*M4SH Platform v0.20.0 ‚Äî Backend Implementation Report*
