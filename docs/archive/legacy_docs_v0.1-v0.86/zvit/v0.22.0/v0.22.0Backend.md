# v0.22.0 Backend ‚Äî –ó–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

**–î–∞—Ç–∞:** 12.12.2025  
**–í–µ—Ä—Å—ñ—è:** v0.22.0  
**–ú–æ–¥—É–ª—å:** Ratings & Reviews

---

## üìã –í–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### B1: Review Model ‚úÖ
**–§–∞–π–ª:** `apps/reviews/models/review.py`

**Review:**
- OneToOne –∑ Booking (anti-spam: 1 review = 1 lesson)
- Rating 1-5 stars
- Detailed ratings: communication, knowledge, punctuality
- Moderation: pending, approved, rejected, hidden
- Anonymous option
- Helpful votes counter

**ReviewResponse:**
- OneToOne –∑ Review
- Auto-approve for tutor responses

**ReviewHelpful:**
- Track helpful votes
- Unique per user per review

---

### B2: TutorRating Model ‚úÖ
**–§–∞–π–ª:** `apps/reviews/models/rating.py`

- Aggregated statistics (denormalized)
- `average_rating`, `total_reviews`
- Distribution: `rating_1_count` ... `rating_5_count`
- Detailed averages: communication, knowledge, punctuality
- `response_rate` ‚Äî % reviews with tutor response

---

### B3: Moderation Models ‚úÖ
**–§–∞–π–ª:** `apps/reviews/models/moderation.py`

**ReviewReport:**
- Reasons: spam, offensive, fake, irrelevant, other
- Resolution tracking

**BannedWord:**
- Severity levels: low (flag), medium (reject), high (block)
- Regex support
- Active/inactive toggle

---

### B4: Review Service ‚úÖ
**–§–∞–π–ª:** `apps/reviews/services/review_service.py`

Methods:
- `can_review()` ‚Äî check eligibility
- `create_review()` ‚Äî with moderation check
- `update_review()` ‚Äî within 24h
- `delete_review()` ‚Äî soft delete (hide)
- `get_tutor_reviews()` ‚Äî with sorting & pagination
- `get_student_reviews()`
- `respond_to_review()` / `update_response()`
- `mark_helpful()` / `unmark_helpful()`

---

### B5: Rating Service ‚úÖ
**–§–∞–π–ª:** `apps/reviews/services/rating_service.py`

Methods:
- `get_rating()` ‚Äî get or create
- `recalculate_rating()` ‚Äî full recalculation
- `get_rating_summary()` ‚Äî for display
- `bulk_recalculate()` ‚Äî batch update
- `get_top_rated_tutors()`

---

### B6: Moderation Service ‚úÖ
**–§–∞–π–ª:** `apps/reviews/services/moderation_service.py`

Methods:
- `check_content()` ‚Äî banned word detection
- `moderate_review()` ‚Äî approve/reject
- `report_review()` ‚Äî create report
- `resolve_report()` ‚Äî handle report
- `get_pending_reviews()` / `get_pending_reports()`
- `auto_moderate()` ‚Äî automatic moderation
- `add_banned_word()` / `remove_banned_word()`

---

### B7: Analytics Service ‚úÖ
**–§–∞–π–ª:** `apps/reviews/services/analytics_service.py`

Methods:
- `get_tutor_analytics()` ‚Äî dashboard data
  - Rating trend (6 months)
  - Sentiment breakdown
  - Top keywords
  - Average response time
- `get_platform_analytics()` ‚Äî admin stats

---

### B8: Serializers & Permissions ‚úÖ

**Serializers:**
- `ReviewSerializer` / `ReviewListSerializer`
- `ReviewCreateSerializer` / `ReviewUpdateSerializer`
- `ReviewResponseSerializer`
- `TutorRatingSerializer` / `RatingSummarySerializer`
- `ReviewReportSerializer`

**Permissions:**
- `CanReview` ‚Äî students with completed lessons
- `IsReviewAuthor` ‚Äî for edit/delete
- `IsTutorOfReview` ‚Äî for responding
- `IsModerator` ‚Äî for moderation

---

### B9: API Views ‚úÖ
**–§–∞–π–ª:** `apps/reviews/api/views.py`

**Endpoints:**

| Method | URL | –û–ø–∏—Å |
|--------|-----|------|
| GET | `/api/reviews/can-review/{tutor_id}/` | Check eligibility |
| POST | `/api/reviews/` | Create review |
| GET | `/api/reviews/` | My reviews |
| GET | `/api/reviews/{id}/` | Review detail |
| PATCH | `/api/reviews/{id}/` | Update review |
| DELETE | `/api/reviews/{id}/` | Delete review |
| GET | `/api/reviews/tutor/{tutor_id}/` | Tutor reviews |
| POST | `/api/reviews/{id}/respond/` | Tutor respond |
| PATCH | `/api/reviews/{id}/respond/` | Update response |
| POST | `/api/reviews/{id}/helpful/` | Mark helpful |
| DELETE | `/api/reviews/{id}/helpful/` | Unmark helpful |
| POST | `/api/reviews/{id}/report/` | Report review |
| GET | `/api/ratings/{tutor_id}/` | Tutor rating |
| GET | `/api/ratings/{tutor_id}/summary/` | Rating summary |

---

### B10: Signals ‚úÖ
**–§–∞–π–ª:** `apps/reviews/signals.py`

- `post_save(Review)` ‚Üí recalculate TutorRating
- `post_delete(Review)` ‚Üí recalculate TutorRating
- `post_save(ReviewResponse)` ‚Üí update response_rate, notify student
- `post_save(Booking, status=completed)` ‚Üí send review request

---

### B11: Celery Tasks ‚úÖ
**–§–∞–π–ª:** `apps/reviews/tasks.py`

Tasks:
- `send_review_request` ‚Äî email after lesson
- `send_review_response_notification` ‚Äî notify student
- `recalculate_all_ratings` ‚Äî weekly batch
- `cleanup_old_reports` ‚Äî monthly cleanup
- `auto_moderate_pending` ‚Äî hourly auto-moderation

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
apps/reviews/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ review.py           # Review, ReviewResponse, ReviewHelpful
‚îÇ   ‚îú‚îÄ‚îÄ rating.py           # TutorRating
‚îÇ   ‚îî‚îÄ‚îÄ moderation.py       # ReviewReport, BannedWord
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ review_service.py
‚îÇ   ‚îú‚îÄ‚îÄ rating_service.py
‚îÇ   ‚îú‚îÄ‚îÄ moderation_service.py
‚îÇ   ‚îî‚îÄ‚îÄ analytics_service.py
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ permissions.py
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py
‚îÇ   ‚îî‚îÄ‚îÄ views.py
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_review.py
‚îÇ   ‚îú‚îÄ‚îÄ test_rating.py
‚îÇ   ‚îî‚îÄ‚îÄ test_moderation.py
‚îú‚îÄ‚îÄ admin.py
‚îú‚îÄ‚îÄ apps.py
‚îú‚îÄ‚îÄ signals.py
‚îú‚îÄ‚îÄ tasks.py
‚îî‚îÄ‚îÄ urls.py
```

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```
22 passed in 17.86s
```

**–¢–µ—Å—Ç–∏:**
- `test_review.py` ‚Äî 8 —Ç–µ—Å—Ç—ñ–≤
- `test_rating.py` ‚Äî 5 —Ç–µ—Å—Ç—ñ–≤
- `test_moderation.py` ‚Äî 9 —Ç–µ—Å—Ç—ñ–≤

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | Target | Actual |
|---------|--------|--------|
| New models | 5 | 6 ‚úÖ |
| New services | 4 | 4 ‚úÖ |
| New API endpoints | 14 | 14 ‚úÖ |
| Celery tasks | 4 | 5 ‚úÖ |
| Test coverage | >75% | ~80% ‚úÖ |

---

## üóÉÔ∏è –ú—ñ–≥—Ä–∞—Ü—ñ—ó

```
0001_initial.py
- Create model BannedWord
- Create model Review
- Create model ReviewHelpful
- Create model ReviewReport
- Create model ReviewResponse
- Create model TutorRating
- Create indexes
```

---

## ‚úÖ Definition of Done

- [x] B1-B11 completed
- [x] Review CRUD working
- [x] Rating aggregation working
- [x] Moderation system working
- [x] Anti-spam (1 review = 1 booking)
- [x] Unit tests > 75%
- [x] API documentation
- [x] –ú–∞–Ω—ñ—Ñ–µ—Å—Ç compliance ‚úÖ

---

*M4SH Platform v0.22.0 ‚Äî Backend Implementation Report*
