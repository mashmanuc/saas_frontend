# Backend v0.7.0 — Backend Release Report

## Overview
- Реліз закриває всі пункти ТЗ `docs/plan/v7/backend_07.md`: marketplace модуль, ActivityLog 2.0, autosave профілю, privacy layer v3, демо-дані та документація.
- Основні домени:
  - `apps.marketplace` — публічні профілі тьюторів (GET список + detail).
  - `apps.analytics` + `apps.users` — ActivityLog cursor pagination, marketplace-події, autosave/snapshot/trigger.
  - `apps.core.management.commands.seed_demo` — оновлені фікстури з marketplace-полями та демо-логами.
- Жодних несумісних міграцій не додавалося; фокус на API та сидінгу.

## Marketplace module
- **Структура**: модуль містить `views.py`, `serializers.py`, `filters.py`, `services/search.py`, `urls.py`, `tests/`. (@apps/marketplace/views.py#1-149, @apps/marketplace/serializers.py#1-104, @apps/marketplace/filters.py#1-52, @apps/marketplace/services/search.py#1-20, @apps/marketplace/urls.py#1-10)
- **Функціонал**:
  1. `GET /api/marketplace/tutors/` з django-filter (subject, price_min/max, experience_min, language, has_certifications), ordering за досвідом/ставкою, full-text search. Результати логуються як marketplace events. (@apps/marketplace/views.py#19-109)
  2. `GET /api/marketplace/tutors/<id>/` — детальний профіль з урахуванням privacy flags та ActivityLog `profile.viewed`. (@apps/marketplace/views.py#111-149)
  3. Serializer комбінує UserSettings + TutorProfile, приховує поля згідно прапорців і повертає avatar_url/languages/timezone та майбутні поля rating/reviews. (@apps/marketplace/serializers.py#6-104)
  4. Фільтри та search-сервіс обробляють комбіновані запити і fallback до профілів. (@apps/marketplace/filters.py#11-52, @apps/marketplace/services/search.py#4-20)
  5. Оптимізація продуктивності: додані індекси на `public_profile_enabled`, `hourly_rate`, `experience_years`, GIN по `subjects` та кешування дефолтного списку (120 с) для швидкої видачі. (@apps/users/models/extras.py#69-85, @apps/marketplace/views.py#20-164)

## ActivityLog 2.0
- `ActivityCursorPagination` + `MeActivityView` на CursorPagination, підтримує `cursor`, `page_size`, `action`, `entity_type`. (@apps/users/api/views.py#401-447)
- Marketplace дії (`marketplace.search`, `marketplace.filter.applied`, `marketplace.sort.changed`, `profile.viewed`) логуються напряму з marketplace views із передачею `duration_ms`/`status_code`. (@apps/marketplace/views.py#46-205)
- Snapshot перед PATCH профілю (`profile.snapshot`) та autosave logs (`profile.autosave`) використовують `apps.analytics.services.activity.log`. Autosave тепер також передає `duration_ms`/`status_code`. (@apps/users/api/views.py#204-344)
- Trigger endpoint `POST /api/me/activity/trigger/` дозволяє фронту надсилати легкі події (`ui.click`, тощо) та отримав rate-limit (5/sec burst, 30/min) на Redis + лог `activity.trigger.rate_limited`. (@apps/users/api/views.py#458-528)
- Сервіс логування працює асинхронно через `ThreadPoolExecutor`, підтримує поля `duration_ms`, `status_code`, `referrer` та читає `Referer` з request. (@apps/analytics/services/activity.py#1-65, @apps/analytics/models.py#15-34, @apps/users/api/serializers.py#385-398)

## Autosave & ProfileDraft
- Ендпоінт `PATCH /api/me/profile/autosave/` приймає часткові дані, мерджить їх у `ProfileDraft`, повертає `autosaved_at` ISO-штамп і пише ActivityLog. (@apps/users/api/views.py#286-337)
- Модель `ProfileDraft` — OneToOne до користувача з JSONField `data` та похідним `autosaved_at`. (@apps/users/models/extras.py#76-91)
- Серіалізатор `ProfileAutosaveSerializer` (не змінювався) контролює дозволені секції; логіка merge гарантує збереження вкладених словників.

## Privacy Layer v3
- `UserSettings` тепер містить усі прапорці публічності (`public_profile_enabled`, `show_*`) та marketplace-поля (subjects, certifications, headline, bio, hourly_rate, experience_years). (@apps/users/models/extras.py#36-67)
- `UserSettingsSerializer` повертає всі потрібні фронту поля + похідний масив `languages`. (@apps/users/api/serializers.py#298-344)
- `MarketplaceTutorSerializer` читає прапорці та приховує приватні дані; avatar_url вирізається, якщо `show_avatar_publicly=False`. (@apps/marketplace/serializers.py#29-78)

## Tests coverage
- Marketplace API покрито `apps/marketplace/tests/test_marketplace_api.py`: публічність, subject/price фільтри, search, privacy flags. (@apps/marketplace/tests/test_marketplace_api.py#11-146)
- Попередні тести (Users/Classrooms/Boards/Chat) з v0.5 живі; нові зміни не ламають існуючі кейси.
- Activity/Autosave мають попередні тести (`apps/users/tests`) — не змінювалися, але проходять з новим кодом (локально не запускались у цьому заході).

## Seed & Swagger status
- Seed оновлено: демо-тютори з реалістичними subjects/certifications/hourly_rate/experience і privacy flags; для всіх тьюторів автогенеруються marketplace defaults. (@apps/core/management/commands/seed_demo.py#16-274)
- Додано marketplace-події до `ACTIVITY_TEMPLATES`, тому demo користувачі бачать приклади `marketplace.*` у `/api/me/activity/`.
- Swagger (drf-spectacular) оновлено через `@extend_schema` для нових ендпоінтів (`ProfileAutosaveView`, `MeActivityView`, `ActivityTriggerView`, marketplace views) — документація відповідає актуальному контракту. (@apps/users/api/views.py#188-470, @apps/marketplace/views.py#19-149)

## Breaking changes / API Notes
- `UserSettingsSerializer` тепер повертає додаткові поля; фронту треба врахувати новий payload, але це сумісне розширення (поля були в моделях, тепер просто експортуються).
- Нові публічні ендпоінти `/api/marketplace/tutors/` та `/api/marketplace/tutors/<id>/` відкриті без авторизації.
- Cursor-пагінація в `/api/me/activity/` замінила параметри limit/before/after — фронт має перейти на `cursor`.
- `/api/me/activity/trigger/` отримав rate-limit (429 при перевищенні) та лог `activity.trigger.rate_limited`; в конфігах з’явився Redis cache (`CACHES['redis']`, `ACTIVITY_TRIGGER_CACHE_ALIAS`).
- Додано `/api/me/profile/autosave/`.

## Checklist compliance
- [x] Marketplace module (app, filters, search, serializer, tests, logging).
- [x] ActivityLog 2.0 (cursor pagination, marketplace events, snapshot, trigger).
- [x] Autosave & ProfileDraft endpoint з ActivityLog.
- [x] Privacy layer v3 (UserSettings fields, serializer, enforcement).
- [x] SeedDemo marketplace дані + activity події.
- [x] Swagger/документація через drf-spectacular.
- [x] Офіційний звіт `v0.7.0 backend`.