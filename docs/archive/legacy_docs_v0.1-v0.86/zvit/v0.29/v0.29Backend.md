# v0.29 Backend ‚Äî Solo Workspace: Stealth Autosave Report

**–í–µ—Ä—Å—ñ—è:** 0.29  
**–†–æ–ª—å:** Backend Developer  
**–î–∞—Ç–∞:** 13.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìã SUMMARY

–í–∏–∫–æ–Ω–∞–Ω–æ Stealth Autosave roadmap –¥–ª—è Solo Workspace. –î–æ–¥–∞–Ω–æ diff-save –∑ –∞—Ç–æ–º–∞—Ä–Ω–∏–º–∏ —Ä–µ–≤—ñ–∑—ñ—è–º–∏, —Å—Ç—Ä–∏–º/–±—ñ–∫–æ–Ω —Å–µ–π–≤–∏, production-ready –µ–∫—Å–ø–æ—Ä—Ç, backoff/–∫–≤–æ—Ç–∏, R2/S3 –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è, —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—é, —É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω—ñ WS/Auth –ø—Ä–∞–≤–∏–ª–∞, —ñ–Ω–¥–µ–∫—Å–∏ —Ç–∞ –ø–æ–≤–Ω–∏–π –Ω–∞–±—ñ—Ä pytest.

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–Ü –ó–ê–í–î–ê–ù–ù–Ø

### BE29-1: Diff-Save API
- `PATCH /api/v1/solo/sessions/{id}/diff/` –∑ optimistic locking (`If-Match` / `X-Rev`).
- `SoloDiffSaveSerializer`, `SoloDiffService`, SHA256 digest, journaling –≤ `LogService`.
- –û–±–º–µ–∂–µ–Ω–Ω—è 512 KB, 409/422/413 –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ, ETag –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.

### BE29-2: Beacon/Stream Save
- `POST /save-stream/` –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä—ñ–≤ (2 MB limit, optional rev check).
- `POST /beacon/` –¥–ª—è `navigator.sendBeacon` (64 KB limit, heartbeat update).
- –ù–æ–≤—ñ throttles `SoloSaveStreamThrottle`, `SoloBeaconThrottle`.

### BE29-3: Export Polling Hardening
- –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ `Idempotency-Key`.
- TTL `expires_at`, `idempotency_key` –≤ –º–æ–¥–µ–ª—ñ, signed CDN URLs —É `SoloExportSerializer`.
- 413 –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö state (>10 MB), —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π polling responses.

### BE29-4: 429/Backoff + –ö–≤–æ—Ç–∏
- `BackoffThrottleMixin`, `QuotaLimitMixin` (MAX_OPS=100, payload limits).
- –ù–æ–≤–∏–π `SoloDiffThrottle`; 422 `ops_quota_exceeded`, 413 payload guard.
- `Retry-After`, `X-Backoff-Ms`, `X-RateLimit-*` headers.

### BE29-5: R2/S3 Versioned Storage + CORS
- `S3StorageBackend` –∑ R2 endpoint, CDN domain, versioned uploads.
- `SoloStorageService.upload_state_versioned()` -> `solo/{user}/{session}/{rev}.json`.
- `CdnService` –æ–Ω–æ–≤–ª–µ–Ω–æ –∑ CORS headers, HMAC signing, signed URLs –¥–ª—è state/export/thumbnail.

### BE29-6: Telemetry Ingest
- `BoardMetric` –º–æ–¥–µ–ª—å (–≤–µ—Äc—ñ—ó, latency, extra JSON).
- `POST /api/v1/logs/board-metrics/` (single/batch), throttle 200/min, logging.
- Tests `test_board_metrics.py`.

### BE29-7: WS/Auth Unified Rules
- `JWTWebSocketAuthMixin` (Authorization header / Sec-WebSocket-Protocol, –∑–∞–±–æ—Ä–æ–Ω–∞ query token).
- `WebSocketPermissionMixin` –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é —Ä–æ–ª–µ–π –¥–ª—è consumer-—ñ–≤.

### BE29-8: –ú—ñ–≥—Ä–∞—Ü—ñ—ó —Ç–∞ –Ü–Ω–¥–µ–∫—Å–∏
- `solo.0006_v029_diff_rev_indexes` ‚Äî –¥–æ–¥–∞—î `rev`, `state_digest`, `last_write_at`, —ñ–Ω–¥–µ–∫—Å–∏ `(user,-updated_at)` —Ç–∞ `(id,rev)`, idempotency/TTL –ø–æ–ª—è —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è `SoloExport`.
- `diagnostics.0002_boardmetric` ‚Äî –º–æ–¥–µ–ª—å —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏.

### BE29-9: Pytest Suite
- `test_diff_save.py` (happy/mismatch/invalid/413).
- `test_stream_save.py`, `test_backoff.py`, `test_export_polling.py`, `test_board_metrics.py`.

---

## üìÅ –ù–û–í–Ü –§–ê–ô–õ–ò

```
apps/solo/api/mixins.py
apps/solo/tests/test_stream_save.py
apps/solo/tests/test_backoff.py
apps/solo/tests/test_export_polling.py
apps/diagnostics/tests/test_board_metrics.py
apps/solo/migrations/0006_v029_diff_rev_indexes.py
apps/diagnostics/migrations/0002_boardmetric.py
```

---

## üìù –ö–õ–Æ–ß–û–í–Ü –ó–ú–Ü–ù–ò

| –§–∞–π–ª | –ö–æ—Ä–æ—Ç–∫–æ |
|------|---------|
| `apps/solo/api/views.py` | –ù–æ–≤—ñ stream/beacon endpoints, diff throttling/quotas, idempotent export |
| `apps/solo/api/serializers.py` | Diff ops serializer, export serializer –∑ signed URL |
| `apps/solo/services/solo.py` | Diff service, versioned export creation |
| `apps/solo/services/storage.py / cdn.py` | R2/S3 versioned upload, CDN CORS/signing |
| `apps/solo/throttling.py` | –ù–æ–≤—ñ throttles (stream/beacon/diff) |
| `apps/diagnostics/api/views.py` | BoardMetricsView |
| `apps/core/permissions.py` | WebSocket auth/permission mixins |

---

## üîó –ù–û–í–Ü/–û–ù–û–í–õ–ï–ù–Ü ENDPOINTS

| Method | Endpoint | Auth | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|----------|------|-------------|
| PATCH | `/api/v1/solo/sessions/{id}/diff/` | ‚úÖ | Diff-save (–æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è) |
| POST | `/api/v1/solo/sessions/{id}/save-stream/` | ‚úÖ | Worker-friendly full state upload |
| POST | `/api/v1/solo/sessions/{id}/beacon/` | ‚úÖ | sendBeacon keepalive/backup save |
| POST | `/api/v1/logs/board-metrics/` | Optional | HUD telemetry ingest |

---

## üóÑÔ∏è –ú–û–î–ï–õ–Ü / –ü–û–õ–Ø

### SoloSession (–æ–Ω–æ–≤–ª–µ–Ω–æ)
- `rev`, `state_digest`, `last_write_at` –∑ —ñ–Ω–¥–µ–∫—Å–∞–º–∏ –¥–ª—è diff-save.

### SoloExport (–æ–Ω–æ–≤–ª–µ–Ω–æ)
- `idempotency_key`, `expires_at`, —ñ–Ω–¥–µ–∫—Å–∏ `session+status`, `user+created_at`.

### BoardMetric (–Ω–æ–≤–∞)
```
id (BigAuto)
timestamp (auto_now_add, indexed)
user (FK nullable)
session_id (indexed)
version (indexed)
extra_draws_during_save / main_thread_block_ms / input_latency_ms / save_rtt_ms / overlay_copy_ms
extra (JSON)
```

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

```bash
# –ú—ñ–≥—Ä–∞—Ü—ñ—ó
python manage.py migrate solo
python manage.py migrate diagnostics

# –¢–µ—Å—Ç–∏: –≤–∞–∂–ª–∏–≤–æ
# manage.py test –∑–∞–ø—É—Å–∫–∞—î unittest/Django TestCase suite —ñ –ù–ï –∑–∞–ø—É—Å–∫–∞—î pytest —Ç–µ—Å—Ç–∏.
# –î–ª—è –ø–æ–≤–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ BE29 –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ pytest —á–µ—Ä–µ–∑ interpreter –∑ venv.

# Pytest (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ venv)
.venv\\Scripts\\python -m pytest -q

# Pytest (–æ—Å–Ω–æ–≤–Ω–µ)
pytest apps/solo/tests/test_diff_save.py -q
pytest apps/solo/tests/test_stream_save.py -q
pytest apps/solo/tests/test_backoff.py -q
pytest apps/solo/tests/test_export_polling.py -q
pytest apps/diagnostics/tests/test_board_metrics.py -q
```

### Debug Note (pytest 500 –Ω–∞ Solo endpoints)

–ü—ñ–¥ —á–∞—Å –∑–∞–ø—É—Å–∫—É pytest –º–æ–∂–ª–∏–≤–∏–π `500 Internal Server Error`, —è–∫—â–æ –¥–ª—è Solo throttles –Ω–µ –∑–∞–¥–∞–Ω—ñ DRF rate-limits.
Root cause: `django.core.exceptions.ImproperlyConfigured: No default throttle rate set for 'solo_stream' scope`.

Fix:
- –¥–æ–¥–∞—Ç–∏ `solo_stream`, `solo_beacon`, `solo_diff` —É `REST_FRAMEWORK['DEFAULT_THROTTLE_RATES']` (–¥–∏–≤. `config/settings.py`).

---

## ‚úÖ –ü–ª–∞–Ω –ø—Ä–∏–π–Ω—è—Ç—Ç—è (Go/No-Go)

- [ ] –¢–µ—Å—Ç–∏ –∑–µ–ª–µ–Ω—ñ –≤ CI
- [x] `pytest` –¥–ª—è `apps/solo/tests/*` –±–µ–∑ 500/timeout
- [x] DRF throttle rates –ø—Ä–æ–ø–∏—Å–∞–Ω—ñ (`solo_diff`/`solo_stream`/`solo_beacon`) ‚Äî —ñ–Ω–∞–∫—à–µ –±—É–¥—É—Ç—å 500
- [ ] –õ—ñ–º—ñ—Ç–∏ —É–∑–≥–æ–¥–∂–µ–Ω—ñ (App + Nginx/Ingress + —Ç–µ—Å—Ç–∏)
  - [x] 512 KiB diff / 2 MiB stream / 64 KiB beacon / 10 MiB export —É backend
  - [ ] Nginx/Ingress: `client_max_body_size` / `proxy-body-size` —É–∑–≥–æ–¥–∂–µ–Ω–æ –∑ –ª—ñ–º—ñ—Ç–∞–º–∏ –≤–∏—â–µ
- [x] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É –ø—ñ—Å–ª—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—ñ—ó (`Content-Encoding: gzip`) –¥–∞—î –∫–æ—Ä–µ–∫—Ç–Ω–∏–π 413
  - [ ] –î–ª—è `br` (brotli) –≤–∏–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ (–∞–±–æ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞, –∞–±–æ —è–≤–Ω–∞ –≤—ñ–¥–º–æ–≤–∞)
- [ ] FE UX –Ω–∞ 413/409/422
  - [ ] –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É + retry/—Ä–æ–∑–±–∏—Ç—Ç—è payload; –±–µ–∑ ¬´–Ω—ñ–º–æ–≥–æ¬ª —Ñ–µ–π–ª—É
- [ ] –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ –Ω–∞ staging
  - [ ] `solo.0006_v029_diff_rev_indexes`
  - [ ] `diagnostics.0002_boardmetric`
- [ ] S3/R2/CORS
  - [ ] –í–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ
  - [ ] CORS –Ω–∞ CDN
  - [ ] –ö–ª—é—á—ñ/—Å–µ–∫—Ä–µ—Ç–∏ –Ω–µ –≤ —Ä–µ–ø–æ (env/secret manager)
- [x] –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å/–±–µ–∫–æ—Ñ
  - [x] `Idempotency-Key` –ø—Ä–∞—Ü—é—î
  - [x] 429 –≤—ñ–¥–¥–∞—î `Retry-After`/`X-Backoff-Ms`
- [ ] –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
  - [ ] –ú–µ—Ç—Ä–∏–∫–∏ `BoardMetric` –ø—Ä–∏—Ö–æ–¥—è—Ç—å
  - [ ] –ê–ª–µ—Ä—Ç–∏ –Ω–∞ 5xx/—Å–ø–ª–µ—Å–∫–∏ 413/429
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —ñ —Ä–µ–ª—ñ–∑-–Ω–æ—Ç–∞—Ç–∫–∏
  - [x] `docs/releases/v0.29.md`
  - [x] `CHANGELOG.md`

---

## ‚úÖ DoD Checklist

- [x] Diff-save endpoint –∑ –∞—Ç–æ–º–∞—Ä–Ω–∏–º–∏ —Ä–µ–≤—ñ–∑—ñ—è–º–∏ —Ç–∞ digest
- [x] Stream/beacon endpoints –∑ –∫–≤–æ—Ç–∞–º–∏ –π throttling
- [x] Export polling –∑ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—é, signed URLs, TTL
- [x] 429/Backoff + body/op limits
- [x] R2/S3 versioned storage —Ç–∞ CORS
- [x] Board telemetry ingest —Ç–∞ –∞–≥—Ä–µ–≥–∞—Ü—ñ—è
- [x] WS/Auth: JWT headers, –±–µ–∑ query tokens
- [x] –ú—ñ–≥—Ä–∞—Ü—ñ—ó —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è
- [x] Pytest-–ø–æ–∫—Ä–∏—Ç—Ç—è –¥–ª—è diff/stream/backoff/export/telemetry
- [x] System check + runserver –±–µ–∑ –ø–æ–º–∏–ª–æ–∫

---

*M4SH Platform v0.29 ‚Äî Stealth Autosave –≥–æ—Ç–æ–≤–æ –¥–æ —Ä–µ–ª—ñ–∑—É.*
