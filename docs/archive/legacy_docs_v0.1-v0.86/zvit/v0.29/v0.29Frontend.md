# v0.29 — Board (Konva) Technical Report

## Scope / Goal

Primary objectives for v0.29 were:

- Eliminate visible Konva flicker during save/autosave flows.
- Ensure autosave does not interrupt active user input (drawing/typing).
- Add robust persist-on-exit (best-effort save on tab close / refresh).
- Improve UX with manual save.
- Fix performance regressions on large boards.
- Make keyboard shortcuts reliable across keyboard layouts and prevent double-trigger.

---

## ✅ Delivered (what was implemented)

### 1) Flicker elimination strategy (render stability)

- Introduced/strengthened the “stable board” approach: saving happens only when board is idle (no active drawing/text editing) and rendering is guarded during save.
- Save flows are designed to avoid extra Konva draws during the save window.

### 2) Persist-on-exit (best-effort save)

- Implemented exit persistence via browser lifecycle events (e.g., `pagehide` / `visibilitychange`) to attempt a final save when the user closes or reloads.

### 3) Manual save UX

- Added `manualSave()` to perform an immediate save without the heavy overlay pipeline.
- Added `Ctrl/Cmd + S` shortcut support.

### 4) Undo/redo performance redesign

- Replaced snapshot-based undo (deep-cloning large stroke arrays) with action-based history.
- This removes O(N) clone work on pointer-up and drastically improves responsiveness on large boards.

### 5) Final-stroke render correctness (no delayed last element)

- Fixed the case where preview canvas cleared before Konva painted the final stroke, causing a visible “late appearance”.

### 6) Keyboard shortcuts reliability (and double undo fix)

- Unified shortcut detection using `KeyboardEvent.code` for cross-layout correctness.
- Added guards to prevent duplicate handling from multiple listeners:
  - ignore if `event.defaultPrevented`
  - ignore if `event.repeat`

Shortcuts covered:

- `Ctrl/Cmd + Z` → undo
- `Ctrl/Cmd + Shift + Z` → redo
- `Ctrl/Cmd + Y` → redo
- `Ctrl/Cmd + S` → save

---

## Files touched / key locations

### Core state / persistence

- `src/modules/classroom/board/state/boardStore.ts`
  - Action-based undo/redo (`addStroke`, `updateStroke`, `deleteStroke`, `clearBoard`)
  - `manualSave()`
  - `persistOnExit` support
  - Fixed `clearBoard` to also clear assets

### Rendering / interaction

- `src/modules/classroom/components/board/BoardCanvas.vue`
  - Persist-on-exit listeners + cleanup
  - Final stroke rendering fix (`nextTick` + `batchDraw` + `requestAnimationFrame`)
  - Stroke config caching (reduces per-frame overhead)
  - HiDPI sharpness: `Konva.pixelRatio = min(devicePixelRatio, 2)` (stable)
  - Paste-image flow produces `data:image/...` assets (see Known issues)

### Global keyboard shortcuts

- `src/modules/classroom/views/SoloRoom.vue`
  - Global `keydown` handler using `event.code`
  - Prevent duplicate actions: `defaultPrevented`/`repeat` guards

- `src/modules/classroom/components/board/BoardToolbarNew.vue`
- `src/modules/classroom/components/board/BoardToolbarVertical.vue`
  - Added the same guards and `event.code` usage for undo/redo

- `src/modules/solo/views/SoloWorkspace.vue`
  - Same guards + `event.code` for `Z/Y/S`

---

## How to test (smoke checklist)

### A) No flicker during save

- Draw multiple strokes quickly.
- Trigger saves (manual save, idle save if enabled).
- Confirm no visible canvas blink or “jump”.

### B) Large board performance

- Create a board with a large number of strokes (hundreds / thousands).
- Draw one more stroke.
- Verify the last stroke appears immediately (no noticeable delay on pointer-up).

### C) Undo/redo correctness

- Create a sequence: draw stroke → draw stroke → move/transform stroke (if supported) → delete stroke (if supported).
- Test:
  - `Ctrl/Cmd + Z` (undo once)
  - `Ctrl/Cmd + Shift + Z` and `Ctrl/Cmd + Y` (redo)
- Verify no double-undo on a single keypress.

### D) Persist on exit

- Make a small change.
- Reload the page / close the tab.
- Re-open and confirm the last state is preserved (best-effort).

### E) Copy/paste image

- Copy an image or a task screenshot.
- Paste onto the board.
- Confirm it appears and is movable.

---

## Known issues / limitations

### 1) Images are stored as base64 in state

Pasted images are currently stored as:

- `src: "data:image/png;base64,..."`

Implications:

- Large payloads (autosave / persist-on-exit can hit practical limits).
- Memory/GPU pressure grows quickly with many large images.
- Quality can appear degraded if clipboard provides a downscaled image, or if the board scales it down for display.

Recommended long-term fix:

- Store images as uploaded files (URL) instead of base64.

### 2) Autosave toggle (β) is not yet implemented

Requested feature flag:

- “AutoSave (β)” UI toggle, default OFF, persisted per user.

Status:

- Not implemented in v0.29.

---

## Next steps (optional)

- Add `AutoSave (β)` toggle + persist preference.
- Add explicit guardrails for image assets:
  - upload-to-URL pipeline
  - optional soft-limit warnings (payload size, memory)
- Re-verify `extraDrawsDuringSave === 0` after any future refactors.
