# v0.24.4 Frontend Report — Diagnostics & Logging Infrastructure

**Date:** 2024-12-12  
**Status:** ✅ Completed  
**Focus:** Error collection, logging, and dev diagnostics panel

---

## Summary

This release adds a comprehensive diagnostics and logging infrastructure. Frontend errors are now captured, structured, and sent to the backend for analysis. A dev panel (Ctrl+Shift+D) allows real-time error inspection.

---

## Completed Tasks

### F1: Diagnostics API Client ✅

**File:** `src/modules/diagnostics/api/diagnostics.ts`

**Features:**
- `logFrontendError()` — Send single error immediately
- `queueError()` — Add to batch queue
- `logBatch()` — Send batch of errors
- `flush()` — Flush queue (auto every 5s, on beforeunload)
- `sendBeacon` for page unload reliability

---

### F2: ErrorCollector Plugin ✅

**File:** `src/modules/diagnostics/plugins/errorCollector.ts`

**Features:**
- Vue `app.config.errorHandler` — Component errors
- Vue `app.config.warnHandler` — Dev warnings
- `window.onerror` — Global JS errors
- `window.onunhandledrejection` — Promise rejections
- Ignore patterns (ResizeObserver, Loading chunk, Network Error)
- Mode: `silent` / `console` / `console+remote`
- `$diagnostics` global property for manual logging

---

### F3-F5: WebSocket/WebRTC/Board Diagnostics ✅

**Files:**
- `src/modules/diagnostics/composables/useWebRTCDiagnostics.ts`
- `src/modules/diagnostics/composables/useBoardDiagnostics.ts`

**Features:**
- ICE connection state monitoring
- WebRTC connection failure logging
- Board version conflict logging
- Dropped event logging
- Payload parse error logging
- Sync recovery logging
- WebSocket error/close logging

---

### F6-F8: useDiagnostics + DiagnosticsPanel ✅

**Files:**
- `src/modules/diagnostics/composables/useDiagnostics.ts`
- `src/modules/diagnostics/components/DiagnosticsPanel.vue`
- `src/modules/diagnostics/components/LogItem.vue`

**Features:**
- Local log buffer (max 200 entries)
- Severity filtering (info/warning/error)
- Service filtering (webrtc/board/classroom)
- Log counts by severity
- Expandable log items with stack trace and context
- Keyboard shortcut: Ctrl+Shift+D
- Service-specific counters (WebRTC, Board, WS)

---

### F9: App Version Tagging ✅

**File:** `vite.config.js`

**Features:**
- Auto-generated from `git describe --tags --always`
- Includes commit hash
- Available as `import.meta.env.VITE_APP_VERSION`
- Included in every error payload

---

### F10: Route Context Injection ✅

**File:** `src/router/index.js`

**Features:**
- `router.afterEach` updates current route info
- Route name, path, params, query included in error context

---

### F11: Unit Tests ✅

**Files:**
- `tests/modules/diagnostics/diagnosticsApi.spec.ts`
- `tests/modules/diagnostics/useDiagnostics.spec.ts`
- `tests/modules/diagnostics/errorCollector.spec.ts`

---

### F12: Integration ✅

**Files Modified:**
- `src/main.js` — Install error collector plugin
- `src/App.vue` — Add DiagnosticsPanel (dev only)
- `src/router/index.js` — Route context injection

---

## New Files Summary

```
src/modules/diagnostics/
├── api/
│   └── diagnostics.ts          # API client
├── composables/
│   ├── useDiagnostics.ts       # Panel state & local logs
│   ├── useWebRTCDiagnostics.ts # WebRTC error helpers
│   └── useBoardDiagnostics.ts  # Board sync error helpers
├── components/
│   ├── DiagnosticsPanel.vue    # Dev panel
│   └── LogItem.vue             # Single log entry
├── plugins/
│   └── errorCollector.ts       # Vue plugin
├── types.ts                    # Type definitions
└── index.ts                    # Module exports

tests/modules/diagnostics/
├── diagnosticsApi.spec.ts
├── useDiagnostics.spec.ts
└── errorCollector.spec.ts
```

---

## API Endpoints Used

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/v1/logs/frontend/` | Send frontend errors |

---

## Error Payload Structure

```typescript
interface FrontendErrorPayload {
  severity: 'info' | 'warning' | 'error'
  message: string
  stack?: string
  url: string
  userId?: number
  sessionId?: string
  browser?: string
  platform?: string
  appVersion: string
  context?: {
    route?: RouteInfo
    service?: string
    vue_component?: string
    vue_info?: string
    // ... custom context
  }
}
```

---

## Usage Examples

### Manual Logging

```typescript
// In component
this.$diagnostics.log('User action', { action: 'click' })
this.$diagnostics.warn('Deprecated feature used')
this.$diagnostics.error('Operation failed', error.stack, { op: 'save' })
```

### WebRTC Diagnostics

```typescript
import { useWebRTCDiagnostics } from '@/modules/diagnostics'

const { setupPeerConnectionDiagnostics, withDiagnostics } = useWebRTCDiagnostics(sessionId)

// Setup monitoring
setupPeerConnectionDiagnostics(peerConnection)

// Wrap operations
await withDiagnostics('setRemoteDescription', () => 
  pc.setRemoteDescription(offer)
)
```

### Board Diagnostics

```typescript
import { useBoardDiagnostics } from '@/modules/diagnostics'

const { logVersionConflict, logDroppedEvent } = useBoardDiagnostics(sessionId)

// Log conflicts
logVersionConflict(clientVersion, serverVersion, operationId)

// Log dropped events
logDroppedEvent('stroke:add', 'version_mismatch', eventData)
```

---

## Dev Panel Features

- **Keyboard shortcut:** Ctrl+Shift+D
- **Severity badges:** Error (red), Warning (yellow)
- **Filters:** Severity, Service
- **Expandable logs:** Stack trace, Context JSON
- **Summary:** WebRTC/Board/WS error counts
- **Actions:** Clear logs, Close panel

---

## Configuration

### Error Collector Modes

| Mode | Console | Remote |
|------|---------|--------|
| `silent` | ❌ | ❌ |
| `console` | ✅ | ❌ |
| `console+remote` | ✅ | ✅ |

### Ignore Patterns

Default patterns that won't be logged:
- `ResizeObserver loop`
- `Loading chunk`
- `Network Error`

---

## Performance

| Metric | Value |
|--------|-------|
| Batch size | 10 errors |
| Flush interval | 5 seconds |
| Max local logs | 200 entries |
| Page unload | sendBeacon |

---

## Next Steps (v0.24.5)

1. **Error Analytics Dashboard** — Backend visualization
2. **Error Grouping** — Deduplicate similar errors
3. **Source Maps** — Unminify stack traces
4. **Alerts** — Notify on error spikes
5. **Performance Metrics** — Add timing data

---

## Conclusion

v0.24.4 establishes a robust diagnostics infrastructure. Frontend errors are now captured with full context (route, browser, version) and sent to the backend. The dev panel provides real-time visibility into application health.

---

*M4SH Platform v0.24.4 — Frontend Technical Report*
