# –ü–æ–≤–Ω–∏–π –∞—É–¥–∏—Ç Konva Board v0.28.2

> **–î–∞—Ç–∞:** 2025-12-14  
> **–°—Ç–∞—Ç—É—Å:** In Progress  
> **–ê–≤—Ç–æ—Ä:** Frontend Team

---

## üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ (–≤–∏—è–≤–ª–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º)

### 1. –ö–æ–ª–∞ (Circle) –Ω–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—å—Å—è

**–°–∏–º–ø—Ç–æ–º:** –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "Circle" —î –Ω–∞ toolbar, –∞–ª–µ –ø—Ä–∏ –º–∞–ª—é–≤–∞–Ω–Ω—ñ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `BoardCanvas.vue`:
- Toolbar –º–∞—î `{ id: 'circle', icon: IconCircle, shortcut: 'C' }`
- –ê–ª–µ –≤ template –Ω–µ–º–∞—î —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –¥–ª—è `stroke.tool === 'circle'`
- –í `handleMouseMove` —ñ `handleMouseUp` –Ω–µ–º–∞—î –æ–±—Ä–æ–±–∫–∏ –¥–ª—è `circle`
- Stroke interface –Ω–µ –≤–∫–ª—é—á–∞—î `'circle'` —è–∫ tool type

**–§–∞–π–ª–∏ –¥–ª—è –∑–º—ñ–Ω–∏:**
- `src/modules/classroom/components/board/BoardCanvas.vue`

**–†—ñ—à–µ–Ω–Ω—è:**
1. –î–æ–¥–∞—Ç–∏ `'circle'` –¥–æ Stroke interface
2. –î–æ–¥–∞—Ç–∏ `<v-ellipse>` –∞–±–æ `<v-circle>` –≤ template
3. –î–æ–¥–∞—Ç–∏ `getCircleConfig()` —Ñ—É–Ω–∫—Ü—ñ—é
4. –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É –≤ `handleMouseMove` —ñ `handleMouseUp`
5. –î–æ–¥–∞—Ç–∏ preview –¥–ª—è circle

---

### 2. –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑ –¥–æ—à–∫–∏ –Ω–µ–º–æ–∂–ª–∏–≤–µ

**–°–∏–º–ø—Ç–æ–º:** –ù–µ–º–∞—î —Å–ø–æ—Å–æ–±—É –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫—É (asset).

**–ü—Ä–∏—á–∏–Ω–∞:** 
- –ù–µ–º–∞—î UI –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ asset
- –ù–µ–º–∞—î `deleteAsset` action –≤ boardStore
- Delete key handler –Ω–µ –æ–±—Ä–æ–±–ª—è—î assets

**–§–∞–π–ª–∏ –¥–ª—è –∑–º—ñ–Ω–∏:**
- `src/modules/classroom/board/state/boardStore.ts`
- `src/modules/classroom/components/board/BoardCanvas.vue`
- `src/modules/solo/views/SoloWorkspace.vue`

**–†—ñ—à–µ–Ω–Ω—è:**
1. –î–æ–¥–∞—Ç–∏ `deleteAsset(assetId)` action –≤ boardStore
2. –û–±—Ä–æ–±–ª—è—Ç–∏ Delete/Backspace –¥–ª—è –≤–∏–±—Ä–∞–Ω–∏—Ö assets
3. –î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –∞–±–æ –∫–Ω–æ–ø–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è

---

### 3. –ö–∞—Ä—Ç–∏–Ω–∫–∏ —Ä–µ–Ω–¥–µ—Ä—è—Ç—å—Å—è –ø–æ–≤–µ—Ä—Ö strokes (z-index)

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ –∫–∞—Ä—Ç–∏–Ω–∫–∏, strokes –æ–ø–∏–Ω—è—é—Ç—å—Å—è –ø—ñ–¥ –Ω–µ—é.

**–ü—Ä–∏—á–∏–Ω–∞:** –í template –ø–æ—Ä—è–¥–æ–∫ layers:
```vue
<v-layer>Background</v-layer>
<v-layer ref="strokesLayerRef">Strokes</v-layer>  <!-- –ù–∏–∂—á–µ -->
<v-layer ref="assetsLayerRef">Assets</v-layer>    <!-- –í–∏—â–µ -->
```

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–æ–º—ñ–Ω—è—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ layers (assets –ø—ñ–¥ strokes)
2. –ê–ë–û –¥–æ–¥–∞—Ç–∏ z-index —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
3. –ê–ë–û –æ–±'—î–¥–Ω–∞—Ç–∏ strokes —ñ assets –≤ –æ–¥–∏–Ω layer –∑ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º –ø–æ zIndex

---

### 4. –ï–∫—Å–ø–æ—Ä—Ç –¥–∞—î –ø–æ–º–∏–ª–∫–∏

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç—ñ –≤ PNG/PDF/JSON ‚Äî "Export failed", 404 –ø–æ–º–∏–ª–∫–∞.

**–ü—Ä–∏—á–∏–Ω–∞:** 
- Backend endpoint `/v1/exports/{exportId}/` –Ω–µ —ñ—Å–Ω—É—î
- `soloApi.getExportStatus()` –≤–∏–∫–ª–∏–∫–∞—î –Ω–µ—ñ—Å–Ω—É—é—á–∏–π endpoint

**–ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–¥:**
```typescript
getExportStatus: (exportId: string): Promise<ExportRequest> =>
  apiClient.get(`/v1/exports/${exportId}/`),  // 404!
```

**–†—ñ—à–µ–Ω–Ω—è (Frontend):**
1. –¢–∏–º—á–∞—Å–æ–≤–æ: –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ client-side export (Konva toDataURL)
2. –ü–æ—Å—Ç—ñ–π–Ω–æ: –ß–µ–∫–∞—Ç–∏ backend —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é

**–†—ñ—à–µ–Ω–Ω—è (Backend):**
–î–∏–≤. `docs/backend-tasks/v0.28-export-api.md`

---

### 5. –ù–æ–≤—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∫–æ–ø—ñ—é—é—Ç—å –≤–º—ñ—Å—Ç

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏, –≤–º—ñ—Å—Ç –ø–µ—Ä—à–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∫–æ–ø—ñ—é—î—Ç—å—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `boardStore.addPage()`:
```typescript
addPage(): void {
  const newPage: Page = {
    id: `page-${Date.now()}`,
    name: `Page ${this.pages.length + 1}`,
    strokes: [],  // –ü–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤
    assets: [],
  }
  this.pages.push(newPage)
  this.currentPageIndex = this.pages.length - 1
  // ...
}
```

–ö–æ–¥ –≤–∏–≥–ª—è–¥–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º. –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ –±—É—Ç–∏ –≤:
1. `BoardDock.currentStrokes` computed –Ω–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ `currentPageIndex`
2. Reactivity issue –∑ `pages` array

**–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ `currentPageIndex` –∑–º—ñ–Ω—é—î—Ç—å—Å—è
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ `currentStrokes` computed –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è

---

### 6. –ö–Ω–æ–ø–∫–∞ "T" (Text) –Ω–µ –ø—Ä–∞—Ü—é—î

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ "T" —ñ –∫–ª—ñ–∫—É –Ω–∞ canvas ‚Äî —Ç–µ–∫—Å—Ç –Ω–µ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `handleMouseDown`:
```typescript
if (currentTool.value === 'text') {
  createTextAtPosition(pos)
  return
}
```

`createTextAtPosition` —Å—Ç–≤–æ—Ä—é—î stroke —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î textarea, –∞–ª–µ:
1. `editingText` –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è, –∞–ª–µ textarea –º–æ–∂–µ –Ω–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏—Å—å
2. `textEditStyle` –º–æ–∂–µ –º–∞—Ç–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏

**–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `editingText` ref
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ CSS –¥–ª—è `.text-edit-overlay`

---

### 7. –í—ñ–¥–µ–æ—á–∞—Ç –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –¥–æ—à–∫–∏ –≤—ñ–¥—Ä–∞–∑—É –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤—ñ–∫–Ω–æ –≤—ñ–¥–µ–æ—á–∞—Ç—É.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `SoloWorkspace.vue`:
```vue
<LocalVideoPreview
  v-if="showVideo"  <!-- showVideo = ref(true) –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º -->
  ...
/>
```

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ó–º—ñ–Ω–∏—Ç–∏ `showVideo = ref(false)` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
2. –î–æ–¥–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫—É –≤—ñ–¥–µ–æ

---

## üü° –°–µ—Ä–µ–¥–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ (–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∞—É–¥–∏—Ç—É)

### 8. –ú–æ—Ä–≥–∞–Ω–Ω—è –ø—Ä–∏ autosave

**–°–∏–º–ø—Ç–æ–º:** Canvas –º–æ—Ä–≥–∞—î –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É autosave.

**–ü—Ä–∏—á–∏–Ω–∞:** Reactivity triggers full re-render.

**–†—ñ—à–µ–Ω–Ω—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `shallowRef` –¥–ª—è strokes/assets
- –ú–µ–º–æ—ñ–∑—É–≤–∞—Ç–∏ computed properties

---

### 9. Undo/Redo –Ω–µ –ø—Ä–∞—Ü—é—î –¥–ª—è assets

**–°–∏–º–ø—Ç–æ–º:** Undo –Ω–µ –≤—ñ–¥–º—ñ–Ω—è—î –¥–æ–¥–∞–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–æ–∫.

**–ü—Ä–∏—á–∏–Ω–∞:** `undoStack` –∑–±–µ—Ä—ñ–≥–∞—î —Ç—ñ–ª—å–∫–∏ strokes.

**–†—ñ—à–µ–Ω–Ω—è:**
- –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –ø–æ–≤–Ω–∏–π snapshot: `{ strokes, assets }`

---

## üü¢ –ù–∏–∑—å–∫—ñ –ø—Ä–æ–±–ª–µ–º–∏

### 10. WebSocket disconnected –ø–æ–º–∏–ª–∫–∏

**–ü—Ä–∏—á–∏–Ω–∞:** Realtime sync –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–ª—è solo mode.

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–º–∫–Ω—É—Ç–∏ realtime –¥–ª—è solo sessions.

---

### 11. Eraser –Ω–µ –ø—Ä–∞—Ü—é—î –¥–ª—è shapes

**–ü—Ä–∏—á–∏–Ω–∞:** `handleErase` –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç—ñ–ª—å–∫–∏ points proximity.

**–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞—Ç–∏ bounding box detection –¥–ª—è shapes.

---

### 12. Highlighter opacity

**–ü—Ä–∏—á–∏–Ω–∞:** `globalCompositeOperation: 'multiply'` –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–æ—Å—Ç–æ `opacity: 0.4`.

---

## üìã –ü–ª–∞–Ω –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ñ (—Å—å–æ–≥–æ–¥–Ω—ñ)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü—ñ–Ω–∫–∞ | –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç |
|---|----------|--------|-----------|
| 1 | Circle tool | 1h | üî¥ High |
| 2 | Delete asset | 30m | üî¥ High |
| 3 | Z-index layers | 30m | üî¥ High |
| 4 | Export (client-side) | 2h | üî¥ High |
| 5 | Pages copy bug | 1h | üî¥ High |
| 6 | Text tool | 1h | üî¥ High |
| 7 | Video auto-start | 15m | üî¥ High |

### –§–∞–∑–∞ 2: –°–µ—Ä–µ–¥–Ω—ñ

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü—ñ–Ω–∫–∞ | –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç |
|---|----------|--------|-----------|
| 8 | –ú–æ—Ä–≥–∞–Ω–Ω—è | 1h | üü° Medium |
| 9 | Undo/Redo assets | 2h | üü° Medium |

### –§–∞–∑–∞ 3: –ù–∏–∑—å–∫—ñ

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü—ñ–Ω–∫–∞ | –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç |
|---|----------|--------|-----------|
| 10 | WebSocket errors | 1h | üü¢ Low |
| 11 | Eraser shapes | 1h | üü¢ Low |
| 12 | Highlighter | 30m | üü¢ Low |

---

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

### 1. Circle Tool Implementation

```typescript
// Stroke interface
interface Stroke {
  tool: 'pen' | 'highlighter' | 'line' | 'rectangle' | 'circle' | 'text' | 'eraser' | 'select'
  // ...
  radius?: number  // –¥–ª—è circle
}

// Template
<v-ellipse
  v-else-if="stroke.tool === 'circle'"
  :config="getCircleConfig(stroke)"
  @click="handleStrokeClick(stroke, $event)"
  @dragend="handleStrokeDragEnd(stroke, $event)"
/>

// Config function
function getCircleConfig(stroke: Stroke): Record<string, unknown> {
  if (!stroke.points[0]) return { visible: false }
  const center = stroke.points[0]
  return {
    id: stroke.id,
    name: `stroke-${stroke.id}`,
    x: center.x,
    y: center.y,
    radiusX: stroke.width ? stroke.width / 2 : 0,
    radiusY: stroke.height ? stroke.height / 2 : 0,
    stroke: stroke.color,
    strokeWidth: stroke.size,
    fill: 'transparent',
    opacity: stroke.opacity,
    draggable: currentTool.value === 'select',
  }
}
```

### 2. Delete Asset

```typescript
// boardStore.ts
deleteAsset(assetId: string): void {
  const page = this.pages[this.currentPageIndex]
  if (!page) return
  
  const index = page.assets.findIndex((a: unknown) => (a as { id: string }).id === assetId)
  if (index !== -1) {
    page.assets.splice(index, 1)
    this.markDirty()
  }
}

// BoardCanvas.vue - handleKeydown
if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNode.value) {
  const nodeId = selectedNode.value.id()
  if (nodeId.startsWith('asset-')) {
    emit('asset-delete', nodeId)
  } else if (nodeId.startsWith('stroke-')) {
    emit('stroke-delete', nodeId)
  }
  selectedNode.value = null
}
```

### 3. Z-index Fix

```vue
<!-- –ó–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ layers -->
<v-layer>Background</v-layer>
<v-layer ref="assetsLayerRef">Assets (images)</v-layer>  <!-- –ù–∏–∂—á–µ -->
<v-layer ref="strokesLayerRef">Strokes</v-layer>         <!-- –í–∏—â–µ -->
<v-layer ref="uiLayerRef">UI (transformer, preview)</v-layer>
```

### 4. Client-side Export

```typescript
// ExportMenu.vue
async function exportClientSide(): Promise<void> {
  const stage = boardDockRef.value?.getStage()
  if (!stage) return
  
  if (selectedFormat.value === 'png') {
    const dataUrl = stage.toDataURL({ pixelRatio: 2 })
    downloadDataUrl(dataUrl, `board-${Date.now()}.png`)
  } else if (selectedFormat.value === 'json') {
    const json = JSON.stringify(boardStore.serializedState, null, 2)
    const blob = new Blob([json], { type: 'application/json' })
    downloadBlob(blob, `board-${Date.now()}.json`)
  }
  // PDF –ø–æ—Ç—Ä–µ–±—É—î –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ (jspdf)
}
```

### 5. Pages Bug Fix

```typescript
// –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ reactivity –≤ BoardDock
const currentStrokes = computed<Stroke[]>(() => {
  const state = props.boardState as { 
    pages?: Array<{ strokes?: Stroke[], id?: string }> 
    currentPageIndex?: number
  }
  
  console.log('[BoardDock] currentPageIndex:', state?.currentPageIndex)
  
  if (!state?.pages?.length) return []
  const pageIndex = state.currentPageIndex ?? 0
  const page = state.pages[pageIndex]
  console.log('[BoardDock] page strokes:', page?.strokes?.length)
  return page?.strokes || []
})
```

---

## ‚úÖ –í–∏–∫–æ–Ω–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (–ø–æ–ø–µ—Ä–µ–¥–Ω—è —Å–µ—Å—ñ—è)

| –î–∞—Ç–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –†—ñ—à–µ–Ω–Ω—è |
|------|----------|---------|
| 2025-12-13 | Strokes –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–ª–∏—Å—å | –ó–∞–º—ñ–Ω–∏–≤ v-line –Ω–∞ v-path |
| 2025-12-13 | Tool –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–≤—Å—è | –î–æ–¥–∞–≤ props tool/color/size |
| 2025-12-13 | Pages structure | –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ strokes –≤ pages[] |
| 2025-12-13 | Select tool | –î–æ–¥–∞–Ω–æ draggable + handlers |

---

## ‚úÖ –í–∏–∫–æ–Ω–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (—Ü—è —Å–µ—Å—ñ—è)

| –î–∞—Ç–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –†—ñ—à–µ–Ω–Ω—è |
|------|----------|---------|
| 2025-12-14 | Video auto-start | `showVideo = ref(false)` |
| 2025-12-14 | Z-index layers | –ü–µ—Ä–µ—Å—Ç–∞–≤–ª–µ–Ω–æ layers: assets ‚Üí strokes ‚Üí UI |
| 2025-12-14 | Circle tool | –î–æ–¥–∞–Ω–æ v-ellipse, getCircleConfig, preview |
| 2025-12-14 | Delete assets | –î–æ–¥–∞–Ω–æ deleteAsset action, handleKeydown Delete |
| 2025-12-14 | Pages copy bug | –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ addPage() - —Ç–µ–ø–µ—Ä –≤–∏–∫–ª–∏–∫–∞—î boardStore.addPage() |
| 2025-12-14 | Client-side export | –î–æ–¥–∞–Ω–æ JSON export fallback |
| 2025-12-14 | –ü–æ–¥–≤—ñ–π–Ω–∏–π paste | –í–∏–¥–∞–ª–µ–Ω–æ –¥—É–±–ª—é—é—á–∏–π @paste –∑ div, –∑–∞–ª–∏—à–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ document.addEventListener |
| 2025-12-14 | –ú–æ—Ä–≥–∞–Ω–Ω—è autosave | **–ì–õ–ò–ë–û–ö–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø**: –ó–º—ñ–Ω–µ–Ω–æ –ø–µ—Ä–µ–¥–∞—á—É props - —Ç–µ–ø–µ—Ä strokes/assets –Ω–∞–ø—Ä—è–º—É –∑–∞–º—ñ—Å—Ç—å serializedState |
| 2025-12-14 | Asset add/update | –î–æ–¥–∞–Ω–æ addAsset(), updateAsset() –≤ boardStore + –æ–±—Ä–æ–±–∫—É –≤ SoloWorkspace |
| 2025-12-14 | PNG export | –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è, –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ getStage?.() |
| 2025-12-14 | PDF export | –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ client-side PDF export —á–µ—Ä–µ–∑ canvas (A4 —Ñ–æ—Ä–º–∞—Ç) |

## üîß –ö–ª—é—á–æ–≤–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –º–æ—Ä–≥–∞–Ω–Ω—è

**–ü—Ä–∏—á–∏–Ω–∞ –º–æ—Ä–≥–∞–Ω–Ω—è:** `boardStore.serializedState` –ø–µ—Ä–µ–¥–∞–≤–∞–≤—Å—è —è–∫ prop –¥–æ BoardDock. –¶–µ–π getter —Å—Ç–≤–æ—Ä—é–≤–∞–≤ –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç –∫–æ–∂–µ–Ω —Ä–∞–∑, –∫–æ–ª–∏ –±—É–¥—å-—è–∫–∞ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å store –∑–º—ñ–Ω—é–≤–∞–ª–∞—Å—å (–≤–∫–ª—é—á–∞—é—á–∏ `isDirty`, `lastSavedAt`). Vue –±–∞—á–∏–≤ –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç —ñ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—é–≤–∞–≤ –≤–µ—Å—å BoardDock.

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ó–º—ñ–Ω–µ–Ω–æ props BoardDock: –∑–∞–º—ñ—Å—Ç—å `board-state` —Ç–µ–ø–µ—Ä `strokes` —ñ `assets` –Ω–∞–ø—Ä—è–º—É
2. –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ `updateSession()` - –Ω–µ –∑–º—ñ–Ω—é—î `lastSavedAt` —è–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è < 1 —Å–µ–∫—É–Ω–¥–∏
3. –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ `if (this.syncError !== null)` –ø–µ—Ä–µ–¥ –∑–º—ñ–Ω–æ—é

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. ‚úÖ ~~–í–∏–ø—Ä–∞–≤–∏—Ç–∏ Circle tool~~
2. ‚úÖ ~~–î–æ–¥–∞—Ç–∏ Delete –¥–ª—è assets~~
3. ‚úÖ ~~–í–∏–ø—Ä–∞–≤–∏—Ç–∏ z-index layers~~
4. ‚úÖ ~~–†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ client-side export (JSON)~~
5. ‚úÖ ~~–î–µ–±–∞–≥–Ω—É—Ç–∏ pages copy bug~~
6. ‚úÖ ~~–í–∏–º–∫–Ω—É—Ç–∏ auto-start video~~
7. ‚úÖ ~~–í–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–¥–≤—ñ–π–Ω–∏–π paste~~
8. ‚úÖ ~~–í–∏–ø—Ä–∞–≤–∏—Ç–∏ –º–æ—Ä–≥–∞–Ω–Ω—è autosave~~ (–ì–õ–ò–ë–û–ö–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø)
9. ‚úÖ ~~PNG export - –¥–æ–¥–∞–Ω–æ –¥–æ—Å—Ç—É–ø –¥–æ Konva stage~~
10. ‚úÖ ~~PDF export - —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ client-side~~
11. ‚ö†Ô∏è Text tool - –¥–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üîß F29-STEALTH: Stealth Autosave Pipeline (2025-12-16)

### –ú–µ—Ç–∞
–ü–æ–≤–Ω—ñ—Å—Ç—é —É—Å—É–Ω—É—Ç–∏ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è Canvas –ø—Ä–∏ autosave —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –±–µ–∑ –≤–ø–ª–∏–≤—É –Ω–∞ UI.

### –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

#### 1. Web Worker –¥–ª—è autosave (`src/workers/autosave.worker.ts`)
- –ü—Ä–æ—Ç–æ–∫–æ–ª: `SAVE_DIFF`, `SAVE_FULL`, `ABORT_PENDING` ‚Üí `ACK_SUCCESS`, `ACK_QUEUED`, `ACK_ERROR`
- –ö–æ–∞–ª–µ—Å–∏–Ω–≥: –Ω–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ —Å–∫–∞—Å–æ–≤—É—é—Ç—å –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ
- Backoff: 500ms ‚Üí 20s –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö
- `keepalive: true` –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è

#### 2. Render Guards (`src/modules/classroom/board/render/guards.ts`)
- `startRenderGuard(stage)` ‚Äî –±–ª–æ–∫—É—î `draw()`/`batchDraw()` –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É
- `stopRenderGuard(stage)` ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –º–µ—Ç–æ–¥–∏
- `listening(false)` –Ω–∞ layers –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è hit detection
- –õ—ñ—á–∏–ª—å–Ω–∏–∫ `extraDrawsDuringSave` –¥–ª—è –º–µ—Ç—Ä–∏–∫

#### 3. Snapshot Overlay (`src/modules/classroom/board/render/snapshotOverlay.ts`)
- `showSnapshotOverlay(stage)` ‚Äî —Å—Ç–≤–æ—Ä—é—î ImageBitmap snapshot
- `hideSnapshotOverlay(fadeDurationMs)` ‚Äî –ø–ª–∞–≤–Ω–µ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è
- `transferToImageBitmap()` –¥–ª—è zero-copy (—è–∫—â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è)
- `contain: content` + `will-change: opacity` –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

#### 4. Render Queue (`src/modules/classroom/board/render/renderQueue.ts`)
- `requestRender(callback)` ‚Äî —î–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥—É –¥–ª—è draw()
- –ö–æ–∞–ª–µ—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ `requestAnimationFrame`
- –ú–µ—Ç—Ä–∏–∫–∏: `lastRenderTime`, `renderCount`, `skippedCount`

#### 5. BoardSyncStore —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è (`src/modules/classroom/board/state/boardSyncStore.ts`)
- –ù–æ–≤—ñ –ø–æ–ª—è: `rev`, `pendingCount`, `networkRtt`, `isQuiet`
- Actions: `handleAckSuccess`, `handleAckQueued`, `handleAckError`
- –Ü–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö ACK (`if (rev < this.rev) return`)

#### 6. CloudStatus quiet mode (`src/modules/classroom/components/board/CloudStatus.vue`)
- Prop `quiet: boolean` ‚Äî opacity-only transitions
- Prop `pendingCount: number` ‚Äî –ø–æ–∫–∞–∑—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —á–µ—Ä–≥–∏
- CSS `.cloud-status--quiet` ‚Äî –±–µ–∑ –∑–º—ñ–Ω–∏ –∫–æ–ª—å–æ—Ä—ñ–≤/layout

#### 7. BoardCanvas —Å—Ç–∞–±—ñ–ª—å–Ω—ñ references
- –í–∏–¥–∞–ª–µ–Ω–æ `withDefaults` –¥–ª—è `strokes`/`assets` (–±–µ–∑ factory)
- Computed `strokes`/`assets` –∑ `?? []` fallback
- –í–∏–¥–∞–ª–µ–Ω–æ –¥—É–±–ª—ñ–∫–∞—Ç –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è

### –Ü–Ω–≤–∞—Ä—ñ–∞–Ω—Ç–∏ (–Ω–µ–∑–ª–∞–º–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞)
1. Canvas –ù–ï –∑–Ω–∞—î –ø—Ä–æ autosave
2. –ë–µ–∑ rehydrate –ø—ñ—Å–ª—è PUT
3. –Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ —Ä–µ–Ω–¥–µ—Ä—É ‚Äî rAF-—á–µ—Ä–≥–∞
4. –ü—ñ–¥ —á–∞—Å —Å–µ–π–≤—É ‚Äî 0 –∑–º—ñ–Ω layout/DOM —É –∑–æ–Ω—ñ Canvas

### DoD (Definition of Done)
- `extraDrawsDuringSave = 0`
- `mainThreadBlock < 8 ms`
- `inputLatency < 16 ms` (–º–∏—à–∞), `< 10 ms` (–ø–µ—Ä–æ)
- `Overlay copy < 3 ms`
- –ö–æ–∞–ª–µ—Å–∏–Ω–≥: N –¥—ñ–π –∑–∞ 1‚Äì1.2 —Å ‚Üí 1 –∑–∞–ø–∏—Ç

### –§–∞–π–ª–∏
```
src/workers/autosave.worker.ts          # Web Worker
src/modules/classroom/board/render/
‚îú‚îÄ‚îÄ index.ts                            # Exports
‚îú‚îÄ‚îÄ guards.ts                           # Render guards
‚îú‚îÄ‚îÄ snapshotOverlay.ts                  # Snapshot overlay
‚îî‚îÄ‚îÄ renderQueue.ts                      # rAF queue
src/modules/classroom/board/perf/
‚îú‚îÄ‚îÄ index.ts                            # Exports
‚îî‚îÄ‚îÄ saveWindowMetrics.ts                # Save window instrumentation
src/modules/classroom/components/board/
‚îî‚îÄ‚îÄ PerfHUD.vue                         # Extended with save metrics
scripts/
‚îî‚îÄ‚îÄ board-bench.ts                      # Benchmark script
.github/workflows/
‚îî‚îÄ‚îÄ board-bench.yml                     # CI workflow
```

---

## üß™ Smoke-—á–µ–∫–ª–∏—Å—Ç (—Ä—É—á–Ω–∏–π, 2 —Ö–≤)

| # | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ | –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|---|-----------|---------------------|
| 1 | –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ ‚Üí –¥–æ—á–µ–∫–∞—Ç–∏—Å—è 2‚Äì3 autosave —Ü–∏–∫–ª—ñ–≤ | –ù–µ–º–∞—î –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω –Ω–∞ canvas |
| 2 | –í–∏–º–∫–Ω—É—Ç–∏ CloudStatus (quiet=true + hide) | –í–∏–≥–ª—è–¥–∞—î —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ |
| 3 | Chrome Performance: –ø—ñ–¥ —á–∞—Å save | 0 Layout/Recalc —Ç–∞ 0 Canvas-–≤–∏–∫–ª–∏–∫—ñ–≤ |
| 4 | –í–∏–º–∫–Ω—É—Ç–∏ –º–µ—Ä–µ–∂—É ‚Üí "Saved (queued)" | –ë–µ–∑ –∑—Å—É–≤—É layout; —ñ–Ω–ø—É—Ç –ø–ª–∞–≤–Ω–∏–π |
| 5 | –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ out-of-order ACK | UI –Ω–µ –¥–µ—Ä–≥–∞—î—Ç—å—Å—è (rev —ñ–≥–Ω–æ—Ä—É—î —Å—Ç–∞—Ä—ñ ACK) |
| 6 | Ctrl+Alt+P ‚Üí PerfHUD | ExtraDraws = 0, SaveBlock ‚â§ 8ms |

---

## ‚ö†Ô∏è –†–∏–∑–∏–∫–∏ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

### Out-of-order ACK
- **–†–∏–∑–∏–∫:** –°—Ç–∞—Ä–∏–π ACK –º–æ–∂–µ –æ–Ω–æ–≤–∏—Ç–∏ `lastSavedAt` –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º timestamp
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:** `if (rev < this.rev) return` —É `handleAckSuccess`
- **–¢–µ—Å—Ç:** –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ ACK –∑ rev=1 –ø—ñ—Å–ª—è rev=2 ‚Üí —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è

### –ü–∞–º'—è—Ç—å –≤–æ—Ä–∫–µ—Ä–∞
- **–†–∏–∑–∏–∫:** –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è –≤—Å—å–æ–≥–æ board –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ OOM
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:** –ö–ª–æ–Ω—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É/–¥–∏—Ñ
- **–¢–µ—Å—Ç:** 10 —Å—Ç–æ—Ä—ñ–Ω–æ–∫ √ó 5000 strokes ‚Üí –ø–∞–º'—è—Ç—å –≤–æ—Ä–∫–µ—Ä–∞ < 50MB

### Overlay precision
- **–†–∏–∑–∏–∫:** Snapshot –º–æ–∂–µ –±—É—Ç–∏ –∑–º—ñ—â–µ–Ω–∏–π –Ω–∞ —Å—É–±–ø—ñ–∫—Å–µ–ª—å–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:** –ú–∞—Ç—Ä–∏—Ü—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ–π + snap –¥–æ 0.5px
- **–¢–µ—Å—Ç:** Zoom 0.5x, 1x, 2x ‚Üí overlay —Ç–æ—á–Ω–æ –Ω–∞–∫–ª–∞–¥–∞—î—Ç—å—Å—è

### Hit graph
- **–†–∏–∑–∏–∫:** `listening(false)` –º–æ–∂–µ –∑–∞–ª–∏—à–∏—Ç–∏—Å—è –ø—ñ—Å–ª—è —Å–µ–π–≤—É
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:** `stopRenderGuard` –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª—é—î `listening(true)`
- **–¢–µ—Å—Ç:** –ü—ñ—Å–ª—è —Å–µ–π–≤—É ‚Üí –∫–ª—ñ–∫ –Ω–∞ stroke ‚Üí –≤–∏–¥—ñ–ª—è—î—Ç—å—Å—è

---

## üìä CI-–≥–≤–∞—Ä–¥–∏ (–∂–æ—Ä—Å—Ç–∫—ñ –ø–æ—Ä–æ–≥–∏)

### FAIL (–±–ª–æ–∫—É—î PR)
| –ú–µ—Ç—Ä–∏–∫–∞ | –ü–æ—Ä—ñ–≥ | –ü—Ä–∏—á–∏–Ω–∞ |
|---------|-------|---------|
| `extraDrawsDuringSave` | > 0 | –ë—É–¥—å-—è–∫–∏–π extra draw = –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π —Ñ–ª—ñ–∫–µ—Ä |
| `mainThreadBlockMsDuringSave` | > 8ms | –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è > 8ms = –ø–æ–º—ñ—Ç–Ω–∏–π lag |
| `fpsDuringSave` | < 55 | FPS < 55 = –ø–æ–º—ñ—Ç–Ω–∏–π stuttering |

### WARN (–Ω–µ –±–ª–æ–∫—É—î, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É—î —É–≤–∞–≥–∏)
| –ú–µ—Ç—Ä–∏–∫–∞ | –ü–æ—Ä—ñ–≥ | –ü—Ä–∏—á–∏–Ω–∞ |
|---------|-------|---------|
| `initialRenderMs` | > 1200ms | –ü–æ–≤—ñ–ª—å–Ω–∏–π initial render |
| `pageSwitchMs` | > 150ms | –ü–æ–≤—ñ–ª—å–Ω–µ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–æ–∫ |
| `bulkUndoMs` | > 400ms | –ü–æ–≤—ñ–ª—å–Ω–∏–π bulk undo |

---

## ‚úÖ Definition of Done (–Ω—É–ª—å –±–ª–∏–º–∞–Ω–Ω—è ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–æ)

- [x] `extraDrawsDuringSave === 0` —É HUD/–±–µ–Ω—á–∞—Ö
- [ ] `mainThreadBlockMsDuringSave ‚â§ 8 –º—Å` (—Ü—ñ–ª—å 4‚Äì6 –º—Å)
- [ ] `inputLatencyMsDuringSave < 16 –º—Å` (–º–∏—à–∞) / `< 10 –º—Å` (–ø–µ—Ä–æ)
- [ ] –£ Performance –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É: 0 Layout/Recalc —ñ Canvas-–≤–∏–∫–ª–∏–∫—ñ–≤
- [ ] –ù–∞ slow-3G –∞–±–æ offline: –Ω—ñ—è–∫–∏—Ö –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö —Å—Ç—Ä–∏–±–∫—ñ–≤
- [ ] `bench.json` —É CI ‚Äî —É "–∑–µ–ª–µ–Ω—ñ–π –∑–æ–Ω—ñ", PR –±–µ–∑ —Ü—å–æ–≥–æ –Ω–µ –∑—ñ–ª–ª—î—Ç—å—Å—è

---

## ‚úÖ –§—ñ–Ω–∞–ª—å–Ω–∏–π root cause —ñ —Ñ—ñ–∫—Å (extraDraws = 0)

### Root cause

–ü—ñ–¥ —á–∞—Å save window, –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ–ø—Å—ñ–≤ —ñ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–∞—Ü—ñ—ó rAF-—á–µ—Ä–≥–∏, Konva –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞–≤ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—î –±–∞—Ç—á—É–≤–∞–Ω–Ω—è —Ç–∞/–∞–±–æ UI-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è (Transformer/selection), —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏–ª–æ –¥–æ –≤–∏–∫–ª–∏–∫—ñ–≤ `layer.batchDraw()` –≤–∂–µ –ø—ñ–¥ –∞–∫—Ç–∏–≤–Ω–∏–º guard. Guard —ó—Ö –±–ª–æ–∫—É–≤–∞–≤, –∞–ª–µ –ª—ñ—á–∏–ª—å–Ω–∏–∫ `extraDrawsDuringSave` —Å—Ç–∞–≤–∞–≤ > 0, —â–æ –∫–æ—Ä–µ–ª—é–≤–∞–ª–æ –∑ –≤–∏–¥–∏–º–∏–º ‚Äú–±–ª–∏–º–∞–Ω–Ω—è–º‚Äù.

### –§—ñ–∫—Å

- –ù–∞ —Å—Ç–∞—Ä—Ç—ñ guard (–≤ –º–µ–∂–∞—Ö save window) —Ç–∏–º—á–∞—Å–æ–≤–æ –≤–∏–º–∏–∫–∞—î–º–æ –∞–≤—Ç–æ-—Ä–µ–Ω–¥–µ—Ä Konva:
  - `Konva.autoDrawEnabled = false`
  - –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ save window –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è.

–¶–µ –∑—É–ø–∏–Ω—è—î –≤–Ω—É—Ç—Ä—ñ—à–Ω—î –∞–≤—Ç–æ-–±–∞—Ç—á—É–≤–∞–Ω–Ω—è Konva –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É —ñ –æ–±–Ω—É–ª—è—î `extraDrawsDuringSave`.

### –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è

–£ —Ä—É—á–Ω–æ–º—É smoke-—Ç–µ—Å—Ç—ñ (–∫—ñ–ª—å–∫–∞ autosave –ø—ñ–¥—Ä—è–¥) –æ—Ç—Ä–∏–º–∞–Ω–æ —Å—Ç–∞–±—ñ–ª—å–Ω–µ:

- `saveWindow.end ... extraDraws: 0`
- `autosave.success ... extraDraws: 0`
