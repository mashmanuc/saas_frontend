# –¢–µ—Ö–Ω—ñ—á–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è: Export API –¥–ª—è Solo Board

> **–í–µ—Ä—Å—ñ—è:** v0.28  
> **–ú–æ–¥—É–ª—å:** Solo / Export  
> **–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** High  
> **–ê–≤—Ç–æ—Ä:** Frontend Team  
> **–î–∞—Ç–∞:** 2025-12-13

---

## 1. –û–≥–ª—è–¥

Frontend –ø–æ—Ç—Ä–µ–±—É—î API –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –µ–∫—Å–ø–æ—Ä—Ç—É –¥–æ—à–∫–∏ –≤ —Ä—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ (PNG, PDF, JSON). –ü–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∏–∫–ª–∏–∫–∞—î 404 –ø–æ–º–∏–ª–∫—É –ø—Ä–∏ polling —Å—Ç–∞—Ç—É—Å—É –µ–∫—Å–ø–æ—Ä—Ç—É.

### –ü–æ—Ç–æ—á–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞

```
GET http://localhost:8000/api/v1/exports/27f2cd59-2056-4011-a068-c67f0bd442c...
404 (Not Found)
```

Frontend –≤–∏–∫–ª–∏–∫–∞—î:
1. `POST /api/v1/solo/sessions/{id}/export/` ‚Äî —Å—Ç–≤–æ—Ä—é—î –∑–∞–ø–∏—Ç –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç
2. `GET /api/v1/exports/{export_id}/` ‚Äî polling —Å—Ç–∞—Ç—É—Å—É (‚ùå 404)

---

## 2. –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ endpoints

### 2.1 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç

**Endpoint:** `POST /api/v1/solo/sessions/{session_id}/export/`

**Request:**
```json
{
  "format": "png" | "pdf" | "json"
}
```

**Response (201 Created):**
```json
{
  "id": "uuid",
  "session_id": "uuid",
  "format": "pdf",
  "status": "pending",
  "file_url": null,
  "error": null,
  "created_at": "2025-12-13T19:00:00Z",
  "updated_at": "2025-12-13T19:00:00Z"
}
```

**–°—Ç–∞—Ç—É—Å–∏:**
- `pending` ‚Äî –∑–∞–ø–∏—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ, —á–µ–∫–∞—î –æ–±—Ä–æ–±–∫–∏
- `processing` ‚Äî –µ–∫—Å–ø–æ—Ä—Ç –≤ –ø—Ä–æ—Ü–µ—Å—ñ
- `completed` ‚Äî –µ–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ, `file_url` –º—ñ—Å—Ç–∏—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è
- `failed` ‚Äî –ø–æ–º–∏–ª–∫–∞, `error` –º—ñ—Å—Ç–∏—Ç—å –æ–ø–∏—Å

---

### 2.2 –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –µ–∫—Å–ø–æ—Ä—Ç—É ‚ö†Ô∏è –ü–û–¢–†–Ü–ë–ù–û –†–ï–ê–õ–Ü–ó–£–í–ê–¢–ò

**Endpoint:** `GET /api/v1/exports/{export_id}/`

**Response (200 OK):**
```json
{
  "id": "uuid",
  "session_id": "uuid",
  "format": "pdf",
  "status": "completed",
  "file_url": "https://storage.example.com/exports/abc123.pdf",
  "error": null,
  "created_at": "2025-12-13T19:00:00Z",
  "updated_at": "2025-12-13T19:00:05Z"
}
```

**Response (404 Not Found):**
```json
{
  "detail": "Export not found"
}
```

---

### 2.3 –°–ø–∏—Å–æ–∫ –µ–∫—Å–ø–æ—Ä—Ç—ñ–≤ —Å–µ—Å—ñ—ó (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

**Endpoint:** `GET /api/v1/solo/sessions/{session_id}/exports/`

**Response (200 OK):**
```json
{
  "count": 2,
  "results": [
    {
      "id": "uuid",
      "format": "pdf",
      "status": "completed",
      "file_url": "...",
      "created_at": "..."
    }
  ]
}
```

---

## 3. –ú–æ–¥–µ–ª—å –¥–∞–Ω–∏—Ö

### ExportRequest

```python
class ExportRequest(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    session = models.ForeignKey('SoloSession', on_delete=models.CASCADE, related_name='exports')
    user = models.ForeignKey('User', on_delete=models.CASCADE)
    
    format = models.CharField(max_length=10, choices=[
        ('png', 'PNG Image'),
        ('pdf', 'PDF Document'),
        ('json', 'JSON Data'),
    ])
    
    status = models.CharField(max_length=20, choices=[
        ('pending', 'Pending'),
        ('processing', 'Processing'),
        ('completed', 'Completed'),
        ('failed', 'Failed'),
    ], default='pending')
    
    file_url = models.URLField(null=True, blank=True)
    error = models.TextField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Metadata
    file_size = models.IntegerField(null=True)  # bytes
    page_count = models.IntegerField(null=True)  # for PDF
    
    class Meta:
        ordering = ['-created_at']
```

---

## 4. –õ–æ–≥—ñ–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É

### 4.1 PNG Export

1. –û—Ç—Ä–∏–º–∞—Ç–∏ `session.state` (JSON –∑ strokes, assets)
2. –†–µ–Ω–¥–µ—Ä–∏—Ç–∏ canvas server-side (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ Pillow –∞–±–æ Cairo)
3. –ó–±–µ—Ä–µ–≥—Ç–∏ PNG –≤ S3/storage
4. –û–Ω–æ–≤–∏—Ç–∏ `file_url`

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** Frontend –º–æ–∂–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ PNG –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Konva `stage.toDataURL()` —ñ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –Ω–∞ –±–µ–∫–µ–Ω–¥ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.

### 4.2 PDF Export

1. –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Å–µ—Å—ñ—ó
2. –†–µ–Ω–¥–µ—Ä–∏—Ç–∏ –∫–æ–∂–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É —è–∫ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
3. –û–±'—î–¥–Ω–∞—Ç–∏ –≤ PDF (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ reportlab –∞–±–æ weasyprint)
4. –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ storage

### 4.3 JSON Export

1. –°–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ `session.state` –≤ JSON
2. –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —Ñ–∞–π–ª
3. –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ URL –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

---

## 5. Celery Task (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

```python
# tasks.py
from celery import shared_task

@shared_task
def process_export(export_id: str):
    export = ExportRequest.objects.get(id=export_id)
    export.status = 'processing'
    export.save()
    
    try:
        if export.format == 'png':
            file_url = render_png(export.session)
        elif export.format == 'pdf':
            file_url = render_pdf(export.session)
        elif export.format == 'json':
            file_url = export_json(export.session)
        
        export.file_url = file_url
        export.status = 'completed'
    except Exception as e:
        export.status = 'failed'
        export.error = str(e)
    
    export.save()
```

---

## 6. ViewSet

```python
# views.py
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response

class ExportViewSet(viewsets.ReadOnlyModelViewSet):
    """
    GET /api/v1/exports/{id}/ - –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –µ–∫—Å–ø–æ—Ä—Ç—É
    """
    queryset = ExportRequest.objects.all()
    serializer_class = ExportRequestSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        return self.queryset.filter(user=self.request.user)


class SoloSessionViewSet(viewsets.ModelViewSet):
    # ... existing code ...
    
    @action(detail=True, methods=['post'])
    def export(self, request, pk=None):
        """
        POST /api/v1/solo/sessions/{id}/export/
        """
        session = self.get_object()
        format = request.data.get('format', 'png')
        
        if format not in ['png', 'pdf', 'json']:
            return Response(
                {'error': 'Invalid format'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        export = ExportRequest.objects.create(
            session=session,
            user=request.user,
            format=format,
            status='pending'
        )
        
        # Trigger async task
        process_export.delay(str(export.id))
        
        return Response(
            ExportRequestSerializer(export).data,
            status=status.HTTP_201_CREATED
        )
```

---

## 7. URL Configuration

```python
# urls.py
from rest_framework.routers import DefaultRouter

router = DefaultRouter()
router.register(r'exports', ExportViewSet, basename='export')
router.register(r'solo/sessions', SoloSessionViewSet, basename='solo-session')

urlpatterns = [
    path('api/v1/', include(router.urls)),
]
```

---

## 8. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 8.1 Unit Tests

```python
def test_create_export_request():
    response = client.post(
        f'/api/v1/solo/sessions/{session.id}/export/',
        {'format': 'pdf'},
        format='json'
    )
    assert response.status_code == 201
    assert response.data['status'] == 'pending'

def test_get_export_status():
    export = ExportRequest.objects.create(...)
    response = client.get(f'/api/v1/exports/{export.id}/')
    assert response.status_code == 200
    assert 'status' in response.data

def test_export_not_found():
    response = client.get('/api/v1/exports/nonexistent-uuid/')
    assert response.status_code == 404
```

---

## 9. Frontend Integration

Frontend –≤–∂–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ `ExportMenu.vue`:

```typescript
// 1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç
const request = await soloApi.requestExport(sessionId, 'pdf')

// 2. Polling —Å—Ç–∞—Ç—É—Å—É (–∫–æ–∂–Ω—ñ 1.5—Å)
const status = await soloApi.getExportStatus(request.id)

// 3. –ö–æ–ª–∏ status === 'completed', –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
if (status.file_url) {
  downloadFile(status.file_url)
}
```

---

## 10. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π)

–Ø–∫—â–æ Celery –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –º–æ–∂–Ω–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –µ–∫—Å–ø–æ—Ä—Ç:

```python
@action(detail=True, methods=['post'])
def export(self, request, pk=None):
    session = self.get_object()
    format = request.data.get('format', 'png')
    
    # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –µ–∫—Å–ø–æ—Ä—Ç (–±–ª–æ–∫—É—î –∑–∞–ø–∏—Ç)
    if format == 'json':
        # JSON –º–æ–∂–Ω–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –æ–¥—Ä–∞–∑—É
        return Response({
            'status': 'completed',
            'file_url': None,
            'data': session.state  # Inline JSON
        })
    
    # –î–ª—è PNG/PDF ‚Äî –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —ñ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ URL
    file_url = generate_export(session, format)
    
    return Response({
        'status': 'completed',
        'file_url': file_url
    })
```

---

## 11. –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏

| –ó–∞–≤–¥–∞–Ω–Ω—è | –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç | –û—Ü—ñ–Ω–∫–∞ |
|----------|-----------|--------|
| `GET /api/v1/exports/{id}/` endpoint | üî¥ High | 1-2h |
| ExportRequest model + migration | üî¥ High | 1h |
| JSON export (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π) | üü° Medium | 1h |
| PNG export (server-side) | üü° Medium | 2-4h |
| PDF export (multi-page) | üü¢ Low | 4-8h |
| Celery integration | üü¢ Low | 2-4h |

---

## 12. –ö–æ–Ω—Ç–∞–∫—Ç–∏

–ü—Ä–∏ –ø–∏—Ç–∞–Ω–Ω—è—Ö –∑–≤–µ—Ä—Ç–∞—Ç–∏—Å—è –¥–æ Frontend Team.

**–§–∞–π–ª–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—É:**
- `frontend/src/modules/classroom/components/board/ExportMenu.vue`
- `frontend/src/modules/solo/api/soloApi.ts`
- `frontend/src/modules/solo/types/solo.ts`
