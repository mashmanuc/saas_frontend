# –ü–æ–≤–Ω–∏–π –∞—É–¥–∏—Ç Konva Board v0.28

> **–î–∞—Ç–∞:** 2025-12-13  
> **–°—Ç–∞—Ç—É—Å:** In Progress  
> **–ê–≤—Ç–æ—Ä:** Frontend Team

---

## üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

### 1. –°—Ç–æ—Ä—ñ–Ω–∫–∏ (Pages) –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏, strokes –∑ –ø–µ—Ä—à–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É.

**–ü—Ä–∏—á–∏–Ω–∞:** `boardStore` –∑–±–µ—Ä—ñ–≥–∞—î `strokes` –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ, –∞ –Ω–µ –≤ `pages[].strokes`. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö:

```typescript
// –ü–æ—Ç–æ—á–Ω–∞ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞):
{
  strokes: [...],  // –ì–ª–æ–±–∞–ª—å–Ω—ñ strokes
  pages: [{ id: 'page-1', name: 'Page 1', strokes: [], assets: [] }],
  currentPageIndex: 0
}

// –ü—Ä–∞–≤–∏–ª—å–Ω–∞:
{
  pages: [
    { id: 'page-1', name: 'Page 1', strokes: [...], assets: [...] },
    { id: 'page-2', name: 'Page 2', strokes: [], assets: [] }
  ],
  currentPageIndex: 0
}
```

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ `strokes` —ñ `assets` –≤—Å–µ—Ä–µ–¥–∏–Ω—É `pages[currentPageIndex]`
2. –û–Ω–æ–≤–∏—Ç–∏ `addStroke()` —â–æ–± –¥–æ–¥–∞–≤–∞—Ç–∏ –≤ –ø–æ—Ç–æ—á–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
3. –û–Ω–æ–≤–∏—Ç–∏ `serializedState` getter

**–§–∞–π–ª–∏ –¥–ª—è –∑–º—ñ–Ω–∏:**
- `src/modules/classroom/board/state/boardStore.ts`

---

### 2. –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Select –Ω–µ –ø—Ä–∞—Ü—é—î –¥–ª—è strokes

**–°–∏–º–ø—Ç–æ–º:** –°—Ç—Ä—ñ–ª–∫–∞ (select tool) –ø–µ—Ä–µ–º—ñ—â—É—î —Ç—ñ–ª—å–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (assets), –∞–ª–µ –Ω–µ strokes.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `BoardCanvas.vue` strokes —Ä–µ–Ω–¥–µ—Ä—è—Ç—å—Å—è —è–∫ `v-path` –±–µ–∑ `draggable` —ñ –±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ Transformer.

**–ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–¥:**
```vue
<v-path
  v-if="stroke.tool === 'pen' || stroke.tool === 'highlighter'"
  :config="getStrokeConfig(stroke)"
/>
```

**–†—ñ—à–µ–Ω–Ω—è:**
1. –î–æ–¥–∞—Ç–∏ `name` —ñ `id` –¥–æ –∫–æ–∂–Ω–æ–≥–æ stroke –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
2. –î–æ–¥–∞—Ç–∏ `draggable` –∫–æ–ª–∏ tool === 'select'
3. –ü—Ä–∏–≤'—è–∑–∞—Ç–∏ Transformer –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö strokes
4. –û–±—Ä–æ–±–ª—è—Ç–∏ `@click` –¥–ª—è –≤–∏–±–æ—Ä—É stroke
5. –ï–º—ñ—Ç–∏—Ç–∏ `stroke-update` –ø—Ä–∏ drag/transform

**–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
```vue
<v-path
  v-if="stroke.tool === 'pen' || stroke.tool === 'highlighter'"
  :config="getStrokeConfig(stroke)"
  :name="`stroke-${stroke.id}`"
  :draggable="currentTool === 'select'"
  @click="handleStrokeClick(stroke)"
  @dragend="handleStrokeDragEnd(stroke, $event)"
/>
```

**–§–∞–π–ª–∏ –¥–ª—è –∑–º—ñ–Ω–∏:**
- `src/modules/classroom/components/board/BoardCanvas.vue`

---

### 3. –ú–æ—Ä–≥–∞–Ω–Ω—è –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ

**–°–∏–º–ø—Ç–æ–º:** Canvas –º–æ—Ä–≥–∞—î –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É autosave.

**–ü—Ä–∏—á–∏–Ω–∞:** 
1. `serializedState` getter —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –≤–∏–∫–ª–∏–∫—É
2. Vue reactivity –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î –≤–µ—Å—å canvas
3. –ó–∞–Ω–∞–¥—Ç–æ —á–∞—Å—Ç—ñ –≤–∏–∫–ª–∏–∫–∏ `markDirty()`

**–†—ñ—à–µ–Ω–Ω—è:**
1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `shallowRef` –¥–ª—è strokes/assets
2. –ú–µ–º–æ—ñ–∑—É–≤–∞—Ç–∏ `serializedState` 
3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `key` –Ω–∞ v-path —â–æ–± Vue –Ω–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–≤ —ñ—Å–Ω—É—é—á—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
4. Debounce state changes

**–§–∞–π–ª–∏ –¥–ª—è –∑–º—ñ–Ω–∏:**
- `src/modules/classroom/board/state/boardStore.ts`
- `src/modules/classroom/components/board/BoardDock.vue`

---

## üü° –°–µ—Ä–µ–¥–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

### 4. Undo/Redo –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –¥–ª—è strokes

**–°–∏–º–ø—Ç–æ–º:** Undo –Ω–µ –≤—ñ–¥–º—ñ–Ω—è—î –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–æ–∫, –∑–º—ñ–Ω—É —Å—Ç–æ—Ä—ñ–Ω–æ–∫, —Ç–æ—â–æ.

**–ü—Ä–∏—á–∏–Ω–∞:** `undoStack` –∑–±–µ—Ä—ñ–≥–∞—î —Ç—ñ–ª—å–∫–∏ `strokes`, –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ `assets` —ñ `pages`.

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –ø–æ–≤–Ω–∏–π snapshot —Å—Ç–∞–Ω—É: `{ strokes, assets, currentPageIndex }`
2. –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Command Pattern –¥–ª—è –∫–æ–∂–Ω–æ—ó –¥—ñ—ó

---

### 5. WebSocket disconnected –ø–æ–º–∏–ª–∫–∏

**–°–∏–º–ø—Ç–æ–º:** –í –∫–æ–Ω—Å–æ–ª—ñ –±–∞–≥–∞—Ç–æ –ø–æ–º–∏–ª–æ–∫ `[realtime] disconnected`.

**–ü—Ä–∏—á–∏–Ω–∞:** Realtime sync –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è, –∞–ª–µ endpoint –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è solo mode.

**–†—ñ—à–µ–Ω–Ω—è:**
1. –í–∏–º–∫–Ω—É—Ç–∏ realtime sync –¥–ª—è solo sessions
2. –ê–±–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ fallback –Ω–∞ HTTP polling

---

### 6. Eraser –Ω–µ –ø—Ä–∞—Ü—é—î –¥–ª—è shapes

**–°–∏–º–ø—Ç–æ–º:** Eraser –≤–∏–¥–∞–ª—è—î —Ç—ñ–ª—å–∫–∏ pen/highlighter strokes, –Ω–µ shapes.

**–ü—Ä–∏—á–∏–Ω–∞:** `handleErase` –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç—ñ–ª—å–∫–∏ proximity –¥–æ points, –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ bounding box shapes.

**–†—ñ—à–µ–Ω–Ω—è:**
1. –î–ª—è rectangle/line –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ intersection –∑ bounding box
2. –î–æ–¥–∞—Ç–∏ hit detection –¥–ª—è –≤—Å—ñ—Ö —Ç–∏–ø—ñ–≤ strokes

---

### 7. Text tool –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–∑–∏—Ü—ñ—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–°–∏–º–ø—Ç–æ–º:** –¢–µ–∫—Å—Ç —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è, –∞–ª–µ –ø–æ–∑–∏—Ü—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –ø—Ä–∏ zoom.

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—é—Ç—å zoom –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ.

**–†—ñ—à–µ–Ω–Ω—è:**
1. –î—ñ–ª–∏—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–∞ zoom –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ–∫—Å—Ç—É
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `getPointerPosition()` —Ñ—É–Ω–∫—Ü—ñ—é

---

## üü¢ –ù–∏–∑—å–∫—ñ –ø—Ä–æ–±–ª–µ–º–∏

### 8. Zoom controls –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ

**–°–∏–º–ø—Ç–æ–º:** Zoom –≤ BoardDock –ª–æ–∫–∞–ª—å–Ω–∏–π, –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ boardStore.

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ zoom —á–µ—Ä–µ–∑ props —ñ emit events.

---

### 9. Highlighter opacity –Ω–µ –ø—Ä–∞—Ü—é—î

**–°–∏–º–ø—Ç–æ–º:** Highlighter –≤–∏–≥–ª—è–¥–∞—î —è–∫ –∑–≤–∏—á–∞–π–Ω–∏–π pen.

**–ü—Ä–∏—á–∏–Ω–∞:** `globalCompositeOperation: 'multiply'` –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ v-path.

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `opacity` –∑–∞–º—ñ—Å—Ç—å `globalCompositeOperation`.

---

### 10. –ù–µ–º–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ touch events –Ω–∞ mobile

**–°–∏–º–ø—Ç–æ–º:** –ù–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö –º–∞–ª—é–≤–∞–Ω–Ω—è –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ touch event handlers, –¥–æ–¥–∞—Ç–∏ touch-action CSS.

---

## üìã –ü–ª–∞–Ω –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ñ (—Å—å–æ–≥–æ–¥–Ω—ñ)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü—ñ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|---|----------|--------|--------|
| 1 | Pages structure | 2h | ‚è≥ Pending |
| 2 | Select tool for strokes | 3h | ‚è≥ Pending |
| 3 | –ú–æ—Ä–≥–∞–Ω–Ω—è | 1h | ‚è≥ Pending |

### –§–∞–∑–∞ 2: –°–µ—Ä–µ–¥–Ω—ñ (–Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü—ñ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|---|----------|--------|--------|
| 4 | Undo/Redo –ø–æ–≤–Ω–∏–π | 2h | ‚è≥ Pending |
| 5 | WebSocket errors | 1h | ‚è≥ Pending |
| 6 | Eraser –¥–ª—è shapes | 1h | ‚è≥ Pending |
| 7 | Text position | 30m | ‚è≥ Pending |

### –§–∞–∑–∞ 3: –ù–∏–∑—å–∫—ñ (–ø—ñ–∑–Ω—ñ—à–µ)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü—ñ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|---|----------|--------|--------|
| 8 | Zoom sync | 30m | ‚è≥ Pending |
| 9 | Highlighter | 30m | ‚è≥ Pending |
| 10 | Mobile touch | 1h | ‚è≥ Pending |

---

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ boardStore

```typescript
interface BoardState {
  // Session
  sessionId: string | null
  sessionName: string
  ownerId: string | null

  // Pages - –∫–æ–∂–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –º–∞—î —Å–≤–æ—ó strokes —ñ assets
  pages: Page[]
  currentPageIndex: number

  // UI state
  currentTool: ToolType
  currentColor: string
  currentSize: number
  zoom: number

  // Sync
  syncStatus: SyncStatus
  isDirty: boolean

  // History - –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤–Ω–∏–π snapshot
  undoStack: PageSnapshot[]
  redoStack: PageSnapshot[]
}

interface Page {
  id: string
  name: string
  strokes: Stroke[]
  assets: Asset[]
}

interface PageSnapshot {
  pages: Page[]
  currentPageIndex: number
}
```

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Stroke

```typescript
interface Stroke {
  id: string
  tool: 'pen' | 'highlighter' | 'line' | 'rectangle' | 'text' | 'eraser'
  color: string
  size: number
  opacity: number
  points: Point[]
  
  // –î–ª—è shapes
  width?: number
  height?: number
  
  // –î–ª—è text
  text?: string
  fontSize?: number
  
  // –î–ª—è selection/transform
  x?: number  // offset –≤—ñ–¥ –ø–æ—á–∞—Ç–∫–æ–≤–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
  y?: number
  rotation?: number
  scaleX?: number
  scaleY?: number
}
```

### Konva Transformer –¥–ª—è strokes

```typescript
// –í BoardCanvas.vue
const selectedStrokeIds = ref<string[]>([])

function handleStrokeClick(stroke: Stroke, e: Konva.KonvaEventObject) {
  if (currentTool.value !== 'select') return
  
  const metaPressed = e.evt.shiftKey || e.evt.ctrlKey
  
  if (metaPressed) {
    // Toggle selection
    if (selectedStrokeIds.value.includes(stroke.id)) {
      selectedStrokeIds.value = selectedStrokeIds.value.filter(id => id !== stroke.id)
    } else {
      selectedStrokeIds.value = [...selectedStrokeIds.value, stroke.id]
    }
  } else {
    // Single selection
    selectedStrokeIds.value = [stroke.id]
  }
  
  updateTransformer()
}

function updateTransformer() {
  const transformer = transformerRef.value?.getNode()
  if (!transformer) return
  
  const stage = stageRef.value?.getStage()
  if (!stage) return
  
  const nodes = selectedStrokeIds.value
    .map(id => stage.findOne(`#stroke-${id}`))
    .filter(Boolean)
  
  transformer.nodes(nodes)
}
```

---

## üìö –†–µ—Ñ–µ—Ä–µ–Ω—Å–∏

- [Konva Transformer Basic Demo](https://konvajs.org/docs/select_and_transform/Basic_demo.html)
- [Konva Transformer Styling](https://konvajs.org/docs/select_and_transform/Transformer_Styling.html)
- [perfect-freehand library](https://github.com/steveruizok/perfect-freehand)
- [tldraw architecture](https://github.com/tldraw/tldraw) - —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –¥–ª—è whiteboard

---

## ‚úÖ –í–∏–∫–æ–Ω–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

| –î–∞—Ç–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –†—ñ—à–µ–Ω–Ω—è |
|------|----------|---------|
| 2025-12-13 | Strokes –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–ª–∏—Å—å | –ó–∞–º—ñ–Ω–∏–≤ v-line –Ω–∞ v-path –¥–ª—è SVG path data |
| 2025-12-13 | Tool –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–≤—Å—è | –î–æ–¥–∞–≤ props tool/color/size –≤ BoardDock |
| 2025-12-13 | –ó–∞–π–≤—ñ –ª–æ–≥–∏ | –í–∏–¥–∞–ª–∏–≤ console.log —ñ deep watch |
| 2025-12-13 | Pages structure | –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ strokes/assets –≤ pages[], –¥–æ–¥–∞–Ω–æ addPage/goToPage/deletePage |
| 2025-12-13 | Select tool –¥–ª—è strokes | –î–æ–¥–∞–Ω–æ draggable, click/dragend handlers, updateStroke/deleteStroke |
| 2025-12-13 | Legacy data migration | hydrateFromSession –ø—ñ–¥—Ç—Ä–∏–º—É—î –æ–±–∏–¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∏ |

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. ‚úÖ ~~**–í–∏–ø—Ä–∞–≤–∏—Ç–∏ Pages structure** ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ strokes –≤ pages[]~~
2. ‚úÖ ~~**–î–æ–¥–∞—Ç–∏ selection –¥–ª—è strokes** ‚Äî draggable + transformer~~
3. **–û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥** ‚Äî shallowRef, memoization
4. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ
