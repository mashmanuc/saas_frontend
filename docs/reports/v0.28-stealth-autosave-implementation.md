# F29-STEALTH: Stealth Autosave Implementation Report

**–î–∞—Ç–∞:** 2025-12-16  
**–í–µ—Ä—Å—ñ—è:** v0.28  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

---

## üìã –û–≥–ª—è–¥

–ü–æ–≤–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è stealth autosave pipeline –¥–ª—è —É—Å—É–Ω–µ–Ω–Ω—è –±–ª–∏–º–∞–Ω–Ω—è (flicker) –Ω–∞ Konva board –ø—ñ–¥ —á–∞—Å –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–ò–ô –§–Ü–ö–° (–ì—ñ–ø–µ—Ä-–∞—É–¥–∏—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞:** `SoloRoom.vue` –ø–µ—Ä–µ–¥–∞–≤–∞–≤ `:board-state="boardStore.serializedState"` –∑–∞–º—ñ—Å—Ç—å –ø—Ä—è–º–∏—Ö —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ñ–≤.  
`serializedState` ‚Äî —Ü–µ –≥–µ—Ç—Ç–µ—Ä, —è–∫–∏–π **—â–æ—Ä–∞–∑—É —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç**, –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ –¥–∞–Ω—ñ –Ω–µ –∑–º—ñ–Ω–∏–ª–∏—Å—å.  
Vue –≤–≤–∞–∂–∞—î, —â–æ –ø—Ä–æ–ø –∑–º—ñ–Ω–∏–≤—Å—è ‚Üí –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—é—î BoardDock ‚Üí Konva –æ—Ç—Ä–∏–º—É—î –Ω–æ–≤—ñ strokes ‚Üí **—Ñ–ª—ñ–∫–µ—Ä**.

**–†—ñ—à–µ–Ω–Ω—è:**
```vue
<!-- –ë–£–õ–û (SoloRoom.vue) -->
<BoardDock
  :board-state="boardStore.serializedState"
  @state-change="handleStateChange"
/>

<!-- –°–¢–ê–õ–û -->
<BoardDock
  :strokes="boardStore.currentStrokes"
  :assets="boardStore.currentAssets"
  :tool="boardStore.currentTool"
  :color="boardStore.currentColor"
  :size="boardStore.currentSize"
  @event="handleBoardEvent"
/>
```

**–í–∏–¥–∞–ª–µ–Ω–æ:**
- `lastStateSignature` ref (SoloRoom.vue, SoloWorkspace.vue)
- `handleStateChange` —Ñ—É–Ω–∫—Ü—ñ—è (SoloRoom.vue, SoloWorkspace.vue)
- `@state-change` event listener (SoloWorkspace.vue)

---

## ‚úÖ –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. Save Window Metrics (`saveWindowMetrics.ts`)
- `startSaveWindow(sessionId, rev)` ‚Äî –ø–æ—á–∞—Ç–æ–∫ –≤—ñ–∫–Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
- `endSaveWindow(result)` ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (success/queued/error)
- `recordExtraDraw()` ‚Äî –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∑–∞–π–≤–∏—Ö draw-–≤–∏–∫–ª–∏–∫—ñ–≤
- `recordOverlayCopy(ms)` ‚Äî —á–∞—Å –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è snapshot
- `recordSaveRtt(ms)` ‚Äî RTT –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
- `recordPointerEvent(ts)` ‚Äî timestamp pointer events –¥–ª—è input latency
- `recordRafFlush()` ‚Äî timestamp rAF flush

### 2. Render Guards (`guards.ts`)
- `startRenderGuard(stage)` ‚Äî –±–ª–æ–∫—É—î `draw()`/`batchDraw()` –Ω–∞ stage + –≤—Å—ñ—Ö layers
- `stopRenderGuard(stage)` ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –º–µ—Ç–æ–¥–∏
- –ö–æ–∂–µ–Ω –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π –≤–∏–∫–ª–∏–∫ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î `extraDrawsDuringSave` —Ç–∞ –≤–∏–∫–ª–∏–∫–∞—î `recordExtraDraw()`
- –í–∏–º–∏–∫–∞—î `listening(false)` –Ω–∞ –≤—Å—ñ—Ö layers –ø—ñ–¥ —á–∞—Å save window

### 3. Snapshot Overlay (`snapshotOverlay.ts`)
- `initSnapshotOverlay(container)` ‚Äî —Å—Ç–≤–æ—Ä—é—î canvas overlay
- `showSnapshotOverlay(stage)` ‚Äî —Ä–æ–±–∏—Ç—å snapshot —Ç–∞ –ø–æ–∫–∞–∑—É—î overlay
- `hideSnapshotOverlay(fadeMs)` ‚Äî —Ö–æ–≤–∞—î –∑ fade –∞–Ω—ñ–º–∞—Ü—ñ—î—é
- CSS: `position:absolute; inset:0; pointer-events:none; contain:content; isolation:isolate; z-index:2; will-change:opacity`

### 4. BoardStore Integration (`boardStore.ts`)
```typescript
async autosave(): Promise<void> {
  // 1. Start save window BEFORE any network/serialization
  startSaveWindow(sessionId, rev)
  
  // 2. Activate render guard to block draw() calls
  startRenderGuard(stage)
  
  // 3. Show snapshot overlay to freeze visual state
  const overlayCopyMs = await showSnapshotOverlay(stage)
  recordOverlayCopy(overlayCopyMs)
  
  try {
    // 4. Perform save (updateSession/createSession)
    await this.updateSession()
    recordSaveRtt(rttMs)
  } finally {
    // 5. End save window and cleanup
    endSaveWindow(saveResult)
    stopRenderGuard(stage)
    hideSnapshotOverlay(100)
  }
}
```

### 5. BoardCanvas Integration (`BoardCanvas.vue`)
- `onMounted`: –≤–∏–∫–ª–∏–∫–∞—î `setStageRef(stage)` —Ç–∞ `initSnapshotOverlay(container)`
- `onUnmounted`: –≤–∏–∫–ª–∏–∫–∞—î `setStageRef(null)` —Ç–∞ `destroySnapshotOverlay()`
- `handleMouseDown/Move`: –≤–∏–∫–ª–∏–∫–∞—î `recordPointerEvent(performance.now())`
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–∞—î `position: relative` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è overlay

### 6. CloudStatus Quiet Mode
- `SoloWorkspace.vue` —Ç–∞ `SoloRoom.vue`: `<CloudStatus :quiet="true" :pending-count="syncStore.pendingCount" />`
- –¢—ñ–ª—å–∫–∏ opacity transitions, –±–µ–∑ layout –∑–º—ñ–Ω –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É

### 7. RenderQueue Integration (`renderQueue.ts`)
- –í–∏–∫–ª–∏–∫–∞—î `recordRafFlush()` –Ω–∞ –ø–æ—á–∞—Ç–∫—É –∫–æ–∂–Ω–æ–≥–æ rAF callback

### 8. PerfHUD Extended (`PerfHUD.vue`)
–ù–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏:
- **ExtraDraws** ‚Äî –∑–∞–π–≤—ñ draw() –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É (–º–∞—î –±—É—Ç–∏ 0)
- **SaveBlock** ‚Äî max main thread block –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É (—Ü—ñ–ª—å ‚â§8ms)
- **InputLat** ‚Äî input latency –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É (—Ü—ñ–ª—å <16ms)
- **Overlay** ‚Äî —á–∞—Å –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è snapshot (—Ü—ñ–ª—å <3ms)
- **SaveRTT** ‚Äî RTT –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è

---

## üìÅ –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏

| –§–∞–π–ª | –ó–º—ñ–Ω–∏ |
|------|-------|
| `boardStore.ts` | –Ü–º–ø–æ—Ä—Ç–∏ stealth –º–æ–¥—É–ª—ñ–≤, —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è save window/guard/overlay –≤ autosave() |
| `guards.ts` | –î–æ–¥–∞–Ω–æ recordExtraDraw(), –±–ª–æ–∫—É–≤–∞–Ω–Ω—è draw –Ω–∞ –≤—Å—ñ—Ö layers |
| `snapshotOverlay.ts` | –û–Ω–æ–≤–ª–µ–Ω–æ CSS (inset:0, isolation:isolate, z-index:2) |
| `renderQueue.ts` | –î–æ–¥–∞–Ω–æ recordRafFlush() |
| `BoardCanvas.vue` | –Ü–º–ø–æ—Ä—Ç–∏, setStageRef, initSnapshotOverlay, recordPointerEvent |
| `SoloWorkspace.vue` | –í–∏–¥–∞–ª–µ–Ω–æ @state-change, handleStateChange, lastStateSignature; CloudStatus quiet=true |
| `SoloRoom.vue` | **–ö–†–ò–¢–ò–ß–ù–ò–ô:** –ó–∞–º—ñ–Ω–µ–Ω–æ board-state –Ω–∞ strokes/assets/tool/color/size; –≤–∏–¥–∞–ª–µ–Ω–æ handleStateChange/lastStateSignature; CloudStatus quiet=true |
| `PerfHUD.vue` | –ù–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏ save window |
| `saveWindowMetrics.ts` | –ù–æ–≤–∏–π –º–æ–¥—É–ª—å –¥–ª—è –∑–±–æ—Ä—É –º–µ—Ç—Ä–∏–∫ |

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

- **Build:** ‚úÖ –£—Å–ø—ñ—à–Ω–æ (1950 modules)
- **Tests:** ‚úÖ 702/702 passed

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏ (Definition of Done)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ü–æ—Ä—ñ–≥ | –û–ø–∏—Å |
|---------|-------|------|
| `extraDrawsDuringSave` | = 0 | –ñ–æ–¥–Ω–∏—Ö –∑–∞–π–≤–∏—Ö draw –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É |
| `mainThreadBlockMsDuringSave` | ‚â§ 8ms | Max –±–ª–æ–∫—É–≤–∞–Ω–Ω—è main thread |
| `inputLatencyMsDuringSave` | < 16ms (mouse) / < 10ms (pen) | Input latency |
| `overlayCopyMs` | < 3ms | –ß–∞—Å –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è snapshot |
| `fpsDuringSave` | ‚â• 55 | FPS –Ω–µ –ø–∞–¥–∞—î –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É |

---

## üîß –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏

1. –í—ñ–¥–∫—Ä–∏—Ç–∏ Solo Workspace
2. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ `Ctrl+Alt+P` –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è PerfHUD
3. –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —à—Ç—Ä–∏—Ö—ñ–≤
4. –î–æ—á–µ–∫–∞—Ç–∏—Å—è autosave (3 —Å–µ–∫)
5. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤ PerfHUD:
   - `ExtraDraws = 0`
   - `SaveBlock ‚â§ 8ms`
   - `Overlay < 3ms`
6. –í—ñ–∑—É–∞–ª—å–Ω–æ: –∂–æ–¥–Ω–æ–≥–æ –±–ª–∏–º–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É

---

## ‚ö†Ô∏è –í—ñ–¥–æ–º—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è

1. **PerfHUD —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è:** –õ—ñ–Ω—Ç –ø–æ–º–∏–ª–∫–∞ –∑ —Ç–∏–ø–æ–º `stageRef` prop ‚Äî –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å
2. **Chunk size warning:** index.js > 500KB ‚Äî –ø–æ—Ç—Ä–µ–±—É—î code-splitting (–æ–∫—Ä–µ–º–∞ –∑–∞–¥–∞—á–∞)

---

## üìù –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. –†—É—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ –∑ PerfHUD
2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ Chrome DevTools Performance tab (0 Layout/Recalc –ø—ñ–¥ —á–∞—Å —Å–µ–π–≤—É)
3. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è offline —Ä–µ–∂–∏–º—É
4. –ó–∞–ø—É—Å–∫ bench-—Å–∫—Ä–∏–ø—Ç–∞ (`npm run board:bench`)
