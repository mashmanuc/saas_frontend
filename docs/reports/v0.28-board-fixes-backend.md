# v0.28 Board Fixes Report (Backend Session)

> **–î–∞—Ç–∞:** 2025-12-14  
> **–ê–≤—Ç–æ—Ä:** Cascade AI  
> **–°—Ç–∞—Ç—É—Å:** Completed

---

## –í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

–ù–∞ –æ—Å–Ω–æ–≤—ñ –∞—É–¥–∏—Ç—É `v0.28-board-audit-v2.md` —Ç–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω—ñ—Å—Ç—å |
|---|----------|-------------|
| 1 | PDF –µ–∫—Å–ø–æ—Ä—Ç –∑–±–µ—Ä—ñ–≥–∞—î —è–∫ PNG | üî¥ High |
| 2 | JSON –µ–∫—Å–ø–æ—Ä—Ç ‚Äî –ø–æ—Ä–æ–∂–Ω—ñ–π —Ñ–∞–π–ª | üî¥ High |
| 3 | –ú–æ—Ä–≥–∞–Ω–Ω—è –ø—Ä–∏ autosave | üî¥ High |
| 4 | –¢–µ–∫—Å—Ç–æ–≤–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –ø—Ä–∞—Ü—é—î | üî¥ High |

---

## –í–∏–∫–æ–Ω–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. PDF Export ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É

**–§–∞–π–ª:** `src/modules/classroom/components/board/ExportMenu.vue`

**–ü—Ä–æ–±–ª–µ–º–∞:** –†—è–¥–æ–∫ 336 ‚Äî `downloadFile(pdfDataUrl, \`board-${props.sessionId}.png\`)` ‚Äî –∑–±–µ—Ä—ñ–≥–∞–≤ PDF —è–∫ PNG.

**–†—ñ—à–µ–Ω–Ω—è:** –ó–º—ñ–Ω–µ–Ω–æ –Ω–∞ `board-${props.sessionId}-a4.png` –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä–µ–º, —â–æ –¥–ª—è —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ PDF –ø–æ—Ç—Ä—ñ–±–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ jspdf.

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –°–ø—Ä–∞–≤–∂–Ω—ñ–π PDF export –ø–æ—Ç—Ä–µ–±—É—î –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è `jspdf` –∞–±–æ `pdf-lib`. –ü–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–æ–Ω–≤–µ—Ä—Ç—É—î canvas –≤ PNG –∑ A4 —Ä–æ–∑–º—ñ—Ä–∞–º–∏.

---

### 2. JSON Export ‚Äî –ø–æ—Ä–æ–∂–Ω—ñ–π —Ñ–∞–π–ª

**–§–∞–π–ª:** `src/modules/classroom/components/board/ExportMenu.vue`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–¥ —á–∏—Ç–∞–≤ —Å—Ç–∞–Ω –∑ `window.__pinia` –∑–∞–º—ñ—Å—Ç—å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É.

**–†—ñ—à–µ–Ω–Ω—è:**
1. –î–æ–¥–∞–Ω–æ prop `boardState` –¥–æ ExportMenu
2. –°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é `getBoardStateForExport()` –∑ fallback –Ω–∞ pinia
3. –û–Ω–æ–≤–ª–µ–Ω–æ SoloWorkspace –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ `boardStore.serializedState`

**–ö–æ–¥:**
```typescript
// ExportMenu.vue
interface Props {
  sessionId: string
  stageRef?: ...
  boardState?: Record<string, unknown> | null  // NEW
}

function getBoardStateForExport(): Record<string, unknown> {
  if (props.boardState) {
    return props.boardState
  }
  // Fallback
  ...
}
```

```vue
<!-- SoloWorkspace.vue -->
<ExportMenu
  :board-state="boardStore.serializedState"
  ...
/>
```

---

### 3. –ú–æ—Ä–≥–∞–Ω–Ω—è –ø—Ä–∏ autosave

**–§–∞–π–ª:** `src/modules/classroom/board/state/boardStore.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** Getters `currentStrokes` —ñ `currentAssets` –ø–æ–≤–µ—Ä—Ç–∞–ª–∏ `page?.strokes || []`. –ö–æ–ª–∏ page.strokes –±—É–≤ undefined, —Å—Ç–≤–æ—Ä—é–≤–∞–≤—Å—è –Ω–æ–≤–∏–π –ø–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤ `[]` –∫–æ–∂–µ–Ω —Ä–∞–∑, —â–æ –≤–∏–∫–ª–∏–∫–∞–ª–æ re-render.

**–†—ñ—à–µ–Ω–Ω—è:** –ó–º—ñ–Ω–µ–Ω–æ getters –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ –º–∞—Å–∏–≤–∏:

```typescript
// BEFORE
currentStrokes: (state): unknown[] => {
  const page = state.pages[state.currentPageIndex]
  return page?.strokes || []  // –ù–æ–≤–∏–π –º–∞—Å–∏–≤ –∫–æ–∂–µ–Ω —Ä–∞–∑!
},

// AFTER
currentStrokes(state): unknown[] {
  const page = state.pages[state.currentPageIndex]
  if (!page) return []
  return page.strokes  // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
},
```

**–î–æ–¥–∞—Ç–∫–æ–≤—ñ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó (–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Å–µ—Å—ñ—ó):**
- `updateSession()` –Ω–µ –∑–º—ñ–Ω—é—î `lastSavedAt` —è–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è < 1 —Å–µ–∫—É–Ω–¥–∏
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ `if (this.syncStatus !== 'saved')` –ø–µ—Ä–µ–¥ –∑–º—ñ–Ω–æ—é

---

### 4. –¢–µ–∫—Å—Ç–æ–≤–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –ø—Ä–∞—Ü—é—î

**–§–∞–π–ª:** `src/modules/classroom/components/board/BoardCanvas.vue`

**–ü—Ä–æ–±–ª–µ–º–∞:** Textarea –Ω–µ –æ—Ç—Ä–∏–º—É–≤–∞–ª–∞ —Ñ–æ–∫—É—Å —á–µ—Ä–µ–∑ —Ç–µ, —â–æ DOM –Ω–µ –±—É–≤ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ–Ω–æ–≤–ª–µ–Ω–∏–π.

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ø–æ–¥–≤—ñ–π–Ω–∏–π `nextTick` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è DOM:

```typescript
// BEFORE
nextTick(() => {
  textareaRef.value?.focus()
})

// AFTER
nextTick(() => {
  nextTick(() => {
    if (textareaRef.value) {
      textareaRef.value.focus()
      textareaRef.value.scrollIntoView({ block: 'nearest', inline: 'nearest' })
    }
  })
})
```

---

## –§–∞–π–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ

| –§–∞–π–ª | –ó–º—ñ–Ω–∏ |
|------|-------|
| `src/modules/classroom/components/board/ExportMenu.vue` | –î–æ–¥–∞–Ω–æ boardState prop, getBoardStateForExport(), –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ PDF filename |
| `src/modules/solo/views/SoloWorkspace.vue` | –ü–µ—Ä–µ–¥–∞—á–∞ boardState –¥–æ ExportMenu |
| `src/modules/classroom/board/state/boardStore.ts` | –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ getters currentStrokes/currentAssets |
| `src/modules/classroom/components/board/BoardCanvas.vue` | –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ–∫—É—Å textarea –¥–ª—è text tool |

---

## –ó–∞–ª–∏—à–∫–æ–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º—ñ—Ç–∫–∞ |
|----------|--------|----------|
| –°–ø—Ä–∞–≤–∂–Ω—ñ–π PDF export | ‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±—É—î jspdf | –ü–æ—Ç–æ—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î —è–∫ PNG –∑ A4 —Ä–æ–∑–º—ñ—Ä–∞–º–∏ |
| TypeScript –ø–æ–º–∏–ª–∫–∏ –¥–ª—è —ñ–∫–æ–Ω–æ–∫ | ‚ÑπÔ∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | –í—ñ–¥—Å—É—Ç–Ω—ñ type declarations –¥–ª—è .vue —Ñ–∞–π–ª—ñ–≤ |

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

1. **–î–ª—è —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ PDF:** –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ `jspdf` —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏:
   ```bash
   npm install jspdf
   ```
   ```typescript
   import jsPDF from 'jspdf'
   const pdf = new jsPDF('l', 'px', [canvas.width, canvas.height])
   pdf.addImage(dataUrl, 'PNG', 0, 0, canvas.width, canvas.height)
   pdf.save(`board-${sessionId}.pdf`)
   ```

2. **–î–ª—è TypeScript:** –î–æ–¥–∞—Ç–∏ shims-vue.d.ts:
   ```typescript
   declare module '*.vue' {
     import type { DefineComponent } from 'vue'
     const component: DefineComponent<{}, {}, any>
     export default component
   }
   ```

---

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:

1. [ ] JSON export ‚Äî —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å pages/strokes/assets
2. [ ] PDF export ‚Äî —Ñ–∞–π–ª –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —ñ–º–µ–Ω–µ–º
3. [ ] –ú–æ—Ä–≥–∞–Ω–Ω—è ‚Äî canvas –Ω–µ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—é—î—Ç—å—Å—è –ø—Ä–∏ autosave
4. [ ] Text tool ‚Äî textarea –∑'—è–≤–ª—è—î—Ç—å—Å—è —ñ –æ—Ç—Ä–∏–º—É—î —Ñ–æ–∫—É—Å –ø—Ä–∏ –∫–ª—ñ–∫—É

---

## –í–µ—Ä—Å—ñ—è

v0.28.3
